<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hanqi Zeng">

<title>Pediatric Sleep Patterns Detection from Wrist Activity Using Random Forests</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="SleepPatternDetectionManuscript_files/libs/clipboard/clipboard.min.js"></script>
<script src="SleepPatternDetectionManuscript_files/libs/quarto-html/quarto.js"></script>
<script src="SleepPatternDetectionManuscript_files/libs/quarto-html/popper.min.js"></script>
<script src="SleepPatternDetectionManuscript_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="SleepPatternDetectionManuscript_files/libs/quarto-html/anchor.min.js"></script>
<link href="SleepPatternDetectionManuscript_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="SleepPatternDetectionManuscript_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="SleepPatternDetectionManuscript_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="SleepPatternDetectionManuscript_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="SleepPatternDetectionManuscript_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Pediatric Sleep Patterns Detection from Wrist Activity Using Random Forests</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Hanqi Zeng </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Harvard T.H. Chan Department of Biostatistics
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This research explores the development of a predictive model using wrist-worn accelerometer data to determine a person’s sleep state. Leveraging datasets from the <a href="https://healthybrainnetwork.org/">Healthy Brain Network</a>, this study will delve into the nuances of sleep onset and wake events, aiming to revolutionize the understanding of sleep in children.</p>
<p>A total of three data sets will be used in this project, namely <em>train_series.parquet</em>, <em>test_series.parquet</em>, and <em>train_events.csv</em>.</p>
<p>* The <em>Zzzs_train.parquet</em> dataset contains all series to be used as training data. One thing to note is that each series is a continuous recording of accelerometer data for a single subject spanning many days. This dataset has a total of 5 columns, and each column represents an attribute of that accelerometer series. These attributes include <code>series_id</code> - Unique identifier, <code>step</code> - An integer timestep for each observation within a series, <code>timestamp</code> - A corresponding datetime with ISO 8601 format <code>%Y-%m-%dT%H:%M:%S%z</code>, <code>anglez</code>, z-angle is a metric derived from individual accelerometer components that is commonly used in sleep detection, and refers to the angle of the arm relative to the vertical axis of the body, as well as <code>enmo</code>. ENMO is the Euclidean Norm Minus One of all accelerometer signals, with negative values rounded to zero. * The <em>test_series.parquet</em> dataset contains series to be used as the test data, containing the same fields as above. I will predict event occurrences for series in this file. * The <em>train_events.csv</em> file is a complemented dataset that logs specific sleep events such as sleep onset and wake times. This dataset is pivotal in understanding the transitional moments in sleep and serves as a key component in training and refining the predictive models. To be more specific, there are a total of 5 columns, and each column(except the first column, which is just a column of series_id of 12 digits combination of numbers and characters) represents an unique identifier for each series of accelerometer data in <em>Zzzs_train.parquet</em>. These attributes include basic statistics such as <code>night</code> - An enumeration of potential <code>onset</code> / <code>wakeup</code> event pairs. At most one pair of events can occur for each night, and <code>event</code> - The type of event, whether <code>onset</code> or <code>wakeup</code>, as well as <code>step</code> and <code>timestamp</code>, which is the recorded time of occurence of the event in the accelerometer series.</p>
<p>The sleep onset and wakeup timeline plot and the boxplot of sleep duration by day of week motivate the exploration into the sleep patterns. Therefore, central to this research is the question: <strong>How can we leverage a machine learning model, trained on wrist-worn accelerometer data, to effectively discern and predict individual sleep patterns and disturbances?</strong> Addressing this question can help interpret accelerometer data and have the potential to inform interventions and strategies in child psychology and sleep medicine, offering a new lens through which we can view and understand sleep.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="SleepPatternDetectionManuscript_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p><strong>Data Preparation &amp; Feature Engineering:</strong> The dataset was cleaned thoroughly, prepared for modeling, addressing missing values through deletion. Feature selection was based on the exploratory analysis towards the data distribution patterns, correlation analysis and also the domain knowledge that the wearables position and the sleep hour habits are influential factors to a person’s sleep patterns. Based on these, several key features were extracted from the accelerometer data, including <code>anglez</code> and <code>enmo</code> metrics, which are indicators of the wearer’s movement intensity and orientation, <code>step</code>, <code>event</code>, <code>hour</code> and <code>series_id</code>. These must be crucial factors to be included in the model. Besides, normalization/standardization of data was implemented after exploratory data analysis but before model training to ensure equal contribution of each feature, preventing bias towards variables with larger magnitudes.</p>
<p>From the explortary data analysis on the train_events dataset, the sleep onset and wakeup timeline plot shows as time advanced from late 2017 through to July 2019[Figure1], the observed sleeping patterns exhibit a notable degree of stability and consistency. Predominantly, the awakening time clusters around the 500-minute mark post-midnight, which translates to 8:20 AM. In contrast, the commencement of sleep predominantly spans from 1320 to 1440 minutes after midnight, stretching slightly into the early hours and encapsulating the timeframe from 10:00 PM to 0:30 AM. These findings are in harmonious alignment with conventional sleep schedules typically adhered to, reinforcing their validity within the context of established sleep norms. This detected sleep pattern motivate the model development.</p>
<p>There are some findings from data wrangling as well. Exploring weekly patterns in sleep duration by classifying the data according to each day of the week is also a worthwhile task. The boxplot[Figure2] revealed that sleep durations are generally similar across weekdays and weekends, with two notable exceptions. Saturday showed a marginally longer sleep duration compared to other days, while Thursday emerged as the day with the least amount of sleep. This observation aligns with common expectations, as Thursdays, being mid-week, often involve intensive workloads in anticipation of the weekend, potentially leading to reduced sleep. Conversely, Saturdays provide an opportunity for extended rest and recuperation, especially given the possibility of waking up later on Sunday mornings. However, sleep duration on Sundays does not significantly extend, likely due to the need to wake up early on Mondays. But there’s no much variation among days of week, we can dismiss the day of week factor in our model development.</p>
<p>The average sleep duration by hour of onset plot[AppendixB: Figure5] clearly illustrates a distinct trend: as the bedtime shifts to a later hour, there is a corresponding decrease in the total duration of sleep. This pattern suggests that later sleep onset times are often not compensated by equivalent delays in waking up, resulting in shorter overall sleep periods.</p>
<p>The density plot for sleep onset and wake-up times over time[AppendixB: Figure6] clearly reveals distinct peak periods for each. Wake-up times predominantly peak between 6 to 7 AM, whereas sleep onset times are more broadly distributed, ranging from 10 PM to an hour past midnight. This finding aligns with our previous plots depicting sleep onset and wake-up timelines.</p>
<p><strong>Model Choice:</strong> After researching many related literature, the study employs the Random Forest algorithm, selected for its robust performance in complex, high-dimensional classification tasks, and widely used in sleep detection tasks. This choice is preferable over alternatives like logistic regression or support vector machines due to the algorithm’s capability to handle non-linear relationships and provide insights into feature importance, which is crucial for the analysis. I started the codes from scratch in my own way, combing both R and Python tools, implemented a fine-tuned data model, and evaluated in details.</p>
<p><strong>Validation and Testing</strong>: The model was trained on the <code>train_series</code> dataset and validated using a subset of the data. The final model was then tested on the <code>test_series</code> dataset to predict sleep states. A confidence score metric quantifying the model’s certainty in its predictions about specific sleep-related events, such as the onset or cessation (wakeup) of sleep was derived from model’s probability predictions. It takes the highest probability from the set of probabilities predicted for each data point, reflecting the model’s most confident prediction.</p>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>The model achieves peak accuracy with a small number of predictors. This indicates that a few predictors may be highly informative and sufficient to capture the necessary pattern in the data for accurate predictions. As more predictors are added beyond the optimal point, accuracy declines, which can be indicative of overfitting. The model starts to learn the noise in the training data rather than the underlying pattern. In this case, using 3 predictors might be the optimal complexity for the model.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="SleepPatternDetectionManuscript_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>I started training the model with 100 trees and tuning the number of predictors to be sampled between 1 and 5 with 1 as the increment. It turned out that randomly sampling 3 predictors and predicting 335 trees maximized and stabilized the accuracy of model prediction, which is 0.983, and in this setting, the out-of-bag error rate is 0.0173.</p>
<p>The ROC curve for the model[AppendixB: Figure7] truly looks like a nearly perfect upper triangle, it suggests that the model has near-perfect classification accuracy. This might indicate some form of data leakage or overfitting. So I checked precision, recall, F1 score, and confusion matrices to see whether this might be an imbalanced dataset. However, the accuracy is at 98.34%, Kappa is 0.9669, both recall and specificity are above 98%, precision and negative predictive values are high, balanced accuracy indicating consistent performance, F1 score is at around 0.98. High performance across all these metrics does not suggest a pressing need for sampling methods to address class imbalance.</p>
<p>Lastly, I applied an evaluation metric for event detection in time series and video namely <a href="https://www.kaggle.com/code/metric/event-detection-ap/notebook">Event Detection Average Precision(EDAP)</a> to the testing set predictions, and got a high sore. Its IOU threshold with tolerance can be replaced. The timestamp error tolerance are custom defined, [12, 36, 60, 90, 120, 150, 180, 240, 300, 360] for onset and same for wakeup event. For each event × tolerance group, the Average Precision (AP) score is calculated, which is the area under the precision-recall curve generated by decreasing confidence score thresholds over the predictions. Multiple AP scores are first averaged over tolerance, then over event to produce a single overall score.</p>
<p>The feature importance plot[AppendixB: Figure8] shows the top3 most influential features were identified as <code>hour of the day</code>, <code>enmo</code>, and <code>anglez</code>, indicating the significance of movement intensity, orientation, and time in determining sleep states. The hour is most influential makes sense since the sleeping patterns are associated with the time hour for sure, and usually a rountine for many people.</p>
<p>The final submission file resembles the example in Appendix C, which is the results tested on a small dataset, where each series has its own onset and wakeup timepoints (indicated by ‘step’) along with a prediction confidence score. The sample results are also consistent with our knowledge, lower confidence score, more likely for a false report. For instance, the indicated potential onset events during noon and afternoon have pretty low confidence score. It is the fact that few people go to bed such early but may get up in the afternoon. One method to determine the confidence score is provided, in addition to this, filtering methods are also experimented in this project, which can be employed to detect only those events where the time gap between onset and wakeup exceeds a certain number of hours (e.g., 6 hours; this threshold can be adjusted based on needs), or by requiring that the confidence score for either onset or wakeup is above 60%. If these criteria are not met, it is likely that no event occurred within the 2.5-hour recording period of that series.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This study successfully demonstrates the potential of using accelerometer data in sleep state detection. Several methods and parameters desgined for the wearables settings are applied, such as the timestamp error tolerance, etc. The high accuracy, AUC scores, event average precision, and recall achieved by the Random Forest model highlight its effectiveness. An exploration into the GGIR package specially for accelerometer data is provided as well, but in this study, even I took methods to transform raw data parquet into csv, the GGIR has very strict requirements for data format. My implementation without using GGIR is more suitable for these datasets. However, a critical limitation of the current model, which employs a random forest algorithm, pertains to its treatment of data. The model operates under the premise that each data point, or timepoint, is an isolated event, devoid of temporal correlation with preceding or subsequent data points. This assumption is a significant departure from the inherently sequential and interdependent nature of sleep patterns. In the realm of sleep studies, where temporal sequences and the continuity of data play pivotal roles, this approach might oversimplify complex biological processes. Therefore, the model may not fully capture the nuanced dynamics of sleep transitions. To enhance the model’s predictive accuracy and clinical relevance, future research should focus on incorporating techniques that recognize and integrate the temporal correlations inherent in sleep patterns. Furthermore, future work could include the application of this model to a broader dataset and exploring other combination techniques (eg. RNN+LSTM) for potential accuracy enhancement. Throughout this research, privacy and data security standards were maintained, and strict adherence to ethical guidelines was ensured to prevent any data misuse, underscoring its sole use in enhancing pediatric healthcare research and practices.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ol type="1">
<li><p>Cole, R. J., Kripke, D. F., Gruen, W., Mullaney, D. J., &amp; Gillin, J. C. (1992). Automatic sleep/wake identification from wrist activity. Sleep, 15(5), 461–469. https://doi.org/10.1093/sleep/15.5.461</p></li>
<li><p>de Zambotti, M., Cellini, N., Goldstone, A., Colrain, I. M., &amp; Baker, F. C. (2019). Wearable Sleep Technology in Clinical and Research Settings. Medicine and science in sports and exercise, 51(7), 1538–1557. https://doi.org/10.1249/MSS.0000000000001947</p></li>
<li><p>Nathalia Esper, Maggie Demkin, Ryan Hoolbrok, Yuki Kotani, Larissa Hunt, Andrew Leroux, Vincent van Hees, Vadim Zipunnikov, Kathleen Merikangas, Michael Milham, Alexandre Franco, Gregory Kiar..(2023). Child Mind Institute - Detect Sleep States. Kaggle. https://kaggle.com/competitions/child-mind-institute-detect-sleep-states</p></li>
<li><p>Sundararajan, K., Georgievska, S., Te Lindert, B. H. W., Gehrman, P. R., Ramautar, J., Mazzotti, D. R., Sabia, S., Weedon, M. N., van Someren, E. J. W., Ridder, L., Wang, J., &amp; van Hees, V. T. (2021). Sleep classification from wrist-worn accelerometer data using random forests. Scientific reports, 11(1), 24. https://doi.org/10.1038/s41598-020-79217-x</p></li>
</ol>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<section id="appendix-a-additional-dataset-details" class="level2">
<h2 class="anchored" data-anchor-id="appendix-a-additional-dataset-details">Appendix A: Additional Dataset Details</h2>
<section id="detailed-dataset-information" class="level3">
<h3 class="anchored" data-anchor-id="detailed-dataset-information">Detailed Dataset Information</h3>
<section id="train-events-train_events.csv" class="level4">
<h4 class="anchored" data-anchor-id="train-events-train_events.csv">Train Events (train_events.csv)</h4>
<p>Accessible through this <a href="https://www.kaggle.com/competitions/child-mind-institute-detect-sleep-states/data?select=train_events.csv">link</a>, this dataset comprises sleep logs from accelerometer devices, documenting onset and wake events. It contains five columns, including <code>night</code> (enumeration of potential onset/wakeup event pairs), <code>event</code> (type of event), <code>step</code>, and <code>timestamp</code>.</p>
</section>
<section id="training-data-zzzs_train.parquet" class="level4">
<h4 class="anchored" data-anchor-id="training-data-zzzs_train.parquet">Training Data (Zzzs_train.parquet)</h4>
<p>Available <a href="https://www.kaggle.com/datasets/carlmcbrideellis/zzzs-lightweight-training-dataset-target?select=Zzzs_train.parquet">here</a>, this dataset includes continuous accelerometer recordings. It features metrics like <code>series_id</code>, <code>step</code>, <code>timestamp</code>, <code>anglez</code>, and <code>enmo</code>, the latter two being crucial metrics for sleep detection as described by the <a href="https://cran.r-project.org/web/packages/GGIR/vignettes/GGIR.html#4_Inspecting_the_results">GGIR package</a>.<code>enmo</code> (Euclidean Norm Minus One with negative values rounded to zero) is an acceleration metric describing physical activities. <code>anglez</code> is the angle of the arm relative to the vertical axis of the body.</p>
</section>
<section id="test-data-test_series.parquet" class="level4">
<h4 class="anchored" data-anchor-id="test-data-test_series.parquet">Test Data (test_series.parquet)</h4>
<p>This dataset, used for testing, mirrors the structure of the training data. It can be accessed <a href="https://www.kaggle.com/competitions/child-mind-institute-detect-sleep-states/data?select=test_series.parquet">here</a>.</p>
</section>
</section>
</section>
<section id="appendix-b-additional-plots" class="level2">
<h2 class="anchored" data-anchor-id="appendix-b-additional-plots">Appendix B: Additional Plots</h2>
<div class="cell">
<div class="cell-output-display">
<p><img src="SleepPatternDetectionManuscript_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="SleepPatternDetectionManuscript_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="cell">
<div class="cell-output-display">
<p><img src="SleepPatternDetectionManuscript_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 148   2
         1   3 149
                                          
               Accuracy : 0.9834          
                 95% CI : (0.9618, 0.9946)
    No Information Rate : 0.5             
    P-Value [Acc &gt; NIR] : &lt;2e-16          
                                          
                  Kappa : 0.9669          
                                          
 Mcnemar's Test P-Value : 1               
                                          
            Sensitivity : 0.9801          
            Specificity : 0.9868          
         Pos Pred Value : 0.9867          
         Neg Pred Value : 0.9803          
             Prevalence : 0.5000          
         Detection Rate : 0.4901          
   Detection Prevalence : 0.4967          
      Balanced Accuracy : 0.9834          
                                          
       'Positive' Class : 0               
                                          </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Precision: 0.986666666666667"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Recall: 0.980132450331126"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "F1 Score: 0.983388704318937"</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<p><img src="SleepPatternDetectionManuscript_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="appendix-c-tests-on-a-small-sample-data" class="level2">
<h2 class="anchored" data-anchor-id="appendix-c-tests-on-a-small-sample-data">Appendix C: Tests on A Small Sample Data</h2>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 5
  row_id series_id     step event  score
   &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
1      0 038441c925bb   124 onset  0.958
2      1 038441c925bb   922 wakeup 0.901
3      2 038491c925aa   315 onset  0.731
4      3 038491c925aa   478 wakeup 0.949
5      4 03d92c9f6f8a   730 onset  0.2  
6      5 03d92c9f6f8a   724 wakeup 0.955
7      6 0402a003dae9   842 onset  0.233
8      7 0402a003dae9   839 wakeup 0.949</code></pre>
</div>
</div>
</section>
<section id="appendix-d-code-details" class="level2">
<h2 class="anchored" data-anchor-id="appendix-d-code-details">Appendix D: Code Details</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#- Load libraries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read train_events and modify timestamp with lubridate</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read events</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>events <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"train_events.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">dt =</span> <span class="fu">as_datetime</span>(timestamp)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">dt =</span> dt <span class="sc">-</span> <span class="fu">hours</span>(<span class="dv">4</span>))  <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">hr =</span> <span class="fu">hour</span>(dt)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>timestamp)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(events)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">#- Events counts</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>events <span class="sc">%&gt;%</span> <span class="fu">count</span>(event)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">#- Sleep onset and wakeup timeline</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge onset and wakeup data on dates</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>timeline_data <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(event <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"onset"</span>, <span class="st">"wakeup"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(dt)) <span class="sc">%&gt;%</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time_minutes =</span> <span class="fu">hour</span>(dt) <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> <span class="fu">minute</span>(dt))</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(timeline_data, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> time_minutes, <span class="at">color =</span> event)) <span class="sc">+</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sleep Onset and Wakeup Timeline"</span>,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Time of Day (minutes after midnight)"</span>) <span class="sc">+</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate sleep durations and onset hour</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>pivot_data <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series_id, night) <span class="sc">%&gt;%</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">duration_minutes =</span> (<span class="fu">max</span>(step) <span class="sc">-</span> <span class="fu">min</span>(step)) <span class="sc">/</span> <span class="dv">60</span>,</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">onset_hour =</span> <span class="fu">hour</span>(<span class="fu">min</span>(dt)),<span class="at">.groups =</span> <span class="st">'drop'</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average sleep duration by hour of onset</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>average_duration_by_hour <span class="ot">&lt;-</span> pivot_data <span class="sc">%&gt;%</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(onset_hour) <span class="sc">%&gt;%</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">avg_duration =</span> <span class="fu">mean</span>(duration_minutes),<span class="at">.groups =</span> <span class="st">'drop'</span>)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a bar plot</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(average_duration_by_hour, <span class="fu">aes</span>(<span class="at">x =</span> onset_hour, <span class="at">y =</span> avg_duration, <span class="at">fill =</span> avg_duration)) <span class="sc">+</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Average Sleep Duration by Hour of Onset"</span>,</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Hour of Sleep Onset"</span>,</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Average Sleep Duration (minutes)"</span>) <span class="sc">+</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"red"</span>, <span class="at">high =</span> <span class="st">"green"</span>)  </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Order days of the week</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>ordered_days <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Monday"</span>, <span class="st">"Tuesday"</span>, <span class="st">"Wednesday"</span>, <span class="st">"Thursday"</span>, <span class="st">"Friday"</span>, <span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract day of week and calculate sleep duration in minutes</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate sleep duration in minutes and extract day of the week</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>pivot_data <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series_id, night) <span class="sc">%&gt;%</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">duration_minutes =</span> (<span class="fu">max</span>(step) <span class="sc">-</span> <span class="fu">min</span>(step)) <span class="sc">/</span> <span class="dv">60</span>,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_datetime =</span> <span class="fu">min</span>(dt),<span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">day_of_week =</span> <span class="fu">factor</span>(<span class="fu">format</span>(min_datetime, <span class="st">"%A"</span>), <span class="at">levels =</span> ordered_days))</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a box plot</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>plot3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pivot_data, <span class="fu">aes</span>(<span class="at">x =</span> day_of_week, <span class="at">y =</span> duration_minutes, <span class="at">fill =</span> day_of_week)) <span class="sc">+</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Box Plot of Sleep Duration by Day of Week"</span>,</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Day of the Week"</span>,</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Sleep Duration (minutes)"</span>) <span class="sc">+</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a><span class="co">#- Distribution of wakeup and Distribution of onset</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the data for "wakeup" and "onset" events</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>events_wakeup <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> <span class="fu">filter</span>(event <span class="sc">==</span> <span class="st">"wakeup"</span>)</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>events_onset <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> <span class="fu">filter</span>(event <span class="sc">==</span> <span class="st">"onset"</span>)</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the filtered data into a single data frame</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>combined_events <span class="ot">&lt;-</span> <span class="fu">rbind</span>(events_wakeup, events_onset)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot with density lines for "wakeup" and "onset" events</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>plot4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_events, <span class="fu">aes</span>(<span class="at">x =</span> hr, <span class="at">color =</span> event, <span class="at">fill =</span> event)) <span class="sc">+</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Hour"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"wakeup"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"onset"</span> <span class="ot">=</span> <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"wakeup"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"onset"</span> <span class="ot">=</span> <span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of events per series</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>events_per_series <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series_id) <span class="sc">%&gt;%</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">num_events =</span> <span class="fu">n</span>())</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a histogram for the distribution of events per series</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>plot5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(events_per_series, <span class="fu">aes</span>(<span class="at">x =</span> num_events)) <span class="sc">+</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"orange"</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Number of Events per Series"</span>,</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Number of Events"</span>,</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Number of Series"</span>) <span class="sc">+</span></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Most series exhibit approximately 48 events. However, there are a few series with a significantly lower number of valid events, which may be excluded from the study.</span></span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a><span class="co">#- Detect NA in events</span></span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>events_na <span class="ot">&lt;-</span> events <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(series_id,step) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(step))</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>events_na</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>num_na <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(events_na<span class="sc">$</span>series_id))</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>na_id <span class="ot">&lt;-</span> <span class="fu">unique</span>(events_na<span class="sc">$</span>series_id)</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>num_na</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>na_id</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Steps containing records with 'NA' (not available) were identified as not precise enough and subsequently removed. Our primary focus was on analyzing accelerometer data that is complete, without any missing values ('NA'). This approach ensures the integrity and reliability of our findings.</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a><span class="co">#- Series_id without NA events</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>all_id <span class="ot">&lt;-</span> <span class="fu">unique</span>(events<span class="sc">$</span>series_id)</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>nna_id <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(all_id,na_id)</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>nna_id</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a><span class="co"># In this study, steps containing records with 'NA' (not available) were identified as not precise enough and subsequently removed. Our primary focus was on analyzing accelerometer data that is complete, without any missing values ('NA'). This approach ensures the integrity and reliability of our findings, as we are utilizing only the most accurate and comprehensive data sets available.</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a><span class="co">#- Remove two truncated event series</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>trunc <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"31011ade7c0a"</span>,<span class="st">"a596ad0b82aa"</span>)</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>nna_id <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(nna_id,trunc)</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>df_nna <span class="ot">&lt;-</span> <span class="fu">tibble</span>(nna_id) <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">series_id =</span> nna_id)</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> plot1 <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure1"</span>)<span class="sc">+</span></span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>plot3 <span class="ot">&lt;-</span> plot3 <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure 2"</span>)<span class="sc">+</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>motivate_plot <span class="ot">&lt;-</span> plot1 <span class="sc">+</span> plot3</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">plot_layout</span>(<span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>motivate_plot</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read training data</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">'Zzzs_train.parquet'</span>)</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train)</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>nna_train <span class="ot">&lt;-</span> <span class="fu">right_join</span>(train,df_nna)</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>nna_event <span class="ot">&lt;-</span> <span class="fu">right_join</span>(events,df_nna)</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>train_new <span class="ot">&lt;-</span> <span class="fu">left_join</span>(nna_train,nna_event)</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>train_new_full <span class="ot">&lt;-</span> <span class="fu">right_join</span>(nna_train,nna_event)</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train_new_full)</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>training_data <span class="ot">&lt;-</span> train_new_full <span class="sc">%&gt;%</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>timestamp,<span class="sc">-</span>event,<span class="sc">-</span>dt,<span class="sc">-</span>night) </span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(training_data)</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read testing data</span></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>test_old <span class="ot">&lt;-</span> <span class="fu">read_parquet</span>(<span class="st">"test_series.parquet"</span>) </span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a few random data to enlarge the test_series, the original one only has 3 unique series_id, each series lasts for 2.5 hours.</span></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>num_rows <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>random_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id =</span> <span class="fu">rep</span>(<span class="st">"038441c925bb"</span>, num_rows),</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="dv">0</span><span class="sc">:</span>(num_rows<span class="dv">-1</span>),</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">ymd_hms</span>(<span class="st">"2023-12-13T22:30:00-0400"</span>), </span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">"5 sec"</span>, <span class="at">length.out =</span> num_rows),</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">anglez =</span> <span class="fu">runif</span>(num_rows, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>),  <span class="co"># Random values between 0 and 5</span></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">enmo =</span> <span class="fu">runif</span>(num_rows, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.05</span>)  <span class="co"># Random values between 0 and 0.05</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timestamps to character</span></span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>random_data<span class="sc">$</span>timestamp <span class="ot">&lt;-</span> <span class="fu">format</span>(random_data<span class="sc">$</span>timestamp, <span class="at">format=</span><span class="st">"%Y-%m-%dT%H:%M:%S-0400"</span>)</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(test_old, random_data)</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>random_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id =</span> <span class="fu">rep</span>(<span class="st">"038491c925aa"</span>, num_rows),</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="dv">0</span><span class="sc">:</span>(num_rows<span class="dv">-1</span>),</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">ymd_hms</span>(<span class="st">"2020-10-13T23:45:00-0300"</span>), </span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">"5 sec"</span>, <span class="at">length.out =</span> num_rows),</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>  <span class="at">anglez =</span> <span class="fu">runif</span>(num_rows, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>),  <span class="co"># Random values between 0 and 5</span></span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>  <span class="at">enmo =</span> <span class="fu">runif</span>(num_rows, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.05</span>)  <span class="co"># Random values between 0 and 0.05</span></span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timestamps to character</span></span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>random_data<span class="sc">$</span>timestamp <span class="ot">&lt;-</span> <span class="fu">format</span>(random_data<span class="sc">$</span>timestamp, <span class="at">format=</span><span class="st">"%Y-%m-%dT%H:%M:%S-0500"</span>)</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(test, random_data)</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>random_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">series_id =</span> <span class="fu">rep</span>(<span class="st">"038491c925aa"</span>, num_rows),</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="dv">0</span><span class="sc">:</span>(num_rows<span class="dv">-1</span>),</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">timestamp =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">ymd_hms</span>(<span class="st">"2021-02-13T02:36:00-0400"</span>), </span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">"5 sec"</span>, <span class="at">length.out =</span> num_rows),</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>  <span class="at">anglez =</span> <span class="fu">runif</span>(num_rows, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="dv">5</span>),  <span class="co"># Random values between 0 and 5</span></span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>  <span class="at">enmo =</span> <span class="fu">runif</span>(num_rows, <span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fl">0.05</span>)  <span class="co"># Random values between 0 and 0.05</span></span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timestamps to character</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>random_data<span class="sc">$</span>timestamp <span class="ot">&lt;-</span> <span class="fu">format</span>(random_data<span class="sc">$</span>timestamp, <span class="at">format=</span><span class="st">"%Y-%m-%dT%H:%M:%S-0500"</span>)</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">rbind</span>(test, random_data)</span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> test  <span class="sc">%&gt;%</span> </span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">dt =</span> <span class="fu">as_datetime</span>(timestamp)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">dt =</span> dt <span class="sc">-</span> <span class="fu">hours</span>(<span class="dv">4</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">hr =</span> <span class="fu">hour</span>(dt)) <span class="sc">%&gt;%</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">step =</span> hr<span class="sc">*</span><span class="dv">60</span><span class="sc">+</span>step) <span class="sc">%&gt;%</span></span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="sc">-</span>timestamp,<span class="sc">-</span>dt)</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(test)</span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">createDataPartition</span>(training_data<span class="sc">$</span>awake, <span class="at">p =</span> <span class="fl">0.8</span>, <span class="at">list =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>training_set <span class="ot">&lt;-</span> training_data[split, ]</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>training_set<span class="sc">$</span>awake <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(training_set<span class="sc">$</span>awake)</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>testing_set <span class="ot">&lt;-</span> training_data[<span class="sc">-</span>split, ]</span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>testing_set<span class="sc">$</span>awake <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(testing_set<span class="sc">$</span>awake)</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>preprocessing_method <span class="ot">&lt;-</span> <span class="st">"standardize"</span>  <span class="co"># or "normalize"</span></span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>preprocess_params <span class="ot">&lt;-</span>  <span class="fu">preProcess</span>(training_set, <span class="at">method =</span> <span class="fu">ifelse</span>(preprocessing_method <span class="sc">==</span> <span class="st">"standardize"</span>, <span class="fu">c</span>(<span class="st">"center"</span>, <span class="st">"scale"</span>), <span class="fu">c</span>(<span class="st">"range"</span>)))</span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(preprocess_params, <span class="at">file =</span> <span class="st">"preprocess_params.rds"</span>)</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>preprocessed_training_set <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocess_params, training_set)</span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a data frame to store results</span></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ntree =</span> <span class="fu">integer</span>(), <span class="at">mtry =</span> <span class="fu">integer</span>(), <span class="at">OOBError =</span> <span class="fu">numeric</span>())</span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the range for mtry and ntree</span></span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>mtry_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">ncol</span>(preprocessed_training_set) <span class="sc">-</span> <span class="dv">1</span>, <span class="at">by=</span><span class="dv">1</span>)  <span class="co"># Full range for predictors</span></span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>ntree_range <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">550</span>, <span class="at">by=</span><span class="dv">5</span>)  <span class="co"># range for ntree</span></span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over mtry and ntree values</span></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (mtry <span class="cf">in</span> mtry_range) {</span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ntree <span class="cf">in</span> ntree_range) {</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(awake <span class="sc">~</span> ., <span class="at">data =</span> preprocessed_training_set, <span class="at">mtry =</span> mtry, <span class="at">ntree =</span> ntree, <span class="at">do.trace=</span><span class="cn">FALSE</span>)</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract OOB error rate</span></span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>    OOBError <span class="ot">&lt;-</span> model<span class="sc">$</span>err.rate[<span class="fu">nrow</span>(model<span class="sc">$</span>err.rate), <span class="st">"OOB"</span>]</span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store results</span></span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>    results_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(results_df, <span class="fu">data.frame</span>(<span class="at">ntree =</span> ntree, <span class="at">mtry =</span> mtry, <span class="at">OOBError =</span> OOBError))</span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if results_df is empty or has NA values</span></span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(results_df) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">is.na</span>(results_df<span class="sc">$</span>OOBError))) {</span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"No data to plot. Check the random forest model training."</span>)</span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot accuracy vs. mtry (plot accuracy for different mtry at a fixed ntree)</span></span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate accuracy from the OOB error rate</span></span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a>results_df<span class="sc">$</span>Accuracy <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> results_df<span class="sc">$</span>OOBError</span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a>accuracy_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">subset</span>(results_df, ntree <span class="sc">==</span> <span class="dv">550</span>), <span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> Accuracy)) <span class="sc">+</span></span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Attempt1: max experimental ntree"</span>,</span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"#Randomly Selected Predictors"</span>,</span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Accuracy (Cross-validation)"</span>)</span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(accuracy_plot)</span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the results for mtry = 2 and mtry = 3</span></span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="ot">&lt;-</span> results_df[results_df<span class="sc">$</span>mtry <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>), ]</span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Find local minima for each mtry group</span></span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a>local_minima <span class="ot">&lt;-</span> filtered_df <span class="sc">%&gt;%</span></span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mtry) <span class="sc">%&gt;%</span></span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which</span>(<span class="fu">diff</span>(<span class="fu">sign</span>(<span class="fu">diff</span>(OOBError))) <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true" tabindex="-1"></a>specific_minima <span class="ot">&lt;-</span> local_minima[<span class="dv">5</span>, ]</span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true" tabindex="-1"></a>label_point <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true" tabindex="-1"></a>  <span class="at">ntree =</span> <span class="dv">335</span>,</span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true" tabindex="-1"></a>  <span class="at">OOBError =</span> <span class="fl">0.01732673</span>,</span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true" tabindex="-1"></a>  <span class="at">label =</span> <span class="st">"ntree: 335</span><span class="sc">\n</span><span class="st">Error: 0.0173"</span>)</span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot OOB error rates for mtry = 2 and mtry = 3</span></span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true" tabindex="-1"></a>oob_error_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(filtered_df, <span class="fu">aes</span>(<span class="at">x =</span> ntree, <span class="at">y =</span> OOBError, <span class="at">color =</span> <span class="fu">as.factor</span>(mtry), <span class="at">group =</span> mtry)) <span class="sc">+</span></span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> specific_minima, <span class="fu">aes</span>(<span class="at">x =</span> ntree, <span class="at">y =</span> OOBError), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">shape =</span> <span class="dv">21</span>, <span class="at">fill =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> label_point, <span class="fu">aes</span>(<span class="at">x =</span> ntree, <span class="at">y =</span> OOBError, <span class="at">label =</span> label), <span class="at">nudge_y =</span> <span class="fl">0.001</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">vjust =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Number of Trees"</span>) <span class="sc">+</span></span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Out-of-Bag Error Rate"</span>) <span class="sc">+</span></span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Error Rate Over mtry = 2 and 3"</span>) <span class="sc">+</span></span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"yellow"</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"mtry = 2"</span>, <span class="st">"mtry = 3"</span>)) <span class="sc">+</span></span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(oob_error_plot)</span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true" tabindex="-1"></a>results_df<span class="sc">$</span>Accuracy <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> results_df<span class="sc">$</span>OOBError</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true" tabindex="-1"></a>accuracy_plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">subset</span>(results_df, ntree <span class="sc">==</span> <span class="dv">335</span>), <span class="fu">aes</span>(<span class="at">x =</span> mtry, <span class="at">y =</span> Accuracy)) <span class="sc">+</span></span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Attempt2: ntree=335"</span>,</span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"#Randomly Selected Predictors"</span>,</span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Accuracy (Cross-validation)"</span>)</span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(accuracy_plot2)</span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true" tabindex="-1"></a>accuracy_plot <span class="ot">&lt;-</span> accuracy_plot<span class="sc">+</span><span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure3.1"</span>)<span class="sc">+</span><span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true" tabindex="-1"></a>oob_error_plot <span class="ot">&lt;-</span> oob_error_plot<span class="sc">+</span><span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure4"</span>)<span class="sc">+</span><span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true" tabindex="-1"></a>accuracy_plot2 <span class="ot">&lt;-</span> accuracy_plot2<span class="sc">+</span><span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure3.2"</span>)<span class="sc">+</span><span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true" tabindex="-1"></a>hyperparam_plot <span class="ot">&lt;-</span> accuracy_plot<span class="sc">+</span>oob_error_plot<span class="sc">+</span>accuracy_plot2</span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">plot_layout</span>(<span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb6-286"><a href="#cb6-286" aria-hidden="true" tabindex="-1"></a>hyperparam_plot</span>
<span id="cb6-287"><a href="#cb6-287" aria-hidden="true" tabindex="-1"></a>preprocessed_training_set<span class="sc">$</span>awake <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(preprocessed_training_set<span class="sc">$</span>awake)</span>
<span id="cb6-288"><a href="#cb6-288" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(awake <span class="sc">~</span> ., <span class="at">data =</span> preprocessed_training_set, <span class="at">ntree =</span> <span class="dv">335</span>, <span class="at">mtry =</span> <span class="dv">3</span>)</span>
<span id="cb6-289"><a href="#cb6-289" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(model, <span class="at">file =</span> <span class="st">"ReducRFmodel.rds"</span>)</span>
<span id="cb6-290"><a href="#cb6-290" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate training accuracy</span></span>
<span id="cb6-291"><a href="#cb6-291" aria-hidden="true" tabindex="-1"></a>confusion_matrix <span class="ot">&lt;-</span> model<span class="sc">$</span>confusion</span>
<span id="cb6-292"><a href="#cb6-292" aria-hidden="true" tabindex="-1"></a>training_accuracy <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">diag</span>(confusion_matrix)) <span class="sc">/</span> <span class="fu">sum</span>(confusion_matrix)</span>
<span id="cb6-293"><a href="#cb6-293" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(confusion_matrix)</span>
<span id="cb6-294"><a href="#cb6-294" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Training Accuracy:"</span>, training_accuracy))</span>
<span id="cb6-295"><a href="#cb6-295" aria-hidden="true" tabindex="-1"></a>oob_error <span class="ot">&lt;-</span> model<span class="sc">$</span>err.rate[<span class="fu">nrow</span>(model<span class="sc">$</span>err.rate), <span class="st">"OOB"</span>]</span>
<span id="cb6-296"><a href="#cb6-296" aria-hidden="true" tabindex="-1"></a>training_oob_accuracy <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> oob_error</span>
<span id="cb6-297"><a href="#cb6-297" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"OOB Error Rate:"</span>, oob_error))</span>
<span id="cb6-298"><a href="#cb6-298" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Training OOB Accuracy:"</span>, training_oob_accuracy))</span>
<span id="cb6-299"><a href="#cb6-299" aria-hidden="true" tabindex="-1"></a>preprocess_params <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"preprocess_params.rds"</span>)</span>
<span id="cb6-300"><a href="#cb6-300" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the same preprocessing to the test data</span></span>
<span id="cb6-301"><a href="#cb6-301" aria-hidden="true" tabindex="-1"></a>preprocessed_testing_set <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocess_params, testing_set)</span>
<span id="cb6-302"><a href="#cb6-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure that 'predict' function returns probabilities</span></span>
<span id="cb6-303"><a href="#cb6-303" aria-hidden="true" tabindex="-1"></a>testing_set_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, preprocessed_testing_set, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb6-304"><a href="#cb6-304" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract probabilities for the positive class ( '1' is the positive class)</span></span>
<span id="cb6-305"><a href="#cb6-305" aria-hidden="true" tabindex="-1"></a>positive_class_probs <span class="ot">&lt;-</span> testing_set_probs[, <span class="st">"1"</span>]</span>
<span id="cb6-306"><a href="#cb6-306" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ROC object</span></span>
<span id="cb6-307"><a href="#cb6-307" aria-hidden="true" tabindex="-1"></a>roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(preprocessed_testing_set<span class="sc">$</span>awake, positive_class_probs)</span>
<span id="cb6-308"><a href="#cb6-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the AUC</span></span>
<span id="cb6-309"><a href="#cb6-309" aria-hidden="true" tabindex="-1"></a>auc_value <span class="ot">&lt;-</span> <span class="fu">auc</span>(roc_obj)</span>
<span id="cb6-310"><a href="#cb6-310" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(auc_value)</span>
<span id="cb6-311"><a href="#cb6-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ROC curve along with AUC</span></span>
<span id="cb6-312"><a href="#cb6-312" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(roc_obj, <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"ROC Curve, AUC ="</span>, <span class="fu">round</span>(auc_value, <span class="dv">6</span>)))</span>
<span id="cb6-313"><a href="#cb6-313" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(testing_set, <span class="st">"testing_set.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-314"><a href="#cb6-314" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(testing_set_probs, <span class="st">"testing_set_probs.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-315"><a href="#cb6-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-316"><a href="#cb6-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting predicted class labels with a threshold. I use 0.5 here</span></span>
<span id="cb6-317"><a href="#cb6-317" aria-hidden="true" tabindex="-1"></a>predicted_labels <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(testing_set_probs[, <span class="st">"1"</span>] <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb6-318"><a href="#cb6-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-319"><a href="#cb6-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion Matrix</span></span>
<span id="cb6-320"><a href="#cb6-320" aria-hidden="true" tabindex="-1"></a>confusionMatrix <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(predicted_labels), <span class="fu">factor</span>(preprocessed_testing_set<span class="sc">$</span>awake))</span>
<span id="cb6-321"><a href="#cb6-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-322"><a href="#cb6-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the Confusion Matrix</span></span>
<span id="cb6-323"><a href="#cb6-323" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(confusionMatrix)</span>
<span id="cb6-324"><a href="#cb6-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-325"><a href="#cb6-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Precision, Recall, and F1 Score</span></span>
<span id="cb6-326"><a href="#cb6-326" aria-hidden="true" tabindex="-1"></a>precision <span class="ot">&lt;-</span> <span class="fu">posPredValue</span>(<span class="fu">factor</span>(predicted_labels), <span class="fu">factor</span>(preprocessed_testing_set<span class="sc">$</span>awake))</span>
<span id="cb6-327"><a href="#cb6-327" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> <span class="fu">sensitivity</span>(<span class="fu">factor</span>(predicted_labels), <span class="fu">factor</span>(preprocessed_testing_set<span class="sc">$</span>awake))</span>
<span id="cb6-328"><a href="#cb6-328" aria-hidden="true" tabindex="-1"></a>f1_score <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> ((precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall))</span>
<span id="cb6-329"><a href="#cb6-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-330"><a href="#cb6-330" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the metrics</span></span>
<span id="cb6-331"><a href="#cb6-331" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Precision:"</span>, precision))</span>
<span id="cb6-332"><a href="#cb6-332" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Recall:"</span>, recall))</span>
<span id="cb6-333"><a href="#cb6-333" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"F1 Score:"</span>, f1_score))</span>
<span id="cb6-334"><a href="#cb6-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract feature importance</span></span>
<span id="cb6-335"><a href="#cb6-335" aria-hidden="true" tabindex="-1"></a>importance <span class="ot">&lt;-</span> <span class="fu">importance</span>(model)</span>
<span id="cb6-336"><a href="#cb6-336" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(importance)</span>
<span id="cb6-337"><a href="#cb6-337" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-338"><a href="#cb6-338" aria-hidden="true" tabindex="-1"></a>  <span class="at">Feature =</span> <span class="fu">rownames</span>(importance),</span>
<span id="cb6-339"><a href="#cb6-339" aria-hidden="true" tabindex="-1"></a>  <span class="at">Importance =</span> importance[, <span class="st">"MeanDecreaseGini"</span>]</span>
<span id="cb6-340"><a href="#cb6-340" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-341"><a href="#cb6-341" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using ggplot2</span></span>
<span id="cb6-342"><a href="#cb6-342" aria-hidden="true" tabindex="-1"></a>rf_feature_importance_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(feature_importance, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Feature, Importance), <span class="at">y =</span> Importance)) <span class="sc">+</span></span>
<span id="cb6-343"><a href="#cb6-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb6-344"><a href="#cb6-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span>  <span class="co"># Flips the axes for horizontal bars</span></span>
<span id="cb6-345"><a href="#cb6-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Feature"</span>) <span class="sc">+</span></span>
<span id="cb6-346"><a href="#cb6-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"MeanDecreaseGini"</span>) <span class="sc">+</span></span>
<span id="cb6-347"><a href="#cb6-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Feature Importance from Random Forest Model"</span>) <span class="sc">+</span></span>
<span id="cb6-348"><a href="#cb6-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb6-349"><a href="#cb6-349" aria-hidden="true" tabindex="-1"></a>preprocess_params <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"preprocess_params.rds"</span>)</span>
<span id="cb6-350"><a href="#cb6-350" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the same preprocessing to the test data</span></span>
<span id="cb6-351"><a href="#cb6-351" aria-hidden="true" tabindex="-1"></a>preprocessed_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(preprocess_params, test)</span>
<span id="cb6-352"><a href="#cb6-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probabilities</span></span>
<span id="cb6-353"><a href="#cb6-353" aria-hidden="true" tabindex="-1"></a><span class="co"># This returns a matrix with probabilities for each class</span></span>
<span id="cb6-354"><a href="#cb6-354" aria-hidden="true" tabindex="-1"></a>prob_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> preprocessed_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb6-355"><a href="#cb6-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-356"><a href="#cb6-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the predicted class based on the higher probability</span></span>
<span id="cb6-357"><a href="#cb6-357" aria-hidden="true" tabindex="-1"></a><span class="co"># And extract the corresponding confidence score</span></span>
<span id="cb6-358"><a href="#cb6-358" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>predicted_event <span class="ot">&lt;-</span> <span class="fu">apply</span>(prob_predictions, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">names</span>(x)[<span class="fu">which.max</span>(x)])</span>
<span id="cb6-359"><a href="#cb6-359" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>confidence_score <span class="ot">&lt;-</span> <span class="fu">apply</span>(prob_predictions, <span class="dv">1</span>, max)</span>
<span id="cb6-360"><a href="#cb6-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-361"><a href="#cb6-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare submission data frame and Write</span></span>
<span id="cb6-362"><a href="#cb6-362" aria-hidden="true" tabindex="-1"></a>submission <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb6-363"><a href="#cb6-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(series_id, step, predicted_event, confidence_score)</span>
<span id="cb6-364"><a href="#cb6-364" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(submission, <span class="st">"submission.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-365"><a href="#cb6-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probabilities</span></span>
<span id="cb6-366"><a href="#cb6-366" aria-hidden="true" tabindex="-1"></a>prob_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> preprocessed_test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb6-367"><a href="#cb6-367" aria-hidden="true" tabindex="-1"></a><span class="co"># Add predicted probabilities to the test data</span></span>
<span id="cb6-368"><a href="#cb6-368" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>onset_confidence <span class="ot">&lt;-</span> prob_predictions[,<span class="st">"1"</span>] </span>
<span id="cb6-369"><a href="#cb6-369" aria-hidden="true" tabindex="-1"></a>test<span class="sc">$</span>wakeup_confidence <span class="ot">&lt;-</span> prob_predictions[,<span class="st">"0"</span>]</span>
<span id="cb6-370"><a href="#cb6-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-371"><a href="#cb6-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the most likely onset and wakeup for each series_id</span></span>
<span id="cb6-372"><a href="#cb6-372" aria-hidden="true" tabindex="-1"></a><span class="co"># For each series_id, find the step with the highest confidence for onset and wakeup</span></span>
<span id="cb6-373"><a href="#cb6-373" aria-hidden="true" tabindex="-1"></a>final_selection <span class="ot">&lt;-</span> test <span class="sc">%&gt;%</span></span>
<span id="cb6-374"><a href="#cb6-374" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series_id) <span class="sc">%&gt;%</span></span>
<span id="cb6-375"><a href="#cb6-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb6-376"><a href="#cb6-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">onset_step =</span> step[<span class="fu">which.max</span>(onset_confidence)],</span>
<span id="cb6-377"><a href="#cb6-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">onset_score =</span> <span class="fu">max</span>(onset_confidence),</span>
<span id="cb6-378"><a href="#cb6-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">wakeup_step =</span> step[<span class="fu">which.max</span>(wakeup_confidence)],</span>
<span id="cb6-379"><a href="#cb6-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">wakeup_score =</span> <span class="fu">max</span>(wakeup_confidence)</span>
<span id="cb6-380"><a href="#cb6-380" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-381"><a href="#cb6-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb6-382"><a href="#cb6-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-383"><a href="#cb6-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data for submission</span></span>
<span id="cb6-384"><a href="#cb6-384" aria-hidden="true" tabindex="-1"></a>final_submission <span class="ot">&lt;-</span> final_selection <span class="sc">%&gt;%</span></span>
<span id="cb6-385"><a href="#cb6-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(series_id, onset_step, onset_score, wakeup_step, wakeup_score) <span class="sc">%&gt;%</span></span>
<span id="cb6-386"><a href="#cb6-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb6-387"><a href="#cb6-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(onset_step, wakeup_step),</span>
<span id="cb6-388"><a href="#cb6-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"event_type"</span>,</span>
<span id="cb6-389"><a href="#cb6-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"step"</span></span>
<span id="cb6-390"><a href="#cb6-390" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-391"><a href="#cb6-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-392"><a href="#cb6-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">event =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"onset_step"</span>, <span class="st">"onset"</span>, <span class="st">"wakeup"</span>),</span>
<span id="cb6-393"><a href="#cb6-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">score =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="st">"onset_step"</span>, onset_score, wakeup_score)</span>
<span id="cb6-394"><a href="#cb6-394" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-395"><a href="#cb6-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>event_type, <span class="sc">-</span>onset_score, <span class="sc">-</span>wakeup_score)</span>
<span id="cb6-396"><a href="#cb6-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-397"><a href="#cb6-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign row_id</span></span>
<span id="cb6-398"><a href="#cb6-398" aria-hidden="true" tabindex="-1"></a>final_submission <span class="ot">&lt;-</span> final_submission <span class="sc">%&gt;%</span></span>
<span id="cb6-399"><a href="#cb6-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">row_id =</span> <span class="fu">row_number</span>() <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-400"><a href="#cb6-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(row_id, <span class="fu">everything</span>())</span>
<span id="cb6-401"><a href="#cb6-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-402"><a href="#cb6-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the mean values used for centering</span></span>
<span id="cb6-403"><a href="#cb6-403" aria-hidden="true" tabindex="-1"></a>step_mean <span class="ot">&lt;-</span> preprocess_params<span class="sc">$</span>mean[<span class="st">"step"</span>]</span>
<span id="cb6-404"><a href="#cb6-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-405"><a href="#cb6-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Write submission file</span></span>
<span id="cb6-406"><a href="#cb6-406" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(final_submission, <span class="st">"final_submission.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-407"><a href="#cb6-407" aria-hidden="true" tabindex="-1"></a><span class="co"># # Filter function</span></span>
<span id="cb6-408"><a href="#cb6-408" aria-hidden="true" tabindex="-1"></a><span class="co"># # Define feature columns used in the model</span></span>
<span id="cb6-409"><a href="#cb6-409" aria-hidden="true" tabindex="-1"></a><span class="co"># feature_cols &lt;- c("series_id", "step", "anglez", "enmo", "hr")  # Include 'step' and other features</span></span>
<span id="cb6-410"><a href="#cb6-410" aria-hidden="true" tabindex="-1"></a><span class="co"># # Loop over each series ID</span></span>
<span id="cb6-411"><a href="#cb6-411" aria-hidden="true" tabindex="-1"></a><span class="co"># unique_series_ids&lt;-unique(preprocessed_test$series_id)</span></span>
<span id="cb6-412"><a href="#cb6-412" aria-hidden="true" tabindex="-1"></a><span class="co"># for (series_id in unique_series_ids) {</span></span>
<span id="cb6-413"><a href="#cb6-413" aria-hidden="true" tabindex="-1"></a><span class="co">#     series_data &lt;- preprocessed_test %&gt;% filter(series_id == series_id)</span></span>
<span id="cb6-414"><a href="#cb6-414" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-415"><a href="#cb6-415" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Predict events</span></span>
<span id="cb6-416"><a href="#cb6-416" aria-hidden="true" tabindex="-1"></a><span class="co">#     preds &lt;- predict(model, newdata = series_data[feature_cols])</span></span>
<span id="cb6-417"><a href="#cb6-417" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb6-418"><a href="#cb6-418" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Detect sleep onsets and wakeups</span></span>
<span id="cb6-419"><a href="#cb6-419" aria-hidden="true" tabindex="-1"></a><span class="co">#     pred_changes &lt;- c(FALSE, diff(preds) != 0)</span></span>
<span id="cb6-420"><a href="#cb6-420" aria-hidden="true" tabindex="-1"></a><span class="co">#     pred_onsets &lt;- series_data$step[preds == 1 &amp; pred_changes]</span></span>
<span id="cb6-421"><a href="#cb6-421" aria-hidden="true" tabindex="-1"></a><span class="co">#     pred_wakeups &lt;- series_data$step[preds == 0 &amp; pred_changes]</span></span>
<span id="cb6-422"><a href="#cb6-422" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb6-423"><a href="#cb6-423" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Filter and score events</span></span>
<span id="cb6-424"><a href="#cb6-424" aria-hidden="true" tabindex="-1"></a><span class="co">#     valid_periods &lt;- which(pred_wakeups - pred_onsets &gt;= 12 * 30)  # Adjust threshold as needed</span></span>
<span id="cb6-425"><a href="#cb6-425" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (length(valid_periods) &gt; 0) {</span></span>
<span id="cb6-426"><a href="#cb6-426" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (i in valid_periods) {</span></span>
<span id="cb6-427"><a href="#cb6-427" aria-hidden="true" tabindex="-1"></a><span class="co">#             onset_step &lt;- pred_onsets[i]</span></span>
<span id="cb6-428"><a href="#cb6-428" aria-hidden="true" tabindex="-1"></a><span class="co">#             wakeup_step &lt;- pred_wakeups[i]</span></span>
<span id="cb6-429"><a href="#cb6-429" aria-hidden="true" tabindex="-1"></a><span class="co">#             score &lt;- mean(series_data$onset_confidence[onset_step:wakeup_step], na.rm = TRUE)</span></span>
<span id="cb6-430"><a href="#cb6-430" aria-hidden="true" tabindex="-1"></a><span class="co">#             </span></span>
<span id="cb6-431"><a href="#cb6-431" aria-hidden="true" tabindex="-1"></a><span class="co">#             # Add to final submission</span></span>
<span id="cb6-432"><a href="#cb6-432" aria-hidden="true" tabindex="-1"></a><span class="co">#             final_submission &lt;- rbind(final_submission, data.frame(</span></span>
<span id="cb6-433"><a href="#cb6-433" aria-hidden="true" tabindex="-1"></a><span class="co">#                 series_id = series_id,</span></span>
<span id="cb6-434"><a href="#cb6-434" aria-hidden="true" tabindex="-1"></a><span class="co">#                 onset_step = onset_step,</span></span>
<span id="cb6-435"><a href="#cb6-435" aria-hidden="true" tabindex="-1"></a><span class="co">#                 wakeup_step = wakeup_step,</span></span>
<span id="cb6-436"><a href="#cb6-436" aria-hidden="true" tabindex="-1"></a><span class="co">#                 score = score</span></span>
<span id="cb6-437"><a href="#cb6-437" aria-hidden="true" tabindex="-1"></a><span class="co">#             ))</span></span>
<span id="cb6-438"><a href="#cb6-438" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb6-439"><a href="#cb6-439" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb6-440"><a href="#cb6-440" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb6-441"><a href="#cb6-441" aria-hidden="true" tabindex="-1"></a>final_submission</span>
<span id="cb6-442"><a href="#cb6-442" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb6-443"><a href="#cb6-443" aria-hidden="true" tabindex="-1"></a><span class="fu">use_condaenv</span>(<span class="st">"env"</span>, <span class="at">required =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-444"><a href="#cb6-444" aria-hidden="true" tabindex="-1"></a><span class="st">"""Event Detection Average Precision</span></span>
<span id="cb6-445"><a href="#cb6-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-446"><a href="#cb6-446" aria-hidden="true" tabindex="-1"></a><span class="st">An average precision metric for event detection in time series and</span></span>
<span id="cb6-447"><a href="#cb6-447" aria-hidden="true" tabindex="-1"></a><span class="st">video.</span></span>
<span id="cb6-448"><a href="#cb6-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-449"><a href="#cb6-449" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb6-450"><a href="#cb6-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-451"><a href="#cb6-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-452"><a href="#cb6-452" aria-hidden="true" tabindex="-1"></a>import numpy as np</span>
<span id="cb6-453"><a href="#cb6-453" aria-hidden="true" tabindex="-1"></a>import pandas as pd</span>
<span id="cb6-454"><a href="#cb6-454" aria-hidden="true" tabindex="-1"></a>import pandas.api.types</span>
<span id="cb6-455"><a href="#cb6-455" aria-hidden="true" tabindex="-1"></a>from typing import Dict, List, Tuple</span>
<span id="cb6-456"><a href="#cb6-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-457"><a href="#cb6-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-458"><a href="#cb6-458" aria-hidden="true" tabindex="-1"></a>class <span class="fu">ParticipantVisibleError</span>(Exception)<span class="sc">:</span></span>
<span id="cb6-459"><a href="#cb6-459" aria-hidden="true" tabindex="-1"></a>    pass</span>
<span id="cb6-460"><a href="#cb6-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-461"><a href="#cb6-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-462"><a href="#cb6-462" aria-hidden="true" tabindex="-1"></a><span class="co"># Set some placeholders for global parameters</span></span>
<span id="cb6-463"><a href="#cb6-463" aria-hidden="true" tabindex="-1"></a>series_id_column_name <span class="ot">=</span> None</span>
<span id="cb6-464"><a href="#cb6-464" aria-hidden="true" tabindex="-1"></a>time_column_name <span class="ot">=</span> None</span>
<span id="cb6-465"><a href="#cb6-465" aria-hidden="true" tabindex="-1"></a>event_column_name <span class="ot">=</span> None</span>
<span id="cb6-466"><a href="#cb6-466" aria-hidden="true" tabindex="-1"></a>score_column_name <span class="ot">=</span> None</span>
<span id="cb6-467"><a href="#cb6-467" aria-hidden="true" tabindex="-1"></a>use_scoring_intervals <span class="ot">=</span> None</span>
<span id="cb6-468"><a href="#cb6-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-469"><a href="#cb6-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-470"><a href="#cb6-470" aria-hidden="true" tabindex="-1"></a>def <span class="fu">score</span>(</span>
<span id="cb6-471"><a href="#cb6-471" aria-hidden="true" tabindex="-1"></a>        solution<span class="sc">:</span> pd.DataFrame,</span>
<span id="cb6-472"><a href="#cb6-472" aria-hidden="true" tabindex="-1"></a>        submission<span class="sc">:</span> pd.DataFrame,</span>
<span id="cb6-473"><a href="#cb6-473" aria-hidden="true" tabindex="-1"></a>        tolerances<span class="sc">:</span> Dict[str, List[float]],</span>
<span id="cb6-474"><a href="#cb6-474" aria-hidden="true" tabindex="-1"></a>        series_id_column_name<span class="sc">:</span> str,</span>
<span id="cb6-475"><a href="#cb6-475" aria-hidden="true" tabindex="-1"></a>        time_column_name<span class="sc">:</span> str,</span>
<span id="cb6-476"><a href="#cb6-476" aria-hidden="true" tabindex="-1"></a>        event_column_name<span class="sc">:</span> str,</span>
<span id="cb6-477"><a href="#cb6-477" aria-hidden="true" tabindex="-1"></a>        score_column_name<span class="sc">:</span> str,</span>
<span id="cb6-478"><a href="#cb6-478" aria-hidden="true" tabindex="-1"></a>        use_scoring_intervals<span class="sc">:</span> <span class="at">bool =</span> False,</span>
<span id="cb6-479"><a href="#cb6-479" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> float<span class="sc">:</span></span>
<span id="cb6-480"><a href="#cb6-480" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""Event Detection Average Precision, an AUCPR metric for event detection in</span></span>
<span id="cb6-481"><a href="#cb6-481" aria-hidden="true" tabindex="-1"></a><span class="st">    time series and video.</span></span>
<span id="cb6-482"><a href="#cb6-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-483"><a href="#cb6-483" aria-hidden="true" tabindex="-1"></a><span class="st">    This metric is similar to IOU-threshold average precision metrics commonly</span></span>
<span id="cb6-484"><a href="#cb6-484" aria-hidden="true" tabindex="-1"></a><span class="st">    used in object detection. For events occuring in time series, we replace the</span></span>
<span id="cb6-485"><a href="#cb6-485" aria-hidden="true" tabindex="-1"></a><span class="st">    IOU threshold with a time tolerance.</span></span>
<span id="cb6-486"><a href="#cb6-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-487"><a href="#cb6-487" aria-hidden="true" tabindex="-1"></a><span class="st">    Submissions are evaluated on the average precision of detected events,</span></span>
<span id="cb6-488"><a href="#cb6-488" aria-hidden="true" tabindex="-1"></a><span class="st">    averaged over timestamp error tolerance thresholds, averaged over event</span></span>
<span id="cb6-489"><a href="#cb6-489" aria-hidden="true" tabindex="-1"></a><span class="st">    classes.</span></span>
<span id="cb6-490"><a href="#cb6-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-491"><a href="#cb6-491" aria-hidden="true" tabindex="-1"></a><span class="st">    Detections are matched to ground-truth events within error tolerances, with</span></span>
<span id="cb6-492"><a href="#cb6-492" aria-hidden="true" tabindex="-1"></a><span class="st">    ambiguities resolved in order of decreasing confidence.</span></span>
<span id="cb6-493"><a href="#cb6-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-494"><a href="#cb6-494" aria-hidden="true" tabindex="-1"></a><span class="st">    Detailed Description</span></span>
<span id="cb6-495"><a href="#cb6-495" aria-hidden="true" tabindex="-1"></a><span class="st">    --------------------</span></span>
<span id="cb6-496"><a href="#cb6-496" aria-hidden="true" tabindex="-1"></a><span class="st">    Evaluation proceeds in four steps:</span></span>
<span id="cb6-497"><a href="#cb6-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-498"><a href="#cb6-498" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Selection - (optional) Predictions not within a series' scoring</span></span>
<span id="cb6-499"><a href="#cb6-499" aria-hidden="true" tabindex="-1"></a><span class="st">    intervals are dropped.</span></span>
<span id="cb6-500"><a href="#cb6-500" aria-hidden="true" tabindex="-1"></a><span class="st">    2. Assignment - Predicted events are matched with ground-truth events.</span></span>
<span id="cb6-501"><a href="#cb6-501" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Scoring - Each group of predictions is scored against its corresponding</span></span>
<span id="cb6-502"><a href="#cb6-502" aria-hidden="true" tabindex="-1"></a><span class="st">    group of ground-truth events via Average Precision.</span></span>
<span id="cb6-503"><a href="#cb6-503" aria-hidden="true" tabindex="-1"></a><span class="st">    4. Reduction - The multiple AP scores are averaged to produce a single</span></span>
<span id="cb6-504"><a href="#cb6-504" aria-hidden="true" tabindex="-1"></a><span class="st">    overall score.</span></span>
<span id="cb6-505"><a href="#cb6-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-506"><a href="#cb6-506" aria-hidden="true" tabindex="-1"></a><span class="st">    Selection</span></span>
<span id="cb6-507"><a href="#cb6-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-508"><a href="#cb6-508" aria-hidden="true" tabindex="-1"></a><span class="st">    With each series there may be a defined set of scoring intervals giving the</span></span>
<span id="cb6-509"><a href="#cb6-509" aria-hidden="true" tabindex="-1"></a><span class="st">    intervals of time over which zero or more ground-truth events might be</span></span>
<span id="cb6-510"><a href="#cb6-510" aria-hidden="true" tabindex="-1"></a><span class="st">    annotated in that series. A prediction will be evaluated only if it falls</span></span>
<span id="cb6-511"><a href="#cb6-511" aria-hidden="true" tabindex="-1"></a><span class="st">    within a scoring interval. These scoring intervals can be chosen to improve</span></span>
<span id="cb6-512"><a href="#cb6-512" aria-hidden="true" tabindex="-1"></a><span class="st">    the fairness of evaluation by, for instance, ignoring edge-cases or</span></span>
<span id="cb6-513"><a href="#cb6-513" aria-hidden="true" tabindex="-1"></a><span class="st">    ambiguous events.</span></span>
<span id="cb6-514"><a href="#cb6-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-515"><a href="#cb6-515" aria-hidden="true" tabindex="-1"></a><span class="st">    It is recommended that, if used, scoring intervals be provided for training</span></span>
<span id="cb6-516"><a href="#cb6-516" aria-hidden="true" tabindex="-1"></a><span class="st">    data but not test data.</span></span>
<span id="cb6-517"><a href="#cb6-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-518"><a href="#cb6-518" aria-hidden="true" tabindex="-1"></a><span class="st">    Assignment</span></span>
<span id="cb6-519"><a href="#cb6-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-520"><a href="#cb6-520" aria-hidden="true" tabindex="-1"></a><span class="st">    For each set of predictions and ground-truths within the same `event x</span></span>
<span id="cb6-521"><a href="#cb6-521" aria-hidden="true" tabindex="-1"></a><span class="st">    tolerance x series_id` group, we match each ground-truth to the</span></span>
<span id="cb6-522"><a href="#cb6-522" aria-hidden="true" tabindex="-1"></a><span class="st">    highest-confidence unmatched prediction occurring within the allowed</span></span>
<span id="cb6-523"><a href="#cb6-523" aria-hidden="true" tabindex="-1"></a><span class="st">    tolerance.</span></span>
<span id="cb6-524"><a href="#cb6-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-525"><a href="#cb6-525" aria-hidden="true" tabindex="-1"></a><span class="st">    Some ground-truths may not be matched to a prediction and some predictions</span></span>
<span id="cb6-526"><a href="#cb6-526" aria-hidden="true" tabindex="-1"></a><span class="st">    may not be matched to a ground-truth. They will still be accounted for in</span></span>
<span id="cb6-527"><a href="#cb6-527" aria-hidden="true" tabindex="-1"></a><span class="st">    the scoring, however.</span></span>
<span id="cb6-528"><a href="#cb6-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-529"><a href="#cb6-529" aria-hidden="true" tabindex="-1"></a><span class="st">    Scoring</span></span>
<span id="cb6-530"><a href="#cb6-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-531"><a href="#cb6-531" aria-hidden="true" tabindex="-1"></a><span class="st">    Collecting the events within each `series_id`, we compute an Average</span></span>
<span id="cb6-532"><a href="#cb6-532" aria-hidden="true" tabindex="-1"></a><span class="st">    Precision score for each `event x tolerance` group. The average precision</span></span>
<span id="cb6-533"><a href="#cb6-533" aria-hidden="true" tabindex="-1"></a><span class="st">    score is the area under the (step-wise) precision-recall curve generated by</span></span>
<span id="cb6-534"><a href="#cb6-534" aria-hidden="true" tabindex="-1"></a><span class="st">    decreasing confidence score thresholds over the predictions. In this</span></span>
<span id="cb6-535"><a href="#cb6-535" aria-hidden="true" tabindex="-1"></a><span class="st">    calculation, matched predictions over the threshold are scored as TP and</span></span>
<span id="cb6-536"><a href="#cb6-536" aria-hidden="true" tabindex="-1"></a><span class="st">    unmatched predictions as FP. Unmatched ground-truths are scored as FN.</span></span>
<span id="cb6-537"><a href="#cb6-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-538"><a href="#cb6-538" aria-hidden="true" tabindex="-1"></a><span class="st">    Reduction</span></span>
<span id="cb6-539"><a href="#cb6-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-540"><a href="#cb6-540" aria-hidden="true" tabindex="-1"></a><span class="st">    The final score is the average of the above AP scores, first averaged over</span></span>
<span id="cb6-541"><a href="#cb6-541" aria-hidden="true" tabindex="-1"></a><span class="st">    tolerance, then over event.</span></span>
<span id="cb6-542"><a href="#cb6-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-543"><a href="#cb6-543" aria-hidden="true" tabindex="-1"></a><span class="st">    Parameters</span></span>
<span id="cb6-544"><a href="#cb6-544" aria-hidden="true" tabindex="-1"></a><span class="st">    ----------</span></span>
<span id="cb6-545"><a href="#cb6-545" aria-hidden="true" tabindex="-1"></a><span class="st">    solution : pd.DataFrame, with columns:</span></span>
<span id="cb6-546"><a href="#cb6-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-547"><a href="#cb6-547" aria-hidden="true" tabindex="-1"></a><span class="st">        `series_id_column_name` identifier for each time series</span></span>
<span id="cb6-548"><a href="#cb6-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-549"><a href="#cb6-549" aria-hidden="true" tabindex="-1"></a><span class="st">        `time_column_name` the time of occurence for each event as a numeric type</span></span>
<span id="cb6-550"><a href="#cb6-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-551"><a href="#cb6-551" aria-hidden="true" tabindex="-1"></a><span class="st">        `event_column_name` class label for each event</span></span>
<span id="cb6-552"><a href="#cb6-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-553"><a href="#cb6-553" aria-hidden="true" tabindex="-1"></a><span class="st">        The solution contains the time of occurence of one or more types of</span></span>
<span id="cb6-554"><a href="#cb6-554" aria-hidden="true" tabindex="-1"></a><span class="st">        event within one or more time series. The metric expects the solution to</span></span>
<span id="cb6-555"><a href="#cb6-555" aria-hidden="true" tabindex="-1"></a><span class="st">        contain the same event types as those given in `tolerances`.</span></span>
<span id="cb6-556"><a href="#cb6-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-557"><a href="#cb6-557" aria-hidden="true" tabindex="-1"></a><span class="st">        When `use_scoring_intervals == True`, you may include `start` and `end`</span></span>
<span id="cb6-558"><a href="#cb6-558" aria-hidden="true" tabindex="-1"></a><span class="st">        events to delimit intervals within which detections will be scored.</span></span>
<span id="cb6-559"><a href="#cb6-559" aria-hidden="true" tabindex="-1"></a><span class="st">        Detected events (from the user submission) outside of these events will</span></span>
<span id="cb6-560"><a href="#cb6-560" aria-hidden="true" tabindex="-1"></a><span class="st">        be ignored.</span></span>
<span id="cb6-561"><a href="#cb6-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-562"><a href="#cb6-562" aria-hidden="true" tabindex="-1"></a><span class="st">    submission : pd.DataFrame, with columns as above and in addition:</span></span>
<span id="cb6-563"><a href="#cb6-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-564"><a href="#cb6-564" aria-hidden="true" tabindex="-1"></a><span class="st">        `score_column_name` the predicted confidence score for the detected event</span></span>
<span id="cb6-565"><a href="#cb6-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-566"><a href="#cb6-566" aria-hidden="true" tabindex="-1"></a><span class="st">    tolerances : Dict[str, List[float]]</span></span>
<span id="cb6-567"><a href="#cb6-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-568"><a href="#cb6-568" aria-hidden="true" tabindex="-1"></a><span class="st">        Maps each event class to a list of timestamp tolerances used</span></span>
<span id="cb6-569"><a href="#cb6-569" aria-hidden="true" tabindex="-1"></a><span class="st">        for matching detections to ground-truth events.</span></span>
<span id="cb6-570"><a href="#cb6-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-571"><a href="#cb6-571" aria-hidden="true" tabindex="-1"></a><span class="st">    use_scoring_intervals: bool, default False</span></span>
<span id="cb6-572"><a href="#cb6-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-573"><a href="#cb6-573" aria-hidden="true" tabindex="-1"></a><span class="st">        Whether to ignore predicted events outside intervals delimited</span></span>
<span id="cb6-574"><a href="#cb6-574" aria-hidden="true" tabindex="-1"></a><span class="st">        by `'start'` and `'end'` events in the solution. When `False`,</span></span>
<span id="cb6-575"><a href="#cb6-575" aria-hidden="true" tabindex="-1"></a><span class="st">        the solution should not include `'start'` and `'end'` events.</span></span>
<span id="cb6-576"><a href="#cb6-576" aria-hidden="true" tabindex="-1"></a><span class="st">        See the examples for illustration.</span></span>
<span id="cb6-577"><a href="#cb6-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-578"><a href="#cb6-578" aria-hidden="true" tabindex="-1"></a><span class="st">    Returns</span></span>
<span id="cb6-579"><a href="#cb6-579" aria-hidden="true" tabindex="-1"></a><span class="st">    -------</span></span>
<span id="cb6-580"><a href="#cb6-580" aria-hidden="true" tabindex="-1"></a><span class="st">    event_detection_ap : float</span></span>
<span id="cb6-581"><a href="#cb6-581" aria-hidden="true" tabindex="-1"></a><span class="st">        The mean average precision of the detected events.</span></span>
<span id="cb6-582"><a href="#cb6-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-583"><a href="#cb6-583" aria-hidden="true" tabindex="-1"></a><span class="st">    Examples</span></span>
<span id="cb6-584"><a href="#cb6-584" aria-hidden="true" tabindex="-1"></a><span class="st">    --------</span></span>
<span id="cb6-585"><a href="#cb6-585" aria-hidden="true" tabindex="-1"></a><span class="st">    Detecting `'pass'` events in football:</span></span>
<span id="cb6-586"><a href="#cb6-586" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; column_names = {</span></span>
<span id="cb6-587"><a href="#cb6-587" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'series_id_column_name': 'video_id',</span></span>
<span id="cb6-588"><a href="#cb6-588" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time_column_name': 'time',</span></span>
<span id="cb6-589"><a href="#cb6-589" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event_column_name': 'event',</span></span>
<span id="cb6-590"><a href="#cb6-590" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'score_column_name': 'score',</span></span>
<span id="cb6-591"><a href="#cb6-591" aria-hidden="true" tabindex="-1"></a><span class="st">    ... }</span></span>
<span id="cb6-592"><a href="#cb6-592" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; tolerances = {'pass': [1.0]}</span></span>
<span id="cb6-593"><a href="#cb6-593" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; solution = pd.DataFrame({</span></span>
<span id="cb6-594"><a href="#cb6-594" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'video_id': ['a', 'a'],</span></span>
<span id="cb6-595"><a href="#cb6-595" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event': ['pass', 'pass'],</span></span>
<span id="cb6-596"><a href="#cb6-596" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time': [0, 15],</span></span>
<span id="cb6-597"><a href="#cb6-597" aria-hidden="true" tabindex="-1"></a><span class="st">    ... })</span></span>
<span id="cb6-598"><a href="#cb6-598" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; submission = pd.DataFrame({</span></span>
<span id="cb6-599"><a href="#cb6-599" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'video_id': ['a', 'a', 'a'],</span></span>
<span id="cb6-600"><a href="#cb6-600" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event': ['pass', 'pass', 'pass'],</span></span>
<span id="cb6-601"><a href="#cb6-601" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'score': [1.0, 0.5, 1.0],</span></span>
<span id="cb6-602"><a href="#cb6-602" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time': [0, 10, 14.5],</span></span>
<span id="cb6-603"><a href="#cb6-603" aria-hidden="true" tabindex="-1"></a><span class="st">    ... })</span></span>
<span id="cb6-604"><a href="#cb6-604" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb6-605"><a href="#cb6-605" aria-hidden="true" tabindex="-1"></a><span class="st">    1.0</span></span>
<span id="cb6-606"><a href="#cb6-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-607"><a href="#cb6-607" aria-hidden="true" tabindex="-1"></a><span class="st">    Increasing the confidence score of the false detection above the true</span></span>
<span id="cb6-608"><a href="#cb6-608" aria-hidden="true" tabindex="-1"></a><span class="st">    detections decreases the AP.</span></span>
<span id="cb6-609"><a href="#cb6-609" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; submission.loc[1, 'score'] = 1.5</span></span>
<span id="cb6-610"><a href="#cb6-610" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb6-611"><a href="#cb6-611" aria-hidden="true" tabindex="-1"></a><span class="st">    0.6666666666666666...</span></span>
<span id="cb6-612"><a href="#cb6-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-613"><a href="#cb6-613" aria-hidden="true" tabindex="-1"></a><span class="st">    Likewise, decreasing the confidence score of a true detection below the</span></span>
<span id="cb6-614"><a href="#cb6-614" aria-hidden="true" tabindex="-1"></a><span class="st">    false detection also decreases the AP.</span></span>
<span id="cb6-615"><a href="#cb6-615" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; submission.loc[1, 'score'] = 0.5  # reset</span></span>
<span id="cb6-616"><a href="#cb6-616" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; submission.loc[0, 'score'] = 0.0</span></span>
<span id="cb6-617"><a href="#cb6-617" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb6-618"><a href="#cb6-618" aria-hidden="true" tabindex="-1"></a><span class="st">    0.8333333333333333...</span></span>
<span id="cb6-619"><a href="#cb6-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-620"><a href="#cb6-620" aria-hidden="true" tabindex="-1"></a><span class="st">    We average AP scores over tolerances. Previously, the detection at 14.5</span></span>
<span id="cb6-621"><a href="#cb6-621" aria-hidden="true" tabindex="-1"></a><span class="st">    would match, but adding smaller tolerances gives AP scores where it does</span></span>
<span id="cb6-622"><a href="#cb6-622" aria-hidden="true" tabindex="-1"></a><span class="st">    not match. This results in both a FN, since the ground-truth wasn't</span></span>
<span id="cb6-623"><a href="#cb6-623" aria-hidden="true" tabindex="-1"></a><span class="st">    detected, and a FP, since the detected event matches no ground-truth.</span></span>
<span id="cb6-624"><a href="#cb6-624" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; tolerances = {'pass': [0.1, 0.2, 1.0]}</span></span>
<span id="cb6-625"><a href="#cb6-625" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb6-626"><a href="#cb6-626" aria-hidden="true" tabindex="-1"></a><span class="st">    0.3888888888888888...</span></span>
<span id="cb6-627"><a href="#cb6-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-628"><a href="#cb6-628" aria-hidden="true" tabindex="-1"></a><span class="st">    We also average over time series and over event classes.</span></span>
<span id="cb6-629"><a href="#cb6-629" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; tolerances = {'pass': [0.5, 1.0], 'challenge': [0.25, 0.50]}</span></span>
<span id="cb6-630"><a href="#cb6-630" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; solution = pd.DataFrame({</span></span>
<span id="cb6-631"><a href="#cb6-631" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'video_id': ['a', 'a', 'b'],</span></span>
<span id="cb6-632"><a href="#cb6-632" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event': ['pass', 'challenge', 'pass'],</span></span>
<span id="cb6-633"><a href="#cb6-633" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time': [0, 15, 0],  # restart time for new time series b</span></span>
<span id="cb6-634"><a href="#cb6-634" aria-hidden="true" tabindex="-1"></a><span class="st">    ... })</span></span>
<span id="cb6-635"><a href="#cb6-635" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; submission = pd.DataFrame({</span></span>
<span id="cb6-636"><a href="#cb6-636" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'video_id': ['a', 'a', 'b'],</span></span>
<span id="cb6-637"><a href="#cb6-637" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event': ['pass', 'challenge', 'pass'],</span></span>
<span id="cb6-638"><a href="#cb6-638" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'score': [1.0, 0.5, 1.0],</span></span>
<span id="cb6-639"><a href="#cb6-639" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time': [0, 15, 0],</span></span>
<span id="cb6-640"><a href="#cb6-640" aria-hidden="true" tabindex="-1"></a><span class="st">    ... })</span></span>
<span id="cb6-641"><a href="#cb6-641" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb6-642"><a href="#cb6-642" aria-hidden="true" tabindex="-1"></a><span class="st">    1.0</span></span>
<span id="cb6-643"><a href="#cb6-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-644"><a href="#cb6-644" aria-hidden="true" tabindex="-1"></a><span class="st">    By adding scoring intervals to the solution, we may choose to ignore</span></span>
<span id="cb6-645"><a href="#cb6-645" aria-hidden="true" tabindex="-1"></a><span class="st">    detections outside of those intervals.</span></span>
<span id="cb6-646"><a href="#cb6-646" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; tolerances = {'pass': [1.0]}</span></span>
<span id="cb6-647"><a href="#cb6-647" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; solution = pd.DataFrame({</span></span>
<span id="cb6-648"><a href="#cb6-648" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'video_id': ['a', 'a', 'a', 'a'],</span></span>
<span id="cb6-649"><a href="#cb6-649" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event': ['start', 'pass', 'pass', 'end'],</span></span>
<span id="cb6-650"><a href="#cb6-650" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time': [0, 10, 20, 30],</span></span>
<span id="cb6-651"><a href="#cb6-651" aria-hidden="true" tabindex="-1"></a><span class="st">    ... })</span></span>
<span id="cb6-652"><a href="#cb6-652" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; submission = pd.DataFrame({</span></span>
<span id="cb6-653"><a href="#cb6-653" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'video_id': ['a', 'a', 'a'],</span></span>
<span id="cb6-654"><a href="#cb6-654" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'event': ['pass', 'pass', 'pass'],</span></span>
<span id="cb6-655"><a href="#cb6-655" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'score': [1.0, 1.0, 1.0],</span></span>
<span id="cb6-656"><a href="#cb6-656" aria-hidden="true" tabindex="-1"></a><span class="st">    ...     'time': [10, 20, 40],</span></span>
<span id="cb6-657"><a href="#cb6-657" aria-hidden="true" tabindex="-1"></a><span class="st">    ... })</span></span>
<span id="cb6-658"><a href="#cb6-658" aria-hidden="true" tabindex="-1"></a><span class="st">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names, use_scoring_intervals=True)</span></span>
<span id="cb6-659"><a href="#cb6-659" aria-hidden="true" tabindex="-1"></a><span class="st">    1.0</span></span>
<span id="cb6-660"><a href="#cb6-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-661"><a href="#cb6-661" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb6-662"><a href="#cb6-662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate metric parameters</span></span>
<span id="cb6-663"><a href="#cb6-663" aria-hidden="true" tabindex="-1"></a>    assert <span class="fu">len</span>(tolerances) <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"Events must have defined tolerances."</span></span>
<span id="cb6-664"><a href="#cb6-664" aria-hidden="true" tabindex="-1"></a>    assert <span class="fu">set</span>(<span class="fu">tolerances.keys</span>()) <span class="sc">==</span> <span class="fu">set</span>(solution[event_column_name])<span class="fu">.difference</span>({<span class="st">'start'</span>, <span class="st">'end'</span>}),\</span>
<span id="cb6-665"><a href="#cb6-665" aria-hidden="true" tabindex="-1"></a>        (f<span class="st">"Solution column {event_column_name} must contain the same events "</span></span>
<span id="cb6-666"><a href="#cb6-666" aria-hidden="true" tabindex="-1"></a>         <span class="st">"as defined in tolerances."</span>)</span>
<span id="cb6-667"><a href="#cb6-667" aria-hidden="true" tabindex="-1"></a>    assert <span class="fu">pd.api.types.is_numeric_dtype</span>(solution[time_column_name]),\</span>
<span id="cb6-668"><a href="#cb6-668" aria-hidden="true" tabindex="-1"></a>        f<span class="st">"Solution column {time_column_name} must be of numeric type."</span></span>
<span id="cb6-669"><a href="#cb6-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-670"><a href="#cb6-670" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate submission format</span></span>
<span id="cb6-671"><a href="#cb6-671" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> column_name <span class="cf">in</span> [</span>
<span id="cb6-672"><a href="#cb6-672" aria-hidden="true" tabindex="-1"></a>        series_id_column_name,</span>
<span id="cb6-673"><a href="#cb6-673" aria-hidden="true" tabindex="-1"></a>        time_column_name,</span>
<span id="cb6-674"><a href="#cb6-674" aria-hidden="true" tabindex="-1"></a>        event_column_name,</span>
<span id="cb6-675"><a href="#cb6-675" aria-hidden="true" tabindex="-1"></a>        score_column_name,</span>
<span id="cb6-676"><a href="#cb6-676" aria-hidden="true" tabindex="-1"></a>    ]<span class="sc">:</span></span>
<span id="cb6-677"><a href="#cb6-677" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> column_name not <span class="cf">in</span> submission.columns<span class="sc">:</span></span>
<span id="cb6-678"><a href="#cb6-678" aria-hidden="true" tabindex="-1"></a>            raise <span class="fu">ParticipantVisibleError</span>(f<span class="st">"Submission must have column '{column_name}'."</span>)</span>
<span id="cb6-679"><a href="#cb6-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-680"><a href="#cb6-680" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> not <span class="fu">pd.api.types.is_numeric_dtype</span>(submission[time_column_name])<span class="sc">:</span></span>
<span id="cb6-681"><a href="#cb6-681" aria-hidden="true" tabindex="-1"></a>        raise <span class="fu">ParticipantVisibleError</span>(</span>
<span id="cb6-682"><a href="#cb6-682" aria-hidden="true" tabindex="-1"></a>            f<span class="st">"Submission column '{time_column_name}' must be of numeric type."</span></span>
<span id="cb6-683"><a href="#cb6-683" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-684"><a href="#cb6-684" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> not <span class="fu">pd.api.types.is_numeric_dtype</span>(submission[score_column_name])<span class="sc">:</span></span>
<span id="cb6-685"><a href="#cb6-685" aria-hidden="true" tabindex="-1"></a>        raise <span class="fu">ParticipantVisibleError</span>(</span>
<span id="cb6-686"><a href="#cb6-686" aria-hidden="true" tabindex="-1"></a>            f<span class="st">"Submission column '{score_column_name}' must be of numeric type."</span></span>
<span id="cb6-687"><a href="#cb6-687" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-688"><a href="#cb6-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-689"><a href="#cb6-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set these globally to avoid passing around a bunch of arguments</span></span>
<span id="cb6-690"><a href="#cb6-690" aria-hidden="true" tabindex="-1"></a>    <span class="fu">globals</span>()[<span class="st">'series_id_column_name'</span>] <span class="ot">=</span> series_id_column_name</span>
<span id="cb6-691"><a href="#cb6-691" aria-hidden="true" tabindex="-1"></a>    <span class="fu">globals</span>()[<span class="st">'time_column_name'</span>] <span class="ot">=</span> time_column_name</span>
<span id="cb6-692"><a href="#cb6-692" aria-hidden="true" tabindex="-1"></a>    <span class="fu">globals</span>()[<span class="st">'event_column_name'</span>] <span class="ot">=</span> event_column_name</span>
<span id="cb6-693"><a href="#cb6-693" aria-hidden="true" tabindex="-1"></a>    <span class="fu">globals</span>()[<span class="st">'score_column_name'</span>] <span class="ot">=</span> score_column_name</span>
<span id="cb6-694"><a href="#cb6-694" aria-hidden="true" tabindex="-1"></a>    <span class="fu">globals</span>()[<span class="st">'use_scoring_intervals'</span>] <span class="ot">=</span> use_scoring_intervals</span>
<span id="cb6-695"><a href="#cb6-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-696"><a href="#cb6-696" aria-hidden="true" tabindex="-1"></a>    return <span class="fu">event_detection_ap</span>(solution, submission, tolerances)</span>
<span id="cb6-697"><a href="#cb6-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-698"><a href="#cb6-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-699"><a href="#cb6-699" aria-hidden="true" tabindex="-1"></a>def <span class="fu">filter_detections</span>(</span>
<span id="cb6-700"><a href="#cb6-700" aria-hidden="true" tabindex="-1"></a>        detections<span class="sc">:</span> pd.DataFrame, intervals<span class="sc">:</span> pd.DataFrame</span>
<span id="cb6-701"><a href="#cb6-701" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> pd.DataFrame<span class="sc">:</span></span>
<span id="cb6-702"><a href="#cb6-702" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""Drop detections not inside a scoring interval."""</span></span>
<span id="cb6-703"><a href="#cb6-703" aria-hidden="true" tabindex="-1"></a>    detection_time <span class="ot">=</span> detections.loc[<span class="sc">:</span>, time_column_name]<span class="fu">.sort_values</span>()<span class="fu">.to_numpy</span>()</span>
<span id="cb6-704"><a href="#cb6-704" aria-hidden="true" tabindex="-1"></a>    intervals <span class="ot">=</span> <span class="fu">intervals.to_numpy</span>()</span>
<span id="cb6-705"><a href="#cb6-705" aria-hidden="true" tabindex="-1"></a>    is_scored <span class="ot">=</span> <span class="fu">np.full_like</span>(detection_time, False, <span class="at">dtype=</span>bool)</span>
<span id="cb6-706"><a href="#cb6-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-707"><a href="#cb6-707" aria-hidden="true" tabindex="-1"></a>    i, j <span class="ot">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb6-708"><a href="#cb6-708" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="sc">&lt;</span> <span class="fu">len</span>(detection_time) and j <span class="sc">&lt;</span> <span class="fu">len</span>(intervals)<span class="sc">:</span></span>
<span id="cb6-709"><a href="#cb6-709" aria-hidden="true" tabindex="-1"></a>        time <span class="ot">=</span> detection_time[i]</span>
<span id="cb6-710"><a href="#cb6-710" aria-hidden="true" tabindex="-1"></a>        int_ <span class="ot">=</span> intervals[j]</span>
<span id="cb6-711"><a href="#cb6-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-712"><a href="#cb6-712" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the detection is prior in time to the interval, go to the next detection.</span></span>
<span id="cb6-713"><a href="#cb6-713" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> time <span class="sc">&lt;</span> int_.left<span class="sc">:</span></span>
<span id="cb6-714"><a href="#cb6-714" aria-hidden="true" tabindex="-1"></a>            i <span class="sc">+</span><span class="er">=</span> <span class="dv">1</span></span>
<span id="cb6-715"><a href="#cb6-715" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the detection is inside the interval, keep it and go to the next detection.</span></span>
<span id="cb6-716"><a href="#cb6-716" aria-hidden="true" tabindex="-1"></a>        elif time <span class="cf">in</span> int_<span class="sc">:</span></span>
<span id="cb6-717"><a href="#cb6-717" aria-hidden="true" tabindex="-1"></a>            is_scored[i] <span class="ot">=</span> True</span>
<span id="cb6-718"><a href="#cb6-718" aria-hidden="true" tabindex="-1"></a>            i <span class="sc">+</span><span class="er">=</span> <span class="dv">1</span></span>
<span id="cb6-719"><a href="#cb6-719" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the detection is later in time, go to the next interval.</span></span>
<span id="cb6-720"><a href="#cb6-720" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span><span class="sc">:</span></span>
<span id="cb6-721"><a href="#cb6-721" aria-hidden="true" tabindex="-1"></a>            j <span class="sc">+</span><span class="er">=</span> <span class="dv">1</span></span>
<span id="cb6-722"><a href="#cb6-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-723"><a href="#cb6-723" aria-hidden="true" tabindex="-1"></a>    return detections.loc[is_scored]<span class="fu">.reset_index</span>(<span class="at">drop=</span>True)</span>
<span id="cb6-724"><a href="#cb6-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-725"><a href="#cb6-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-726"><a href="#cb6-726" aria-hidden="true" tabindex="-1"></a>def <span class="fu">match_detections</span>(</span>
<span id="cb6-727"><a href="#cb6-727" aria-hidden="true" tabindex="-1"></a>        tolerance<span class="sc">:</span> float, ground_truths<span class="sc">:</span> pd.DataFrame, detections<span class="sc">:</span> pd.DataFrame</span>
<span id="cb6-728"><a href="#cb6-728" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> pd.DataFrame<span class="sc">:</span></span>
<span id="cb6-729"><a href="#cb6-729" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""Match detections to ground truth events. Arguments are taken from a common event x tolerance x series_id evaluation group."""</span></span>
<span id="cb6-730"><a href="#cb6-730" aria-hidden="true" tabindex="-1"></a>    detections_sorted <span class="ot">=</span> <span class="fu">detections.sort_values</span>(score_column_name, <span class="at">ascending=</span>False)<span class="fu">.dropna</span>()</span>
<span id="cb6-731"><a href="#cb6-731" aria-hidden="true" tabindex="-1"></a>    is_matched <span class="ot">=</span> <span class="fu">np.full_like</span>(detections_sorted[event_column_name], False, <span class="at">dtype=</span>bool)</span>
<span id="cb6-732"><a href="#cb6-732" aria-hidden="true" tabindex="-1"></a>    gts_matched <span class="ot">=</span> <span class="fu">set</span>()</span>
<span id="cb6-733"><a href="#cb6-733" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, det <span class="cf">in</span> <span class="fu">enumerate</span>(<span class="fu">detections_sorted.itertuples</span>(<span class="at">index=</span>False))<span class="sc">:</span></span>
<span id="cb6-734"><a href="#cb6-734" aria-hidden="true" tabindex="-1"></a>        best_error <span class="ot">=</span> tolerance</span>
<span id="cb6-735"><a href="#cb6-735" aria-hidden="true" tabindex="-1"></a>        best_gt <span class="ot">=</span> None</span>
<span id="cb6-736"><a href="#cb6-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-737"><a href="#cb6-737" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gt <span class="cf">in</span> <span class="fu">ground_truths.itertuples</span>(<span class="at">index=</span>False)<span class="sc">:</span></span>
<span id="cb6-738"><a href="#cb6-738" aria-hidden="true" tabindex="-1"></a>            error <span class="ot">=</span> <span class="fu">abs</span>(<span class="fu">getattr</span>(det, time_column_name) <span class="sc">-</span> <span class="fu">getattr</span>(gt, time_column_name))</span>
<span id="cb6-739"><a href="#cb6-739" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> error <span class="sc">&lt;</span> best_error and gt not <span class="cf">in</span> gts_matched<span class="sc">:</span></span>
<span id="cb6-740"><a href="#cb6-740" aria-hidden="true" tabindex="-1"></a>                best_gt <span class="ot">=</span> gt</span>
<span id="cb6-741"><a href="#cb6-741" aria-hidden="true" tabindex="-1"></a>                best_error <span class="ot">=</span> error</span>
<span id="cb6-742"><a href="#cb6-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-743"><a href="#cb6-743" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> best_gt is not None<span class="sc">:</span></span>
<span id="cb6-744"><a href="#cb6-744" aria-hidden="true" tabindex="-1"></a>            is_matched[i] <span class="ot">=</span> True</span>
<span id="cb6-745"><a href="#cb6-745" aria-hidden="true" tabindex="-1"></a>            <span class="fu">gts_matched.add</span>(best_gt)</span>
<span id="cb6-746"><a href="#cb6-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-747"><a href="#cb6-747" aria-hidden="true" tabindex="-1"></a>    detections_sorted[<span class="st">'matched'</span>] <span class="ot">=</span> is_matched</span>
<span id="cb6-748"><a href="#cb6-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-749"><a href="#cb6-749" aria-hidden="true" tabindex="-1"></a>    return detections_sorted</span>
<span id="cb6-750"><a href="#cb6-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-751"><a href="#cb6-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-752"><a href="#cb6-752" aria-hidden="true" tabindex="-1"></a>def <span class="fu">precision_recall_curve</span>(</span>
<span id="cb6-753"><a href="#cb6-753" aria-hidden="true" tabindex="-1"></a>        matches<span class="sc">:</span> np.ndarray, scores<span class="sc">:</span> np.ndarray, p<span class="sc">:</span> int</span>
<span id="cb6-754"><a href="#cb6-754" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> Tuple[np.ndarray, np.ndarray, np.ndarray]<span class="sc">:</span></span>
<span id="cb6-755"><a href="#cb6-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">len</span>(matches) <span class="sc">==</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb6-756"><a href="#cb6-756" aria-hidden="true" tabindex="-1"></a>        return [<span class="dv">1</span>], [<span class="dv">0</span>], []</span>
<span id="cb6-757"><a href="#cb6-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-758"><a href="#cb6-758" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort matches by decreasing confidence</span></span>
<span id="cb6-759"><a href="#cb6-759" aria-hidden="true" tabindex="-1"></a>    idxs <span class="ot">=</span> <span class="fu">np.argsort</span>(scores, <span class="at">kind=</span><span class="st">'stable'</span>)[<span class="sc">::-</span><span class="dv">1</span>]</span>
<span id="cb6-760"><a href="#cb6-760" aria-hidden="true" tabindex="-1"></a>    scores <span class="ot">=</span> scores[idxs]</span>
<span id="cb6-761"><a href="#cb6-761" aria-hidden="true" tabindex="-1"></a>    matches <span class="ot">=</span> matches[idxs]</span>
<span id="cb6-762"><a href="#cb6-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-763"><a href="#cb6-763" aria-hidden="true" tabindex="-1"></a>    distinct_value_indices <span class="ot">=</span> <span class="fu">np.where</span>(<span class="fu">np.diff</span>(scores))[<span class="dv">0</span>]</span>
<span id="cb6-764"><a href="#cb6-764" aria-hidden="true" tabindex="-1"></a>    threshold_idxs <span class="ot">=</span> np.r_[distinct_value_indices, matches.size <span class="sc">-</span> <span class="dv">1</span>]</span>
<span id="cb6-765"><a href="#cb6-765" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="ot">=</span> scores[threshold_idxs]</span>
<span id="cb6-766"><a href="#cb6-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-767"><a href="#cb6-767" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matches become TPs and non-matches FPs as confidence threshold decreases</span></span>
<span id="cb6-768"><a href="#cb6-768" aria-hidden="true" tabindex="-1"></a>    tps <span class="ot">=</span> <span class="fu">np.cumsum</span>(matches)[threshold_idxs]</span>
<span id="cb6-769"><a href="#cb6-769" aria-hidden="true" tabindex="-1"></a>    fps <span class="ot">=</span> <span class="fu">np.cumsum</span>(<span class="sc">~</span>matches)[threshold_idxs]</span>
<span id="cb6-770"><a href="#cb6-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-771"><a href="#cb6-771" aria-hidden="true" tabindex="-1"></a>    precision <span class="ot">=</span> tps <span class="sc">/</span> (tps <span class="sc">+</span> fps)</span>
<span id="cb6-772"><a href="#cb6-772" aria-hidden="true" tabindex="-1"></a>    precision[<span class="fu">np.isnan</span>(precision)] <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb6-773"><a href="#cb6-773" aria-hidden="true" tabindex="-1"></a>    recall <span class="ot">=</span> tps <span class="sc">/</span> p  <span class="co"># total number of ground truths might be different than total number of matches</span></span>
<span id="cb6-774"><a href="#cb6-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-775"><a href="#cb6-775" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stop when full recall attained and reverse the outputs so recall is non-increasing.</span></span>
<span id="cb6-776"><a href="#cb6-776" aria-hidden="true" tabindex="-1"></a>    last_ind <span class="ot">=</span> <span class="fu">tps.searchsorted</span>(tps[<span class="sc">-</span><span class="dv">1</span>])</span>
<span id="cb6-777"><a href="#cb6-777" aria-hidden="true" tabindex="-1"></a>    sl <span class="ot">=</span> <span class="fu">slice</span>(last_ind, None, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb6-778"><a href="#cb6-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-779"><a href="#cb6-779" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final precision is 1 and final recall is 0</span></span>
<span id="cb6-780"><a href="#cb6-780" aria-hidden="true" tabindex="-1"></a>    return np.r_[precision[sl], <span class="dv">1</span>], np.r_[recall[sl], <span class="dv">0</span>], thresholds[sl]</span>
<span id="cb6-781"><a href="#cb6-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-782"><a href="#cb6-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-783"><a href="#cb6-783" aria-hidden="true" tabindex="-1"></a>def <span class="fu">average_precision_score</span>(matches<span class="sc">:</span> np.ndarray, scores<span class="sc">:</span> np.ndarray, p<span class="sc">:</span> int) <span class="ot">-&gt;</span> float<span class="sc">:</span></span>
<span id="cb6-784"><a href="#cb6-784" aria-hidden="true" tabindex="-1"></a>    precision, recall, _ <span class="ot">=</span> <span class="fu">precision_recall_curve</span>(matches, scores, p)</span>
<span id="cb6-785"><a href="#cb6-785" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute step integral</span></span>
<span id="cb6-786"><a href="#cb6-786" aria-hidden="true" tabindex="-1"></a>    return <span class="sc">-</span><span class="fu">np.sum</span>(<span class="fu">np.diff</span>(recall) <span class="sc">*</span> <span class="fu">np.array</span>(precision)[<span class="sc">:-</span><span class="dv">1</span>])</span>
<span id="cb6-787"><a href="#cb6-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-788"><a href="#cb6-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-789"><a href="#cb6-789" aria-hidden="true" tabindex="-1"></a>def <span class="fu">event_detection_ap</span>(</span>
<span id="cb6-790"><a href="#cb6-790" aria-hidden="true" tabindex="-1"></a>        solution<span class="sc">:</span> pd.DataFrame,</span>
<span id="cb6-791"><a href="#cb6-791" aria-hidden="true" tabindex="-1"></a>        submission<span class="sc">:</span> pd.DataFrame,</span>
<span id="cb6-792"><a href="#cb6-792" aria-hidden="true" tabindex="-1"></a>        tolerances<span class="sc">:</span> Dict[str, List[float]],</span>
<span id="cb6-793"><a href="#cb6-793" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> float<span class="sc">:</span></span>
<span id="cb6-794"><a href="#cb6-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-795"><a href="#cb6-795" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure solution and submission are sorted properly</span></span>
<span id="cb6-796"><a href="#cb6-796" aria-hidden="true" tabindex="-1"></a>    solution <span class="ot">=</span> <span class="fu">solution.sort_values</span>([series_id_column_name, time_column_name])</span>
<span id="cb6-797"><a href="#cb6-797" aria-hidden="true" tabindex="-1"></a>    submission <span class="ot">=</span> <span class="fu">submission.sort_values</span>([series_id_column_name, time_column_name])</span>
<span id="cb6-798"><a href="#cb6-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-799"><a href="#cb6-799" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract scoring intervals.</span></span>
<span id="cb6-800"><a href="#cb6-800" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_scoring_intervals<span class="sc">:</span></span>
<span id="cb6-801"><a href="#cb6-801" aria-hidden="true" tabindex="-1"></a>        intervals <span class="ot">=</span> (</span>
<span id="cb6-802"><a href="#cb6-802" aria-hidden="true" tabindex="-1"></a>            solution</span>
<span id="cb6-803"><a href="#cb6-803" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.query</span>(<span class="st">"event in ['start', 'end']"</span>)</span>
<span id="cb6-804"><a href="#cb6-804" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.assign</span>(<span class="at">interval=</span>lambda x<span class="sc">:</span> <span class="fu">x.groupby</span>([series_id_column_name, event_column_name])<span class="fu">.cumcount</span>())</span>
<span id="cb6-805"><a href="#cb6-805" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.pivot</span>(</span>
<span id="cb6-806"><a href="#cb6-806" aria-hidden="true" tabindex="-1"></a>                <span class="at">index=</span><span class="st">'interval'</span>,</span>
<span id="cb6-807"><a href="#cb6-807" aria-hidden="true" tabindex="-1"></a>                <span class="at">columns=</span>[series_id_column_name, event_column_name],</span>
<span id="cb6-808"><a href="#cb6-808" aria-hidden="true" tabindex="-1"></a>                <span class="at">values=</span>time_column_name,</span>
<span id="cb6-809"><a href="#cb6-809" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-810"><a href="#cb6-810" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.stack</span>(series_id_column_name)</span>
<span id="cb6-811"><a href="#cb6-811" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.swaplevel</span>()</span>
<span id="cb6-812"><a href="#cb6-812" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.sort_index</span>()</span>
<span id="cb6-813"><a href="#cb6-813" aria-hidden="true" tabindex="-1"></a>            .loc[<span class="sc">:</span>, [<span class="st">'start'</span>, <span class="st">'end'</span>]]</span>
<span id="cb6-814"><a href="#cb6-814" aria-hidden="true" tabindex="-1"></a>            <span class="fu">.apply</span>(lambda x<span class="sc">:</span> <span class="fu">pd.Interval</span>(<span class="sc">*</span>x, <span class="at">closed=</span><span class="st">'both'</span>), <span class="at">axis=</span><span class="dv">1</span>)</span>
<span id="cb6-815"><a href="#cb6-815" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-816"><a href="#cb6-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-817"><a href="#cb6-817" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract ground-truth events.</span></span>
<span id="cb6-818"><a href="#cb6-818" aria-hidden="true" tabindex="-1"></a>    ground_truths <span class="ot">=</span> (</span>
<span id="cb6-819"><a href="#cb6-819" aria-hidden="true" tabindex="-1"></a>        solution</span>
<span id="cb6-820"><a href="#cb6-820" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.query</span>(<span class="st">"event not in ['start', 'end']"</span>)</span>
<span id="cb6-821"><a href="#cb6-821" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.reset_index</span>(<span class="at">drop=</span>True)</span>
<span id="cb6-822"><a href="#cb6-822" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-823"><a href="#cb6-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-824"><a href="#cb6-824" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map each event class to its prevalence (needed for recall calculation)</span></span>
<span id="cb6-825"><a href="#cb6-825" aria-hidden="true" tabindex="-1"></a>    class_counts <span class="ot">=</span> <span class="fu">ground_truths.value_counts</span>(event_column_name)<span class="fu">.to_dict</span>()</span>
<span id="cb6-826"><a href="#cb6-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-827"><a href="#cb6-827" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table for detections with a column indicating a match to a ground-truth event</span></span>
<span id="cb6-828"><a href="#cb6-828" aria-hidden="true" tabindex="-1"></a>    detections <span class="ot">=</span> <span class="fu">submission.assign</span>(<span class="at">matched =</span> False)</span>
<span id="cb6-829"><a href="#cb6-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-830"><a href="#cb6-830" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove detections outside of scoring intervals</span></span>
<span id="cb6-831"><a href="#cb6-831" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_scoring_intervals<span class="sc">:</span></span>
<span id="cb6-832"><a href="#cb6-832" aria-hidden="true" tabindex="-1"></a>        detections_filtered <span class="ot">=</span> []</span>
<span id="cb6-833"><a href="#cb6-833" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (det_group, dets), (int_group, ints) <span class="cf">in</span> <span class="fu">zip</span>(</span>
<span id="cb6-834"><a href="#cb6-834" aria-hidden="true" tabindex="-1"></a>            <span class="fu">detections.groupby</span>(series_id_column_name), <span class="fu">intervals.groupby</span>(series_id_column_name)</span>
<span id="cb6-835"><a href="#cb6-835" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">:</span></span>
<span id="cb6-836"><a href="#cb6-836" aria-hidden="true" tabindex="-1"></a>            assert det_group <span class="sc">==</span> int_group</span>
<span id="cb6-837"><a href="#cb6-837" aria-hidden="true" tabindex="-1"></a>            <span class="fu">detections_filtered.append</span>(<span class="fu">filter_detections</span>(dets, ints))</span>
<span id="cb6-838"><a href="#cb6-838" aria-hidden="true" tabindex="-1"></a>        detections_filtered <span class="ot">=</span> <span class="fu">pd.concat</span>(detections_filtered, <span class="at">ignore_index=</span>True)</span>
<span id="cb6-839"><a href="#cb6-839" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span><span class="sc">:</span></span>
<span id="cb6-840"><a href="#cb6-840" aria-hidden="true" tabindex="-1"></a>        detections_filtered <span class="ot">=</span> detections</span>
<span id="cb6-841"><a href="#cb6-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-842"><a href="#cb6-842" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table of event-class x tolerance x series_id values</span></span>
<span id="cb6-843"><a href="#cb6-843" aria-hidden="true" tabindex="-1"></a>    aggregation_keys <span class="ot">=</span> <span class="fu">pd.DataFrame</span>(</span>
<span id="cb6-844"><a href="#cb6-844" aria-hidden="true" tabindex="-1"></a>        [(ev, tol, vid)</span>
<span id="cb6-845"><a href="#cb6-845" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> ev <span class="cf">in</span> <span class="fu">tolerances.keys</span>()</span>
<span id="cb6-846"><a href="#cb6-846" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> tol <span class="cf">in</span> tolerances[ev]</span>
<span id="cb6-847"><a href="#cb6-847" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> vid <span class="cf">in</span> ground_truths[series_id_column_name]<span class="fu">.unique</span>()],</span>
<span id="cb6-848"><a href="#cb6-848" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns=</span>[event_column_name, <span class="st">'tolerance'</span>, series_id_column_name],</span>
<span id="cb6-849"><a href="#cb6-849" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-850"><a href="#cb6-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-851"><a href="#cb6-851" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create match evaluation groups: event-class x tolerance x series_id</span></span>
<span id="cb6-852"><a href="#cb6-852" aria-hidden="true" tabindex="-1"></a>    detections_grouped <span class="ot">=</span> (</span>
<span id="cb6-853"><a href="#cb6-853" aria-hidden="true" tabindex="-1"></a>        aggregation_keys</span>
<span id="cb6-854"><a href="#cb6-854" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.merge</span>(detections_filtered, <span class="at">on=</span>[event_column_name, series_id_column_name], <span class="at">how=</span><span class="st">'left'</span>)</span>
<span id="cb6-855"><a href="#cb6-855" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.groupby</span>([event_column_name, <span class="st">'tolerance'</span>, series_id_column_name])</span>
<span id="cb6-856"><a href="#cb6-856" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-857"><a href="#cb6-857" aria-hidden="true" tabindex="-1"></a>    ground_truths_grouped <span class="ot">=</span> (</span>
<span id="cb6-858"><a href="#cb6-858" aria-hidden="true" tabindex="-1"></a>        aggregation_keys</span>
<span id="cb6-859"><a href="#cb6-859" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.merge</span>(ground_truths, <span class="at">on=</span>[event_column_name, series_id_column_name], <span class="at">how=</span><span class="st">'left'</span>)</span>
<span id="cb6-860"><a href="#cb6-860" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.groupby</span>([event_column_name, <span class="st">'tolerance'</span>, series_id_column_name])</span>
<span id="cb6-861"><a href="#cb6-861" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-862"><a href="#cb6-862" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match detections to ground truth events by evaluation group</span></span>
<span id="cb6-863"><a href="#cb6-863" aria-hidden="true" tabindex="-1"></a>    detections_matched <span class="ot">=</span> []</span>
<span id="cb6-864"><a href="#cb6-864" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="cf">in</span> <span class="fu">aggregation_keys.itertuples</span>(<span class="at">index=</span>False)<span class="sc">:</span></span>
<span id="cb6-865"><a href="#cb6-865" aria-hidden="true" tabindex="-1"></a>        dets <span class="ot">=</span> <span class="fu">detections_grouped.get_group</span>(key)</span>
<span id="cb6-866"><a href="#cb6-866" aria-hidden="true" tabindex="-1"></a>        gts <span class="ot">=</span> <span class="fu">ground_truths_grouped.get_group</span>(key)</span>
<span id="cb6-867"><a href="#cb6-867" aria-hidden="true" tabindex="-1"></a>        <span class="fu">detections_matched.append</span>(</span>
<span id="cb6-868"><a href="#cb6-868" aria-hidden="true" tabindex="-1"></a>            <span class="fu">match_detections</span>(dets[<span class="st">'tolerance'</span>].iloc[<span class="dv">0</span>], gts, dets)</span>
<span id="cb6-869"><a href="#cb6-869" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-870"><a href="#cb6-870" aria-hidden="true" tabindex="-1"></a>    detections_matched <span class="ot">=</span> <span class="fu">pd.concat</span>(detections_matched)</span>
<span id="cb6-871"><a href="#cb6-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-872"><a href="#cb6-872" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute AP per event x tolerance group</span></span>
<span id="cb6-873"><a href="#cb6-873" aria-hidden="true" tabindex="-1"></a>    event_classes <span class="ot">=</span> ground_truths[event_column_name]<span class="fu">.unique</span>()</span>
<span id="cb6-874"><a href="#cb6-874" aria-hidden="true" tabindex="-1"></a>    ap_table <span class="ot">=</span> (</span>
<span id="cb6-875"><a href="#cb6-875" aria-hidden="true" tabindex="-1"></a>        detections_matched</span>
<span id="cb6-876"><a href="#cb6-876" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.query</span>(<span class="st">"event in @event_classes"</span>)</span>
<span id="cb6-877"><a href="#cb6-877" aria-hidden="true" tabindex="-1"></a>        <span class="fu">.groupby</span>([event_column_name, <span class="st">'tolerance'</span>])<span class="fu">.apply</span>(</span>
<span id="cb6-878"><a href="#cb6-878" aria-hidden="true" tabindex="-1"></a>            lambda group<span class="sc">:</span> <span class="fu">average_precision_score</span>(</span>
<span id="cb6-879"><a href="#cb6-879" aria-hidden="true" tabindex="-1"></a>                group[<span class="st">'matched'</span>]<span class="fu">.to_numpy</span>(),</span>
<span id="cb6-880"><a href="#cb6-880" aria-hidden="true" tabindex="-1"></a>                group[score_column_name]<span class="fu">.to_numpy</span>(),</span>
<span id="cb6-881"><a href="#cb6-881" aria-hidden="true" tabindex="-1"></a>                class_counts[group[event_column_name].iat[<span class="dv">0</span>]],</span>
<span id="cb6-882"><a href="#cb6-882" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-883"><a href="#cb6-883" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-884"><a href="#cb6-884" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-885"><a href="#cb6-885" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average over tolerances, then over event classes</span></span>
<span id="cb6-886"><a href="#cb6-886" aria-hidden="true" tabindex="-1"></a>    mean_ap <span class="ot">=</span> <span class="fu">ap_table.groupby</span>(event_column_name)<span class="fu">.mean</span>()<span class="fu">.sum</span>() <span class="sc">/</span> <span class="fu">len</span>(event_classes)</span>
<span id="cb6-887"><a href="#cb6-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-888"><a href="#cb6-888" aria-hidden="true" tabindex="-1"></a>    return mean_ap</span>
<span id="cb6-889"><a href="#cb6-889" aria-hidden="true" tabindex="-1"></a>import numpy as np </span>
<span id="cb6-890"><a href="#cb6-890" aria-hidden="true" tabindex="-1"></a>import pandas as pd</span>
<span id="cb6-891"><a href="#cb6-891" aria-hidden="true" tabindex="-1"></a>import matplotlib.pyplot as plt</span>
<span id="cb6-892"><a href="#cb6-892" aria-hidden="true" tabindex="-1"></a>import polars as pl</span>
<span id="cb6-893"><a href="#cb6-893" aria-hidden="true" tabindex="-1"></a>import datetime </span>
<span id="cb6-894"><a href="#cb6-894" aria-hidden="true" tabindex="-1"></a>from tqdm import tqdm</span>
<span id="cb6-895"><a href="#cb6-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-896"><a href="#cb6-896" aria-hidden="true" tabindex="-1"></a>import plotly.express as px</span>
<span id="cb6-897"><a href="#cb6-897" aria-hidden="true" tabindex="-1"></a>from plotly.subplots import make_subplots</span>
<span id="cb6-898"><a href="#cb6-898" aria-hidden="true" tabindex="-1"></a>import plotly.graph_objects as go</span>
<span id="cb6-899"><a href="#cb6-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-900"><a href="#cb6-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-901"><a href="#cb6-901" aria-hidden="true" tabindex="-1"></a>tolerances <span class="ot">=</span> {</span>
<span id="cb6-902"><a href="#cb6-902" aria-hidden="true" tabindex="-1"></a>    <span class="st">"onset"</span> <span class="sc">:</span> [<span class="dv">12</span>, <span class="dv">36</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>],</span>
<span id="cb6-903"><a href="#cb6-903" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wakeup'</span><span class="sc">:</span> [<span class="dv">12</span>, <span class="dv">36</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>]    </span>
<span id="cb6-904"><a href="#cb6-904" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-905"><a href="#cb6-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-906"><a href="#cb6-906" aria-hidden="true" tabindex="-1"></a>column_names <span class="ot">=</span> {</span>
<span id="cb6-907"><a href="#cb6-907" aria-hidden="true" tabindex="-1"></a>    <span class="st">'series_id_column_name'</span><span class="sc">:</span> <span class="st">'series_id'</span>,</span>
<span id="cb6-908"><a href="#cb6-908" aria-hidden="true" tabindex="-1"></a>    <span class="st">'time_column_name'</span><span class="sc">:</span> <span class="st">'step'</span>,</span>
<span id="cb6-909"><a href="#cb6-909" aria-hidden="true" tabindex="-1"></a>    <span class="st">'event_column_name'</span><span class="sc">:</span> <span class="st">'event'</span>,</span>
<span id="cb6-910"><a href="#cb6-910" aria-hidden="true" tabindex="-1"></a>    <span class="st">'score_column_name'</span><span class="sc">:</span> <span class="st">'score'</span>,</span>
<span id="cb6-911"><a href="#cb6-911" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-912"><a href="#cb6-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-913"><a href="#cb6-913" aria-hidden="true" tabindex="-1"></a><span class="co">#import data</span></span>
<span id="cb6-914"><a href="#cb6-914" aria-hidden="true" tabindex="-1"></a>dt_transforms <span class="ot">=</span> [</span>
<span id="cb6-915"><a href="#cb6-915" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pl.col</span>(<span class="st">'timestamp'</span>)<span class="fu">.str.to_datetime</span>(), </span>
<span id="cb6-916"><a href="#cb6-916" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">pl.col</span>(<span class="st">'timestamp'</span>)<span class="fu">.str.to_datetime</span>()<span class="fu">.dt.year</span>()<span class="sc">-</span><span class="dv">2000</span>)<span class="fu">.cast</span>(pl.UInt8)<span class="fu">.alias</span>(<span class="st">'year'</span>), </span>
<span id="cb6-917"><a href="#cb6-917" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pl.col</span>(<span class="st">'timestamp'</span>)<span class="fu">.str.to_datetime</span>()<span class="fu">.dt.month</span>()<span class="fu">.cast</span>(pl.UInt8)<span class="fu">.alias</span>(<span class="st">'month'</span>),</span>
<span id="cb6-918"><a href="#cb6-918" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pl.col</span>(<span class="st">'timestamp'</span>)<span class="fu">.str.to_datetime</span>()<span class="fu">.dt.day</span>()<span class="fu">.cast</span>(pl.UInt8)<span class="fu">.alias</span>(<span class="st">'day'</span>), </span>
<span id="cb6-919"><a href="#cb6-919" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pl.col</span>(<span class="st">'timestamp'</span>)<span class="fu">.str.to_datetime</span>()<span class="fu">.dt.hour</span>()<span class="fu">.cast</span>(pl.UInt8)<span class="fu">.alias</span>(<span class="st">'hour'</span>)</span>
<span id="cb6-920"><a href="#cb6-920" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-921"><a href="#cb6-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-922"><a href="#cb6-922" aria-hidden="true" tabindex="-1"></a>data_transforms <span class="ot">=</span> [</span>
<span id="cb6-923"><a href="#cb6-923" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pl.col</span>(<span class="st">'anglez'</span>)<span class="fu">.cast</span>(pl.Int16), <span class="co"># Casting anglez to 16 bit integer</span></span>
<span id="cb6-924"><a href="#cb6-924" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">pl.col</span>(<span class="st">'enmo'</span>)<span class="sc">*</span><span class="dv">1000</span>)<span class="fu">.cast</span>(pl.UInt16), <span class="co"># Convert enmo to 16 bit uint</span></span>
<span id="cb6-925"><a href="#cb6-925" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-926"><a href="#cb6-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-927"><a href="#cb6-927" aria-hidden="true" tabindex="-1"></a>train_series <span class="ot">=</span> <span class="fu">pl.scan_parquet</span>(<span class="st">'train_series.parquet'</span>)<span class="fu">.with_columns</span>(</span>
<span id="cb6-928"><a href="#cb6-928" aria-hidden="true" tabindex="-1"></a>    dt_transforms <span class="sc">+</span> data_transforms</span>
<span id="cb6-929"><a href="#cb6-929" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-930"><a href="#cb6-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-931"><a href="#cb6-931" aria-hidden="true" tabindex="-1"></a>train_events <span class="ot">=</span> <span class="fu">pl.read_csv</span>(<span class="st">'train_events.csv'</span>)<span class="fu">.with_columns</span>(</span>
<span id="cb6-932"><a href="#cb6-932" aria-hidden="true" tabindex="-1"></a>    dt_transforms</span>
<span id="cb6-933"><a href="#cb6-933" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-934"><a href="#cb6-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-935"><a href="#cb6-935" aria-hidden="true" tabindex="-1"></a>test_series <span class="ot">=</span> <span class="fu">pl.scan_parquet</span>(<span class="st">'test_series.parquet'</span>)<span class="fu">.with_columns</span>(</span>
<span id="cb6-936"><a href="#cb6-936" aria-hidden="true" tabindex="-1"></a>    dt_transforms <span class="sc">+</span> data_transforms</span>
<span id="cb6-937"><a href="#cb6-937" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-938"><a href="#cb6-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-939"><a href="#cb6-939" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting series ids as a list for convenience</span></span>
<span id="cb6-940"><a href="#cb6-940" aria-hidden="true" tabindex="-1"></a>series_ids <span class="ot">=</span> train_events[<span class="st">'series_id'</span>]<span class="fu">.unique</span>(<span class="at">maintain_order=</span>True)<span class="fu">.to_list</span>()</span>
<span id="cb6-941"><a href="#cb6-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-942"><a href="#cb6-942" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing series with mismatched counts: </span></span>
<span id="cb6-943"><a href="#cb6-943" aria-hidden="true" tabindex="-1"></a>onset_counts <span class="ot">=</span> <span class="fu">train_events.filter</span>(<span class="fu">pl.col</span>(<span class="st">'event'</span>)<span class="sc">==</span><span class="st">'onset'</span>)<span class="fu">.group_by</span>(<span class="st">'series_id'</span>)<span class="fu">.count</span>()<span class="fu">.sort</span>(<span class="st">'series_id'</span>)[<span class="st">'count'</span>]</span>
<span id="cb6-944"><a href="#cb6-944" aria-hidden="true" tabindex="-1"></a>wakeup_counts <span class="ot">=</span> <span class="fu">train_events.filter</span>(<span class="fu">pl.col</span>(<span class="st">'event'</span>)<span class="sc">==</span><span class="st">'wakeup'</span>)<span class="fu">.group_by</span>(<span class="st">'series_id'</span>)<span class="fu">.count</span>()<span class="fu">.sort</span>(<span class="st">'series_id'</span>)[<span class="st">'count'</span>]</span>
<span id="cb6-945"><a href="#cb6-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-946"><a href="#cb6-946" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">=</span> <span class="fu">pl.DataFrame</span>({<span class="st">'series_id'</span><span class="sc">:</span><span class="fu">sorted</span>(series_ids), <span class="st">'onset_counts'</span><span class="sc">:</span>onset_counts, <span class="st">'wakeup_counts'</span><span class="sc">:</span>wakeup_counts})</span>
<span id="cb6-947"><a href="#cb6-947" aria-hidden="true" tabindex="-1"></a>count_mismatches <span class="ot">=</span> <span class="fu">counts.filter</span>(counts[<span class="st">'onset_counts'</span>] <span class="sc">!=</span> counts[<span class="st">'wakeup_counts'</span>])</span>
<span id="cb6-948"><a href="#cb6-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-949"><a href="#cb6-949" aria-hidden="true" tabindex="-1"></a>train_series <span class="ot">=</span> <span class="fu">train_series.filter</span>(<span class="sc">~</span><span class="fu">pl.col</span>(<span class="st">'series_id'</span>)<span class="fu">.is_in</span>(count_mismatches[<span class="st">'series_id'</span>]))</span>
<span id="cb6-950"><a href="#cb6-950" aria-hidden="true" tabindex="-1"></a>train_events <span class="ot">=</span> <span class="fu">train_events.filter</span>(<span class="sc">~</span><span class="fu">pl.col</span>(<span class="st">'series_id'</span>)<span class="fu">.is_in</span>(count_mismatches[<span class="st">'series_id'</span>]))</span>
<span id="cb6-951"><a href="#cb6-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-952"><a href="#cb6-952" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating list of series ids, not including series with no non-null values.</span></span>
<span id="cb6-953"><a href="#cb6-953" aria-hidden="true" tabindex="-1"></a>series_ids <span class="ot">=</span> <span class="fu">train_events.drop_nulls</span>()[<span class="st">'series_id'</span>]<span class="fu">.unique</span>(<span class="at">maintain_order=</span>True)<span class="fu">.to_list</span>()</span>
<span id="cb6-954"><a href="#cb6-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-955"><a href="#cb6-955" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Engineering start from here</span></span>
<span id="cb6-956"><a href="#cb6-956" aria-hidden="true" tabindex="-1"></a>features, feature_cols <span class="ot">=</span> [<span class="fu">pl.col</span>(<span class="st">'hour'</span>)], [<span class="st">'hour'</span>]</span>
<span id="cb6-957"><a href="#cb6-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-958"><a href="#cb6-958" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mins <span class="cf">in</span> [<span class="dv">5</span>, <span class="dv">30</span>, <span class="dv">60</span><span class="sc">*</span><span class="dv">2</span>, <span class="dv">60</span><span class="sc">*</span><span class="dv">8</span>] <span class="sc">:</span></span>
<span id="cb6-959"><a href="#cb6-959" aria-hidden="true" tabindex="-1"></a>    features <span class="sc">+</span><span class="er">=</span> [</span>
<span id="cb6-960"><a href="#cb6-960" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pl.col</span>(<span class="st">'enmo'</span>)<span class="fu">.rolling_mean</span>(<span class="dv">12</span> <span class="sc">*</span> mins, <span class="at">center=</span>True, <span class="at">min_periods=</span><span class="dv">1</span>)<span class="fu">.abs</span>()<span class="fu">.cast</span>(pl.UInt16)<span class="fu">.alias</span>(f<span class="st">'enmo_{mins}m_mean'</span>),</span>
<span id="cb6-961"><a href="#cb6-961" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pl.col</span>(<span class="st">'enmo'</span>)<span class="fu">.rolling_max</span>(<span class="dv">12</span> <span class="sc">*</span> mins, <span class="at">center=</span>True, <span class="at">min_periods=</span><span class="dv">1</span>)<span class="fu">.abs</span>()<span class="fu">.cast</span>(pl.UInt16)<span class="fu">.alias</span>(f<span class="st">'enmo_{mins}m_max'</span>)</span>
<span id="cb6-962"><a href="#cb6-962" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-963"><a href="#cb6-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-964"><a href="#cb6-964" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="sc">+</span><span class="er">=</span> [ </span>
<span id="cb6-965"><a href="#cb6-965" aria-hidden="true" tabindex="-1"></a>        f<span class="st">'enmo_{mins}m_mean'</span>, f<span class="st">'enmo_{mins}m_max'</span></span>
<span id="cb6-966"><a href="#cb6-966" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-967"><a href="#cb6-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-968"><a href="#cb6-968" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Getting first variations</span></span>
<span id="cb6-969"><a href="#cb6-969" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="cf">in</span> [<span class="st">'enmo'</span>, <span class="st">'anglez'</span>] <span class="sc">:</span></span>
<span id="cb6-970"><a href="#cb6-970" aria-hidden="true" tabindex="-1"></a>        features <span class="sc">+</span><span class="er">=</span> [</span>
<span id="cb6-971"><a href="#cb6-971" aria-hidden="true" tabindex="-1"></a>            (<span class="fu">pl.col</span>(var)<span class="fu">.diff</span>()<span class="fu">.abs</span>()<span class="fu">.rolling_mean</span>(<span class="dv">12</span> <span class="sc">*</span> mins, <span class="at">center=</span>True, <span class="at">min_periods=</span><span class="dv">1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="fu">.abs</span>()<span class="fu">.cast</span>(pl.UInt32)<span class="fu">.alias</span>(f<span class="st">'{var}_1v_{mins}m_mean'</span>),</span>
<span id="cb6-972"><a href="#cb6-972" aria-hidden="true" tabindex="-1"></a>            (<span class="fu">pl.col</span>(var)<span class="fu">.diff</span>()<span class="fu">.abs</span>()<span class="fu">.rolling_max</span>(<span class="dv">12</span> <span class="sc">*</span> mins, <span class="at">center=</span>True, <span class="at">min_periods=</span><span class="dv">1</span>)<span class="sc">*</span><span class="dv">10</span>)<span class="fu">.abs</span>()<span class="fu">.cast</span>(pl.UInt32)<span class="fu">.alias</span>(f<span class="st">'{var}_1v_{mins}m_max'</span>)</span>
<span id="cb6-973"><a href="#cb6-973" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-974"><a href="#cb6-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-975"><a href="#cb6-975" aria-hidden="true" tabindex="-1"></a>        feature_cols <span class="sc">+</span><span class="er">=</span> [ </span>
<span id="cb6-976"><a href="#cb6-976" aria-hidden="true" tabindex="-1"></a>            f<span class="st">'{var}_1v_{mins}m_mean'</span>, f<span class="st">'{var}_1v_{mins}m_max'</span></span>
<span id="cb6-977"><a href="#cb6-977" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb6-978"><a href="#cb6-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-979"><a href="#cb6-979" aria-hidden="true" tabindex="-1"></a>id_cols <span class="ot">=</span> [<span class="st">'series_id'</span>, <span class="st">'step'</span>, <span class="st">'timestamp'</span>]</span>
<span id="cb6-980"><a href="#cb6-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-981"><a href="#cb6-981" aria-hidden="true" tabindex="-1"></a>train_series <span class="ot">=</span> <span class="fu">train_series.with_columns</span>(</span>
<span id="cb6-982"><a href="#cb6-982" aria-hidden="true" tabindex="-1"></a>    features</span>
<span id="cb6-983"><a href="#cb6-983" aria-hidden="true" tabindex="-1"></a>)<span class="fu">.select</span>(id_cols <span class="sc">+</span> feature_cols)</span>
<span id="cb6-984"><a href="#cb6-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-985"><a href="#cb6-985" aria-hidden="true" tabindex="-1"></a>test_series <span class="ot">=</span> <span class="fu">test_series.with_columns</span>(</span>
<span id="cb6-986"><a href="#cb6-986" aria-hidden="true" tabindex="-1"></a>    features</span>
<span id="cb6-987"><a href="#cb6-987" aria-hidden="true" tabindex="-1"></a>)<span class="fu">.select</span>(id_cols <span class="sc">+</span> feature_cols)</span>
<span id="cb6-988"><a href="#cb6-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-989"><a href="#cb6-989" aria-hidden="true" tabindex="-1"></a><span class="co"># train dataset preparation method</span></span>
<span id="cb6-990"><a href="#cb6-990" aria-hidden="true" tabindex="-1"></a>def <span class="fu">make_train_dataset</span>(train_data, train_events, <span class="at">drop_nulls=</span>False) <span class="sc">:</span></span>
<span id="cb6-991"><a href="#cb6-991" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-992"><a href="#cb6-992" aria-hidden="true" tabindex="-1"></a>    series_ids <span class="ot">=</span> train_data[<span class="st">'series_id'</span>]<span class="fu">.unique</span>(<span class="at">maintain_order=</span>True)<span class="fu">.to_list</span>()</span>
<span id="cb6-993"><a href="#cb6-993" aria-hidden="true" tabindex="-1"></a>    X, y <span class="ot">=</span> <span class="fu">pl.DataFrame</span>(), <span class="fu">pl.DataFrame</span>()</span>
<span id="cb6-994"><a href="#cb6-994" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="cf">in</span> <span class="fu">tqdm</span>(series_ids) <span class="sc">:</span> </span>
<span id="cb6-995"><a href="#cb6-995" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-996"><a href="#cb6-996" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalizing sample features</span></span>
<span id="cb6-997"><a href="#cb6-997" aria-hidden="true" tabindex="-1"></a>        sample <span class="ot">=</span> <span class="fu">train_data.filter</span>(<span class="fu">pl.col</span>(<span class="st">'series_id'</span>)<span class="sc">==</span>idx)<span class="fu">.with_columns</span>(</span>
<span id="cb6-998"><a href="#cb6-998" aria-hidden="true" tabindex="-1"></a>            [(<span class="fu">pl.col</span>(col) <span class="sc">/</span> <span class="fu">pl.col</span>(col)<span class="fu">.std</span>())<span class="fu">.cast</span>(pl.Float32) <span class="cf">for</span> col <span class="cf">in</span> feature_cols <span class="cf">if</span> col <span class="sc">!=</span> <span class="st">'hour'</span>]</span>
<span id="cb6-999"><a href="#cb6-999" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-1000"><a href="#cb6-1000" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-1001"><a href="#cb6-1001" aria-hidden="true" tabindex="-1"></a>        events <span class="ot">=</span> <span class="fu">train_events.filter</span>(<span class="fu">pl.col</span>(<span class="st">'series_id'</span>)<span class="sc">==</span>idx)</span>
<span id="cb6-1002"><a href="#cb6-1002" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-1003"><a href="#cb6-1003" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drop_nulls <span class="sc">:</span> </span>
<span id="cb6-1004"><a href="#cb6-1004" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Removing datapoints on dates where no data was recorded</span></span>
<span id="cb6-1005"><a href="#cb6-1005" aria-hidden="true" tabindex="-1"></a>            sample <span class="ot">=</span> <span class="fu">sample.filter</span>(</span>
<span id="cb6-1006"><a href="#cb6-1006" aria-hidden="true" tabindex="-1"></a>                <span class="fu">pl.col</span>(<span class="st">'timestamp'</span>)<span class="fu">.dt.date</span>()<span class="fu">.is_in</span>(events[<span class="st">'timestamp'</span>]<span class="fu">.dt.date</span>())</span>
<span id="cb6-1007"><a href="#cb6-1007" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-1008"><a href="#cb6-1008" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-1009"><a href="#cb6-1009" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">=</span> <span class="fu">X.vstack</span>(sample[id_cols <span class="sc">+</span> feature_cols])</span>
<span id="cb6-1010"><a href="#cb6-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1011"><a href="#cb6-1011" aria-hidden="true" tabindex="-1"></a>        onsets <span class="ot">=</span> <span class="fu">events.filter</span>((<span class="fu">pl.col</span>(<span class="st">'event'</span>) <span class="sc">==</span> <span class="st">'onset'</span>) <span class="sc">&amp;</span> (<span class="fu">pl.col</span>(<span class="st">'step'</span>) <span class="sc">!=</span> None))[<span class="st">'step'</span>]<span class="fu">.to_list</span>()</span>
<span id="cb6-1012"><a href="#cb6-1012" aria-hidden="true" tabindex="-1"></a>        wakeups <span class="ot">=</span> <span class="fu">events.filter</span>((<span class="fu">pl.col</span>(<span class="st">'event'</span>) <span class="sc">==</span> <span class="st">'wakeup'</span>) <span class="sc">&amp;</span> (<span class="fu">pl.col</span>(<span class="st">'step'</span>) <span class="sc">!=</span> None))[<span class="st">'step'</span>]<span class="fu">.to_list</span>()</span>
<span id="cb6-1013"><a href="#cb6-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1014"><a href="#cb6-1014" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">NOTE</span><span class="co">: This will break if there are event series without any recorded onsets or wakeups</span></span>
<span id="cb6-1015"><a href="#cb6-1015" aria-hidden="true" tabindex="-1"></a>        y <span class="ot">=</span> <span class="fu">y.vstack</span>(<span class="fu">sample.with_columns</span>(</span>
<span id="cb6-1016"><a href="#cb6-1016" aria-hidden="true" tabindex="-1"></a>            <span class="fu">sum</span>([(onset <span class="sc">&lt;=</span> <span class="fu">pl.col</span>(<span class="st">'step'</span>)) <span class="sc">&amp;</span> (<span class="fu">pl.col</span>(<span class="st">'step'</span>) <span class="sc">&lt;=</span> wakeup) <span class="cf">for</span> onset, wakeup <span class="cf">in</span> <span class="fu">zip</span>(onsets, wakeups)])<span class="fu">.cast</span>(pl.Boolean)<span class="fu">.alias</span>(<span class="st">'asleep'</span>)</span>
<span id="cb6-1017"><a href="#cb6-1017" aria-hidden="true" tabindex="-1"></a>            )<span class="fu">.select</span>(<span class="st">'asleep'</span>)</span>
<span id="cb6-1018"><a href="#cb6-1018" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-1019"><a href="#cb6-1019" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-1020"><a href="#cb6-1020" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">=</span> <span class="fu">y.to_numpy</span>()<span class="fu">.ravel</span>()</span>
<span id="cb6-1021"><a href="#cb6-1021" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-1022"><a href="#cb6-1022" aria-hidden="true" tabindex="-1"></a>    return X, y</span>
<span id="cb6-1023"><a href="#cb6-1023" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-1024"><a href="#cb6-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1025"><a href="#cb6-1025" aria-hidden="true" tabindex="-1"></a><span class="co"># apply classifier to get event method</span></span>
<span id="cb6-1026"><a href="#cb6-1026" aria-hidden="true" tabindex="-1"></a>def <span class="fu">get_events</span>(series, classifier) <span class="sc">:</span></span>
<span id="cb6-1027"><a href="#cb6-1027" aria-hidden="true" tabindex="-1"></a>    <span class="st">'''</span></span>
<span id="cb6-1028"><a href="#cb6-1028" aria-hidden="true" tabindex="-1"></a><span class="st">    Takes a time series and a classifier and returns a formatted submission dataframe.</span></span>
<span id="cb6-1029"><a href="#cb6-1029" aria-hidden="true" tabindex="-1"></a><span class="st">    '''</span></span>
<span id="cb6-1030"><a href="#cb6-1030" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-1031"><a href="#cb6-1031" aria-hidden="true" tabindex="-1"></a>    series_ids <span class="ot">=</span> series[<span class="st">'series_id'</span>]<span class="fu">.unique</span>(<span class="at">maintain_order=</span>True)<span class="fu">.to_list</span>()</span>
<span id="cb6-1032"><a href="#cb6-1032" aria-hidden="true" tabindex="-1"></a>    events <span class="ot">=</span> <span class="fu">pl.DataFrame</span>(<span class="at">schema=</span>{<span class="st">'series_id'</span><span class="sc">:</span>str, <span class="st">'step'</span><span class="sc">:</span>int, <span class="st">'event'</span><span class="sc">:</span>str, <span class="st">'score'</span><span class="sc">:</span>float})</span>
<span id="cb6-1033"><a href="#cb6-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1034"><a href="#cb6-1034" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="cf">in</span> <span class="fu">tqdm</span>(series_ids) <span class="sc">:</span> </span>
<span id="cb6-1035"><a href="#cb6-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1036"><a href="#cb6-1036" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collecting sample and normalizing features</span></span>
<span id="cb6-1037"><a href="#cb6-1037" aria-hidden="true" tabindex="-1"></a>        scale_cols <span class="ot">=</span> [col <span class="cf">for</span> col <span class="cf">in</span> feature_cols <span class="cf">if</span> (col <span class="sc">!=</span> <span class="st">'hour'</span>) <span class="sc">&amp;</span> (series[col]<span class="fu">.std</span>() <span class="sc">!=</span><span class="dv">0</span>)]</span>
<span id="cb6-1038"><a href="#cb6-1038" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">=</span> <span class="fu">series.filter</span>(<span class="fu">pl.col</span>(<span class="st">'series_id'</span>) <span class="sc">==</span> idx)<span class="fu">.select</span>(id_cols <span class="sc">+</span> feature_cols)<span class="fu">.with_columns</span>(</span>
<span id="cb6-1039"><a href="#cb6-1039" aria-hidden="true" tabindex="-1"></a>            [(<span class="fu">pl.col</span>(col) <span class="sc">/</span> series[col]<span class="fu">.std</span>())<span class="fu">.cast</span>(pl.Float32) <span class="cf">for</span> col <span class="cf">in</span> scale_cols]</span>
<span id="cb6-1040"><a href="#cb6-1040" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-1041"><a href="#cb6-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1042"><a href="#cb6-1042" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Applying classifier to get predictions and scores</span></span>
<span id="cb6-1043"><a href="#cb6-1043" aria-hidden="true" tabindex="-1"></a>        preds, probs <span class="ot">=</span> <span class="fu">classifier.predict</span>(X[feature_cols]), <span class="fu">classifier.predict_proba</span>(X[feature_cols])[<span class="sc">:</span>, <span class="dv">1</span>]</span>
<span id="cb6-1044"><a href="#cb6-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1045"><a href="#cb6-1045" aria-hidden="true" tabindex="-1"></a>        <span class="co">#NOTE: Considered using rolling max to get sleep periods excluding &lt;30 min interruptions, but ended up decreasing performance</span></span>
<span id="cb6-1046"><a href="#cb6-1046" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">=</span> <span class="fu">X.with_columns</span>(</span>
<span id="cb6-1047"><a href="#cb6-1047" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pl.lit</span>(preds)<span class="fu">.cast</span>(pl.Int8)<span class="fu">.alias</span>(<span class="st">'prediction'</span>), </span>
<span id="cb6-1048"><a href="#cb6-1048" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pl.lit</span>(probs)<span class="fu">.alias</span>(<span class="st">'probability'</span>)</span>
<span id="cb6-1049"><a href="#cb6-1049" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb6-1050"><a href="#cb6-1050" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-1051"><a href="#cb6-1051" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Getting predicted onset and wakeup time steps</span></span>
<span id="cb6-1052"><a href="#cb6-1052" aria-hidden="true" tabindex="-1"></a>        pred_onsets <span class="ot">=</span> <span class="fu">X.filter</span>(X[<span class="st">'prediction'</span>]<span class="fu">.diff</span>() <span class="sc">&gt;</span> <span class="dv">0</span>)[<span class="st">'step'</span>]<span class="fu">.to_list</span>()</span>
<span id="cb6-1053"><a href="#cb6-1053" aria-hidden="true" tabindex="-1"></a>        pred_wakeups <span class="ot">=</span> <span class="fu">X.filter</span>(X[<span class="st">'prediction'</span>]<span class="fu">.diff</span>() <span class="sc">&lt;</span> <span class="dv">0</span>)[<span class="st">'step'</span>]<span class="fu">.to_list</span>()</span>
<span id="cb6-1054"><a href="#cb6-1054" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-1055"><a href="#cb6-1055" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="fu">len</span>(pred_onsets) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">:</span> </span>
<span id="cb6-1056"><a href="#cb6-1056" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-1057"><a href="#cb6-1057" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensuring all predicted sleep periods begin and end</span></span>
<span id="cb6-1058"><a href="#cb6-1058" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">min</span>(pred_wakeups) <span class="sc">&lt;</span> <span class="fu">min</span>(pred_onsets) <span class="sc">:</span> </span>
<span id="cb6-1059"><a href="#cb6-1059" aria-hidden="true" tabindex="-1"></a>                pred_wakeups <span class="ot">=</span> pred_wakeups[<span class="dv">1</span><span class="sc">:</span>]</span>
<span id="cb6-1060"><a href="#cb6-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1061"><a href="#cb6-1061" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="fu">max</span>(pred_onsets) <span class="sc">&gt;</span> <span class="fu">max</span>(pred_wakeups) <span class="sc">:</span></span>
<span id="cb6-1062"><a href="#cb6-1062" aria-hidden="true" tabindex="-1"></a>                pred_onsets <span class="ot">=</span> pred_onsets[<span class="sc">:-</span><span class="dv">1</span>]</span>
<span id="cb6-1063"><a href="#cb6-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1064"><a href="#cb6-1064" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Keeping sleep periods longer than 30 minutes</span></span>
<span id="cb6-1065"><a href="#cb6-1065" aria-hidden="true" tabindex="-1"></a>            sleep_periods <span class="ot">=</span> [(onset, wakeup) <span class="cf">for</span> onset, wakeup <span class="cf">in</span> <span class="fu">zip</span>(pred_onsets, pred_wakeups) <span class="cf">if</span> wakeup <span class="sc">-</span> onset <span class="sc">&gt;=</span> <span class="dv">12</span> <span class="sc">*</span> <span class="dv">30</span>]</span>
<span id="cb6-1066"><a href="#cb6-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1067"><a href="#cb6-1067" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> onset, wakeup <span class="cf">in</span> sleep_periods <span class="sc">:</span></span>
<span id="cb6-1068"><a href="#cb6-1068" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Scoring using mean probability over period</span></span>
<span id="cb6-1069"><a href="#cb6-1069" aria-hidden="true" tabindex="-1"></a>                score <span class="ot">=</span> <span class="fu">X.filter</span>((<span class="fu">pl.col</span>(<span class="st">'step'</span>) <span class="sc">&gt;=</span> onset) <span class="sc">&amp;</span> (<span class="fu">pl.col</span>(<span class="st">'step'</span>) <span class="sc">&lt;=</span> wakeup))[<span class="st">'probability'</span>]<span class="fu">.mean</span>()</span>
<span id="cb6-1070"><a href="#cb6-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1071"><a href="#cb6-1071" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Adding sleep event to dataframe</span></span>
<span id="cb6-1072"><a href="#cb6-1072" aria-hidden="true" tabindex="-1"></a>                events <span class="ot">=</span> <span class="fu">events.vstack</span>(<span class="fu">pl.DataFrame</span>()<span class="fu">.with_columns</span>(</span>
<span id="cb6-1073"><a href="#cb6-1073" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">pl.Series</span>([idx, idx])<span class="fu">.alias</span>(<span class="st">'series_id'</span>), </span>
<span id="cb6-1074"><a href="#cb6-1074" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">pl.Series</span>([onset, wakeup])<span class="fu">.alias</span>(<span class="st">'step'</span>),</span>
<span id="cb6-1075"><a href="#cb6-1075" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">pl.Series</span>([<span class="st">'onset'</span>, <span class="st">'wakeup'</span>])<span class="fu">.alias</span>(<span class="st">'event'</span>),</span>
<span id="cb6-1076"><a href="#cb6-1076" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">pl.Series</span>([score, score])<span class="fu">.alias</span>(<span class="st">'score'</span>)</span>
<span id="cb6-1077"><a href="#cb6-1077" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb6-1078"><a href="#cb6-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1079"><a href="#cb6-1079" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adding row id column</span></span>
<span id="cb6-1080"><a href="#cb6-1080" aria-hidden="true" tabindex="-1"></a>    events <span class="ot">=</span> <span class="fu">events.to_pandas</span>()<span class="fu">.reset_index</span>()<span class="fu">.rename</span>(<span class="at">columns=</span>{<span class="st">'index'</span><span class="sc">:</span><span class="st">'row_id'</span>})</span>
<span id="cb6-1081"><a href="#cb6-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1082"><a href="#cb6-1082" aria-hidden="true" tabindex="-1"></a>    return events</span>
<span id="cb6-1083"><a href="#cb6-1083" aria-hidden="true" tabindex="-1"></a><span class="co"># extract from R processed testing_set and testing_pred_prob, then use ap score in python to calculate</span></span>
<span id="cb6-1084"><a href="#cb6-1084" aria-hidden="true" tabindex="-1"></a>import pandas as pd</span>
<span id="cb6-1085"><a href="#cb6-1085" aria-hidden="true" tabindex="-1"></a>testing_set <span class="ot">=</span> <span class="fu">pd.read_csv</span>(<span class="st">"testing_set.csv"</span>)</span>
<span id="cb6-1086"><a href="#cb6-1086" aria-hidden="true" tabindex="-1"></a>testing_set_probs <span class="ot">=</span> <span class="fu">pd.read_csv</span>(<span class="st">"testing_set_probs.csv"</span>)</span>
<span id="cb6-1087"><a href="#cb6-1087" aria-hidden="true" tabindex="-1"></a>series_id_column_name <span class="ot">=</span> <span class="st">'series_id'</span> </span>
<span id="cb6-1088"><a href="#cb6-1088" aria-hidden="true" tabindex="-1"></a>time_column_name <span class="ot">=</span> <span class="st">'step'</span>         </span>
<span id="cb6-1089"><a href="#cb6-1089" aria-hidden="true" tabindex="-1"></a>event_column_name <span class="ot">=</span> <span class="st">'awake'</span>         </span>
<span id="cb6-1090"><a href="#cb6-1090" aria-hidden="true" tabindex="-1"></a>score_column_name <span class="ot">=</span> <span class="st">'score'</span></span>
<span id="cb6-1091"><a href="#cb6-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1092"><a href="#cb6-1092" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the solution DataFrame</span></span>
<span id="cb6-1093"><a href="#cb6-1093" aria-hidden="true" tabindex="-1"></a>solution <span class="ot">=</span> testing_set[[series_id_column_name, time_column_name, event_column_name]]</span>
<span id="cb6-1094"><a href="#cb6-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1095"><a href="#cb6-1095" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert predicted probabilities to class labels using a threshold of 0.5</span></span>
<span id="cb6-1096"><a href="#cb6-1096" aria-hidden="true" tabindex="-1"></a><span class="co"># The probabilities for class "1" are in the second column of testing_set_probs</span></span>
<span id="cb6-1097"><a href="#cb6-1097" aria-hidden="true" tabindex="-1"></a>predicted_labels <span class="ot">=</span> (testing_set_probs.iloc[<span class="sc">:</span>, <span class="dv">1</span>] <span class="sc">&gt;</span> <span class="fl">0.5</span>)<span class="fu">.astype</span>(int)</span>
<span id="cb6-1098"><a href="#cb6-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1099"><a href="#cb6-1099" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the submission DataFrame</span></span>
<span id="cb6-1100"><a href="#cb6-1100" aria-hidden="true" tabindex="-1"></a>submission <span class="ot">=</span> testing_set[[series_id_column_name, time_column_name, event_column_name]]</span>
<span id="cb6-1101"><a href="#cb6-1101" aria-hidden="true" tabindex="-1"></a>submission[<span class="st">'predicted_label'</span>] <span class="ot">=</span> predicted_labels  <span class="co"># Add predicted labels</span></span>
<span id="cb6-1102"><a href="#cb6-1102" aria-hidden="true" tabindex="-1"></a>submission[<span class="st">'score'</span>] <span class="ot">=</span> testing_set_probs.iloc[<span class="sc">:</span>, <span class="dv">1</span>] <span class="co"># Add the probabilities as confidence scores</span></span>
<span id="cb6-1103"><a href="#cb6-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1104"><a href="#cb6-1104" aria-hidden="true" tabindex="-1"></a><span class="co"># Handling scoring intervals if use_scoring_intervals is True</span></span>
<span id="cb6-1105"><a href="#cb6-1105" aria-hidden="true" tabindex="-1"></a>use_scoring_intervals <span class="ot">=</span> False  <span class="co"># Set to False if not using scoring intervals</span></span>
<span id="cb6-1106"><a href="#cb6-1106" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> use_scoring_intervals<span class="sc">:</span></span>
<span id="cb6-1107"><a href="#cb6-1107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example: Assuming 'start_event' and 'end_event' columns in testing_set</span></span>
<span id="cb6-1108"><a href="#cb6-1108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These columns should represent the intervals for scoring</span></span>
<span id="cb6-1109"><a href="#cb6-1109" aria-hidden="true" tabindex="-1"></a>    solution[<span class="st">'start_event'</span>] <span class="ot">=</span> testing_set[<span class="st">'start_event'</span>]</span>
<span id="cb6-1110"><a href="#cb6-1110" aria-hidden="true" tabindex="-1"></a>    solution[<span class="st">'end_event'</span>] <span class="ot">=</span> testing_set[<span class="st">'end_event'</span>]</span>
<span id="cb6-1111"><a href="#cb6-1111" aria-hidden="true" tabindex="-1"></a>    submission[<span class="st">'start_event'</span>] <span class="ot">=</span> testing_set[<span class="st">'start_event'</span>]</span>
<span id="cb6-1112"><a href="#cb6-1112" aria-hidden="true" tabindex="-1"></a>    submission[<span class="st">'end_event'</span>] <span class="ot">=</span> testing_set[<span class="st">'end_event'</span>]</span>
<span id="cb6-1113"><a href="#cb6-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1114"><a href="#cb6-1114" aria-hidden="true" tabindex="-1"></a>solution <span class="ot">=</span> <span class="fu">solution.rename</span>(<span class="at">columns=</span>{<span class="st">'awake'</span><span class="sc">:</span> <span class="st">'event'</span>})</span>
<span id="cb6-1115"><a href="#cb6-1115" aria-hidden="true" tabindex="-1"></a>submission <span class="ot">=</span> <span class="fu">submission.rename</span>(<span class="at">columns=</span>{<span class="st">'awake'</span><span class="sc">:</span> <span class="st">'event'</span>})</span>
<span id="cb6-1116"><a href="#cb6-1116" aria-hidden="true" tabindex="-1"></a>solution[<span class="st">'event'</span>] <span class="ot">=</span> solution[<span class="st">'event'</span>]<span class="fu">.map</span>({<span class="dv">0</span><span class="sc">:</span> <span class="st">'onset'</span>, <span class="dv">1</span><span class="sc">:</span> <span class="st">'wakeup'</span>})</span>
<span id="cb6-1117"><a href="#cb6-1117" aria-hidden="true" tabindex="-1"></a>submission[<span class="st">'event'</span>] <span class="ot">=</span> submission[<span class="st">'event'</span>]<span class="fu">.map</span>({<span class="dv">0</span><span class="sc">:</span> <span class="st">'onset'</span>, <span class="dv">1</span><span class="sc">:</span> <span class="st">'wakeup'</span>})</span>
<span id="cb6-1118"><a href="#cb6-1118" aria-hidden="true" tabindex="-1"></a><span class="fu">solution.to_csv</span>(<span class="st">'testing_set_solution.csv'</span>,<span class="at">index=</span>False)</span>
<span id="cb6-1119"><a href="#cb6-1119" aria-hidden="true" tabindex="-1"></a><span class="fu">submission.to_csv</span>(<span class="st">'testing_set_submission.csv'</span>,<span class="at">index=</span>False)</span>
<span id="cb6-1120"><a href="#cb6-1120" aria-hidden="true" tabindex="-1"></a>rf_ap_score <span class="ot">=</span> <span class="fu">score</span>(solution, submission, tolerances, <span class="sc">**</span>column_names)</span>
<span id="cb6-1121"><a href="#cb6-1121" aria-hidden="true" tabindex="-1"></a>plot2<span class="sc">+</span> <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure5"</span>)<span class="sc">+</span></span>
<span id="cb6-1122"><a href="#cb6-1122" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-1123"><a href="#cb6-1123" aria-hidden="true" tabindex="-1"></a>plot4<span class="sc">+</span> <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure6"</span>)<span class="sc">+</span></span>
<span id="cb6-1124"><a href="#cb6-1124" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-1125"><a href="#cb6-1125" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(roc_obj, <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"ROC Curve, AUC ="</span>, <span class="fu">round</span>(auc_value, <span class="dv">6</span>)))</span>
<span id="cb6-1126"><a href="#cb6-1126" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">"Figure7"</span>, <span class="at">side =</span> <span class="dv">1</span>, <span class="at">line =</span> <span class="fl">4.15</span>, <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb6-1127"><a href="#cb6-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the Confusion Matrix</span></span>
<span id="cb6-1128"><a href="#cb6-1128" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(confusionMatrix)</span>
<span id="cb6-1129"><a href="#cb6-1129" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the metrics</span></span>
<span id="cb6-1130"><a href="#cb6-1130" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Precision:"</span>, precision))</span>
<span id="cb6-1131"><a href="#cb6-1131" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Recall:"</span>, recall))</span>
<span id="cb6-1132"><a href="#cb6-1132" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"F1 Score:"</span>, f1_score))</span>
<span id="cb6-1133"><a href="#cb6-1133" aria-hidden="true" tabindex="-1"></a>rf_feature_importance_plot<span class="sc">+</span> <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Figure8"</span>)<span class="sc">+</span></span>
<span id="cb6-1134"><a href="#cb6-1134" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb6-1135"><a href="#cb6-1135" aria-hidden="true" tabindex="-1"></a>final_submission</span>
<span id="cb6-1136"><a href="#cb6-1136" aria-hidden="true" tabindex="-1"></a><span class="do">### An Optional Dive into GGIR Package</span></span>
<span id="cb6-1137"><a href="#cb6-1137" aria-hidden="true" tabindex="-1"></a>train_events <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"train_events.csv"</span>)</span>
<span id="cb6-1138"><a href="#cb6-1138" aria-hidden="true" tabindex="-1"></a>train_series <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="st">"Zzzs_train.parquet"</span>)</span>
<span id="cb6-1139"><a href="#cb6-1139" aria-hidden="true" tabindex="-1"></a>test_series <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="st">"test_series.parquet"</span>)</span>
<span id="cb6-1140"><a href="#cb6-1140" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(train_series, <span class="st">"Zzzs_train.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-1141"><a href="#cb6-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(test_series,<span class="st">'test_series.csv'</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-1142"><a href="#cb6-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-1143"><a href="#cb6-1143" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGIR)</span>
<span id="cb6-1144"><a href="#cb6-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#g.shell.GGIR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#- Load libraries</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>library(tidyverse)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>library(arrow)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>library(skimr)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>library(dplyr)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>library(ggplot2)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>library(lubridate)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>library(caret)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>library(randomForest)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>library(patchwork)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>library(pROC)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>library(purrr)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read train_events and modify timestamp with lubridate</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read events</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>events <span class="op">&lt;-</span> read_csv(<span class="st">"train_events.csv"</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        mutate(dt <span class="op">=</span> as_datetime(timestamp)) <span class="op">%&gt;%</span> </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        mutate(dt <span class="op">=</span> dt <span class="op">-</span> hours(<span class="dv">4</span>))  <span class="op">%&gt;%</span> mutate(hr <span class="op">=</span> hour(dt)) <span class="op">%&gt;%</span> </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        select(<span class="op">-</span>timestamp)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>head(events)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co">#- Events counts</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>events <span class="op">%&gt;%</span> count(event)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">#- Sleep onset and wakeup timeline</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge onset and wakeup data on dates</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>timeline_data <span class="op">&lt;-</span> events <span class="op">%&gt;%</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="bu">filter</span>(event <span class="op">%</span><span class="kw">in</span><span class="op">%</span> c(<span class="st">"onset"</span>, <span class="st">"wakeup"</span>)) <span class="op">%&gt;%</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  group_by(date <span class="op">=</span> <span class="im">as</span>.Date(dt)) <span class="op">%&gt;%</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  mutate(time_minutes <span class="op">=</span> hour(dt) <span class="op">*</span> <span class="dv">60</span> <span class="op">+</span> minute(dt))</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>plot1 <span class="op">&lt;-</span> ggplot(timeline_data, aes(x <span class="op">=</span> date, y <span class="op">=</span> time_minutes, color <span class="op">=</span> event)) <span class="op">+</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  geom_point(shape <span class="op">=</span> <span class="dv">3</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"Sleep Onset and Wakeup Timeline"</span>,</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>       y <span class="op">=</span> <span class="st">"Time of Day (minutes after midnight)"</span>) <span class="op">+</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  theme_minimal() <span class="op">+</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  theme(axis.text.x <span class="op">=</span> element_text(angle <span class="op">=</span> <span class="dv">45</span>, hjust <span class="op">=</span> <span class="dv">1</span>))</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate sleep durations and onset hour</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>pivot_data <span class="op">&lt;-</span> events <span class="op">%&gt;%</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  group_by(series_id, night) <span class="op">%&gt;%</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  summarize(duration_minutes <span class="op">=</span> (<span class="bu">max</span>(step) <span class="op">-</span> <span class="bu">min</span>(step)) <span class="op">/</span> <span class="dv">60</span>,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            onset_hour <span class="op">=</span> hour(<span class="bu">min</span>(dt)),.groups <span class="op">=</span> <span class="st">'drop'</span>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average sleep duration by hour of onset</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>average_duration_by_hour <span class="op">&lt;-</span> pivot_data <span class="op">%&gt;%</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  group_by(onset_hour) <span class="op">%&gt;%</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  summarize(avg_duration <span class="op">=</span> mean(duration_minutes),.groups <span class="op">=</span> <span class="st">'drop'</span>)</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a bar plot</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>plot2 <span class="op">&lt;-</span> ggplot(average_duration_by_hour, aes(x <span class="op">=</span> onset_hour, y <span class="op">=</span> avg_duration, fill <span class="op">=</span> avg_duration)) <span class="op">+</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  geom_bar(stat <span class="op">=</span> <span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"Average Sleep Duration by Hour of Onset"</span>,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> <span class="st">"Hour of Sleep Onset"</span>,</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>       y <span class="op">=</span> <span class="st">"Average Sleep Duration (minutes)"</span>) <span class="op">+</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  theme_minimal() <span class="op">+</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  scale_fill_gradient(low <span class="op">=</span> <span class="st">"red"</span>, high <span class="op">=</span> <span class="st">"green"</span>)  </span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Order days of the week</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>ordered_days <span class="op">&lt;-</span> c(<span class="st">"Monday"</span>, <span class="st">"Tuesday"</span>, <span class="st">"Wednesday"</span>, <span class="st">"Thursday"</span>, <span class="st">"Friday"</span>, <span class="st">"Saturday"</span>, <span class="st">"Sunday"</span>)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract day of week and calculate sleep duration in minutes</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate sleep duration in minutes and extract day of the week</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>pivot_data <span class="op">&lt;-</span> events <span class="op">%&gt;%</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>  group_by(series_id, night) <span class="op">%&gt;%</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>  summarize(duration_minutes <span class="op">=</span> (<span class="bu">max</span>(step) <span class="op">-</span> <span class="bu">min</span>(step)) <span class="op">/</span> <span class="dv">60</span>,</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            min_datetime <span class="op">=</span> <span class="bu">min</span>(dt),.groups <span class="op">=</span> <span class="st">'drop'</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>  mutate(day_of_week <span class="op">=</span> factor(<span class="bu">format</span>(min_datetime, <span class="st">"%A"</span>), levels <span class="op">=</span> ordered_days))</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a box plot</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>plot3 <span class="op">&lt;-</span> ggplot(pivot_data, aes(x <span class="op">=</span> day_of_week, y <span class="op">=</span> duration_minutes, fill <span class="op">=</span> day_of_week)) <span class="op">+</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>  geom_boxplot() <span class="op">+</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"Box Plot of Sleep Duration by Day of Week"</span>,</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> <span class="st">"Day of the Week"</span>,</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>       y <span class="op">=</span> <span class="st">"Sleep Duration (minutes)"</span>) <span class="op">+</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>  theme_minimal() <span class="op">+</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>  theme(axis.text.x <span class="op">=</span> element_text(angle <span class="op">=</span> <span class="dv">45</span>, hjust <span class="op">=</span> <span class="dv">1</span>))</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a><span class="co">#- Distribution of wakeup and Distribution of onset</span></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the data for "wakeup" and "onset" events</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>events_wakeup <span class="op">&lt;-</span> events <span class="op">%&gt;%</span> <span class="bu">filter</span>(event <span class="op">==</span> <span class="st">"wakeup"</span>)</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>events_onset <span class="op">&lt;-</span> events <span class="op">%&gt;%</span> <span class="bu">filter</span>(event <span class="op">==</span> <span class="st">"onset"</span>)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the filtered data into a single data frame</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>combined_events <span class="op">&lt;-</span> rbind(events_wakeup, events_onset)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot with density lines for "wakeup" and "onset" events</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>plot4 <span class="op">&lt;-</span> ggplot(combined_events, aes(x <span class="op">=</span> hr, color <span class="op">=</span> event, fill <span class="op">=</span> event)) <span class="op">+</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>  geom_density(alpha <span class="op">=</span> <span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>  labs(x <span class="op">=</span> <span class="st">"Hour"</span>, y <span class="op">=</span> <span class="st">"Density"</span>) <span class="op">+</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>  scale_color_manual(values <span class="op">=</span> c(<span class="st">"wakeup"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"onset"</span> <span class="op">=</span> <span class="st">"blue"</span>)) <span class="op">+</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>  scale_fill_manual(values <span class="op">=</span> c(<span class="st">"wakeup"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"onset"</span> <span class="op">=</span> <span class="st">"blue"</span>)) <span class="op">+</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>  theme_minimal()</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the number of events per series</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>events_per_series <span class="op">&lt;-</span> events <span class="op">%&gt;%</span></span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>  group_by(series_id) <span class="op">%&gt;%</span></span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>  summarize(num_events <span class="op">=</span> n())</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a histogram for the distribution of events per series</span></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>plot5 <span class="op">&lt;-</span> ggplot(events_per_series, aes(x <span class="op">=</span> num_events)) <span class="op">+</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>  geom_histogram(bins <span class="op">=</span> <span class="dv">30</span>, fill <span class="op">=</span> <span class="st">"orange"</span>, color <span class="op">=</span> <span class="st">"black"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"Distribution of Number of Events per Series"</span>,</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> <span class="st">"Number of Events"</span>,</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>       y <span class="op">=</span> <span class="st">"Number of Series"</span>) <span class="op">+</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>  theme_minimal()</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Most series exhibit approximately 48 events. However, there are a few series with a significantly lower number of valid events, which may be excluded from the study.</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a><span class="co">#- Detect NA in events</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>events_na <span class="op">&lt;-</span> events <span class="op">%&gt;%</span> group_by(series_id,step) <span class="op">%&gt;%</span> <span class="bu">filter</span>(<span class="kw">is</span>.na(step))</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>events_na</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>num_na <span class="op">&lt;-</span> length(unique(events_na$series_id))</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>na_id <span class="op">&lt;-</span> unique(events_na$series_id)</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>num_na</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>na_id</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Steps containing records with 'NA' (not available) were identified as not precise enough and subsequently removed. Our primary focus was on analyzing accelerometer data that is complete, without any missing values ('NA'). This approach ensures the integrity and reliability of our findings.</span></span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a><span class="co">#- Series_id without NA events</span></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>all_id <span class="op">&lt;-</span> unique(events$series_id)</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>nna_id <span class="op">&lt;-</span> setdiff(all_id,na_id)</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>nna_id</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a><span class="co"># In this study, steps containing records with 'NA' (not available) were identified as not precise enough and subsequently removed. Our primary focus was on analyzing accelerometer data that is complete, without any missing values ('NA'). This approach ensures the integrity and reliability of our findings, as we are utilizing only the most accurate and comprehensive data sets available.</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a><span class="co">#- Remove two truncated event series</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>trunc <span class="op">&lt;-</span> c(<span class="st">"31011ade7c0a"</span>,<span class="st">"a596ad0b82aa"</span>)</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>nna_id <span class="op">&lt;-</span> setdiff(nna_id,trunc)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>df_nna <span class="op">&lt;-</span> tibble(nna_id) <span class="op">%&gt;%</span> rename(series_id <span class="op">=</span> nna_id)</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>plot1 <span class="op">&lt;-</span> plot1 <span class="op">+</span> labs(caption <span class="op">=</span> <span class="st">"Figure1"</span>)<span class="op">+</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>                      theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>plot3 <span class="op">&lt;-</span> plot3 <span class="op">+</span> labs(caption <span class="op">=</span> <span class="st">"Figure 2"</span>)<span class="op">+</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>                      theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>motivate_plot <span class="op">&lt;-</span> plot1 <span class="op">+</span> plot3</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>                 plot_layout(nrow <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>motivate_plot</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read training data</span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>train <span class="op">&lt;-</span> read_parquet(<span class="st">'Zzzs_train.parquet'</span>)</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>head(train)</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>nna_train <span class="op">&lt;-</span> right_join(train,df_nna)</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>nna_event <span class="op">&lt;-</span> right_join(events,df_nna)</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>train_new <span class="op">&lt;-</span> left_join(nna_train,nna_event)</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>train_new_full <span class="op">&lt;-</span> right_join(nna_train,nna_event)</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>head(train_new_full)</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>training_data <span class="op">&lt;-</span> train_new_full <span class="op">%&gt;%</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>  select(<span class="op">-</span>timestamp,<span class="op">-</span>event,<span class="op">-</span>dt,<span class="op">-</span>night) </span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>head(training_data)</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a><span class="co">#- Read testing data</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>test_old <span class="op">&lt;-</span> read_parquet(<span class="st">"test_series.parquet"</span>) </span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a few random data to enlarge the test_series, the original one only has 3 unique series_id, each series lasts for 2.5 hours.</span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span>.seed(<span class="dv">123</span>)</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>num_rows <span class="op">&lt;-</span> <span class="dv">150</span></span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>random_data <span class="op">&lt;-</span> data.frame(</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>  series_id <span class="op">=</span> rep(<span class="st">"038441c925bb"</span>, num_rows),</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  step <span class="op">=</span> <span class="dv">0</span>:(num_rows<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>  timestamp <span class="op">=</span> seq(<span class="im">from</span> <span class="op">=</span> ymd_hms(<span class="st">"2023-12-13T22:30:00-0400"</span>), </span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>                  by <span class="op">=</span> <span class="st">"5 sec"</span>, length.out <span class="op">=</span> num_rows),</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>  anglez <span class="op">=</span> runif(num_rows, <span class="bu">min</span> <span class="op">=</span> <span class="dv">0</span>, <span class="bu">max</span> <span class="op">=</span> <span class="dv">5</span>),  <span class="co"># Random values between 0 and 5</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>  enmo <span class="op">=</span> runif(num_rows, <span class="bu">min</span> <span class="op">=</span> <span class="dv">0</span>, <span class="bu">max</span> <span class="op">=</span> <span class="fl">0.05</span>)  <span class="co"># Random values between 0 and 0.05</span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timestamps to character</span></span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>random_data$timestamp <span class="op">&lt;-</span> <span class="bu">format</span>(random_data$timestamp, <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">T%H:%M:%S-0400"</span>)</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>test <span class="op">&lt;-</span> rbind(test_old, random_data)</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>random_data <span class="op">&lt;-</span> data.frame(</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>  series_id <span class="op">=</span> rep(<span class="st">"038491c925aa"</span>, num_rows),</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>  step <span class="op">=</span> <span class="dv">0</span>:(num_rows<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>  timestamp <span class="op">=</span> seq(<span class="im">from</span> <span class="op">=</span> ymd_hms(<span class="st">"2020-10-13T23:45:00-0300"</span>), </span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>                  by <span class="op">=</span> <span class="st">"5 sec"</span>, length.out <span class="op">=</span> num_rows),</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>  anglez <span class="op">=</span> runif(num_rows, <span class="bu">min</span> <span class="op">=</span> <span class="dv">0</span>, <span class="bu">max</span> <span class="op">=</span> <span class="dv">5</span>),  <span class="co"># Random values between 0 and 5</span></span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>  enmo <span class="op">=</span> runif(num_rows, <span class="bu">min</span> <span class="op">=</span> <span class="dv">0</span>, <span class="bu">max</span> <span class="op">=</span> <span class="fl">0.05</span>)  <span class="co"># Random values between 0 and 0.05</span></span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timestamps to character</span></span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>random_data$timestamp <span class="op">&lt;-</span> <span class="bu">format</span>(random_data$timestamp, <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">T%H:%M:%S-0500"</span>)</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>test <span class="op">&lt;-</span> rbind(test, random_data)</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>random_data <span class="op">&lt;-</span> data.frame(</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>  series_id <span class="op">=</span> rep(<span class="st">"038491c925aa"</span>, num_rows),</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>  step <span class="op">=</span> <span class="dv">0</span>:(num_rows<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>  timestamp <span class="op">=</span> seq(<span class="im">from</span> <span class="op">=</span> ymd_hms(<span class="st">"2021-02-13T02:36:00-0400"</span>), </span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>                  by <span class="op">=</span> <span class="st">"5 sec"</span>, length.out <span class="op">=</span> num_rows),</span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>  anglez <span class="op">=</span> runif(num_rows, <span class="bu">min</span> <span class="op">=</span> <span class="dv">0</span>, <span class="bu">max</span> <span class="op">=</span> <span class="dv">5</span>),  <span class="co"># Random values between 0 and 5</span></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>  enmo <span class="op">=</span> runif(num_rows, <span class="bu">min</span> <span class="op">=</span> <span class="dv">0</span>, <span class="bu">max</span> <span class="op">=</span> <span class="fl">0.05</span>)  <span class="co"># Random values between 0 and 0.05</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert timestamps to character</span></span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>random_data$timestamp <span class="op">&lt;-</span> <span class="bu">format</span>(random_data$timestamp, <span class="bu">format</span><span class="op">=</span><span class="st">"%Y-%m-</span><span class="sc">%d</span><span class="st">T%H:%M:%S-0500"</span>)</span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a>test <span class="op">&lt;-</span> rbind(test, random_data)</span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>test <span class="op">&lt;-</span> test  <span class="op">%&gt;%</span> </span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>        mutate(dt <span class="op">=</span> as_datetime(timestamp)) <span class="op">%&gt;%</span> </span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>        mutate(dt <span class="op">=</span> dt <span class="op">-</span> hours(<span class="dv">4</span>)) <span class="op">%&gt;%</span> </span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>        mutate(hr <span class="op">=</span> hour(dt)) <span class="op">%&gt;%</span></span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>        mutate(step <span class="op">=</span> hr<span class="op">*</span><span class="dv">60</span><span class="op">+</span>step) <span class="op">%&gt;%</span></span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>        select(<span class="op">-</span>timestamp,<span class="op">-</span>dt)</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>head(test)</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span>.seed(<span class="dv">123</span>)</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>split <span class="op">&lt;-</span> createDataPartition(training_data$awake, p <span class="op">=</span> <span class="fl">0.8</span>, <span class="bu">list</span> <span class="op">=</span> FALSE)</span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>training_set <span class="op">&lt;-</span> training_data[split, ]</span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>training_set$awake <span class="op">&lt;-</span> <span class="im">as</span>.factor(training_set$awake)</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>testing_set <span class="op">&lt;-</span> training_data[<span class="op">-</span>split, ]</span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>testing_set$awake <span class="op">&lt;-</span> <span class="im">as</span>.factor(testing_set$awake)</span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>preprocessing_method <span class="op">&lt;-</span> <span class="st">"standardize"</span>  <span class="co"># or "normalize"</span></span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>preprocess_params <span class="op">&lt;-</span>  preProcess(training_set, method <span class="op">=</span> ifelse(preprocessing_method <span class="op">==</span> <span class="st">"standardize"</span>, c(<span class="st">"center"</span>, <span class="st">"scale"</span>), c(<span class="st">"range"</span>)))</span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>saveRDS(preprocess_params, <span class="bu">file</span> <span class="op">=</span> <span class="st">"preprocess_params.rds"</span>)</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>preprocessed_training_set <span class="op">&lt;-</span> predict(preprocess_params, training_set)</span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a data frame to store results</span></span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">&lt;-</span> data.frame(ntree <span class="op">=</span> integer(), mtry <span class="op">=</span> integer(), OOBError <span class="op">=</span> numeric())</span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the range for mtry and ntree</span></span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>mtry_range <span class="op">&lt;-</span> seq(<span class="dv">1</span>, ncol(preprocessed_training_set) <span class="op">-</span> <span class="dv">1</span>, by<span class="op">=</span><span class="dv">1</span>)  <span class="co"># Full range for predictors</span></span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>ntree_range <span class="op">&lt;-</span> seq(<span class="dv">100</span>, <span class="dv">550</span>, by<span class="op">=</span><span class="dv">5</span>)  <span class="co"># range for ntree</span></span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over mtry and ntree values</span></span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (mtry <span class="kw">in</span> mtry_range) {</span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (ntree <span class="kw">in</span> ntree_range) {</span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>    <span class="bu">set</span>.seed(<span class="dv">123</span>)</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>    model <span class="op">&lt;-</span> randomForest(awake <span class="op">~</span> ., data <span class="op">=</span> preprocessed_training_set, mtry <span class="op">=</span> mtry, ntree <span class="op">=</span> ntree, do.trace<span class="op">=</span>FALSE)</span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract OOB error rate</span></span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>    OOBError <span class="op">&lt;-</span> model$err.rate[nrow(model$err.rate), <span class="st">"OOB"</span>]</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store results</span></span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">&lt;-</span> rbind(results_df, data.frame(ntree <span class="op">=</span> ntree, mtry <span class="op">=</span> mtry, OOBError <span class="op">=</span> OOBError))</span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if results_df is empty or has NA values</span></span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (nrow(results_df) <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> <span class="bu">any</span>(<span class="kw">is</span>.na(results_df$OOBError))) {</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>  stop(<span class="st">"No data to plot. Check the random forest model training."</span>)</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot accuracy vs. mtry (plot accuracy for different mtry at a fixed ntree)</span></span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate accuracy from the OOB error rate</span></span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>results_df$Accuracy <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">-</span> results_df$OOBError</span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>accuracy_plot <span class="op">&lt;-</span> ggplot(subset(results_df, ntree <span class="op">==</span> <span class="dv">550</span>), aes(x <span class="op">=</span> mtry, y <span class="op">=</span> Accuracy)) <span class="op">+</span></span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>  geom_line() <span class="op">+</span></span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>  geom_point() <span class="op">+</span></span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"Attempt1: max experimental ntree"</span>,</span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> <span class="st">"#Randomly Selected Predictors"</span>,</span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>       y <span class="op">=</span> <span class="st">"Accuracy (Cross-validation)"</span>)</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(accuracy_plot)</span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the results for mtry = 2 and mtry = 3</span></span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="op">&lt;-</span> results_df[results_df$mtry <span class="op">%</span><span class="kw">in</span><span class="op">%</span> c(<span class="dv">2</span>, <span class="dv">3</span>), ]</span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a><span class="co"># Find local minima for each mtry group</span></span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>local_minima <span class="op">&lt;-</span> filtered_df <span class="op">%&gt;%</span></span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>  group_by(mtry) <span class="op">%&gt;%</span></span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>  <span class="bu">slice</span>(which(diff(sign(diff(OOBError))) <span class="op">==</span> <span class="dv">2</span>) <span class="op">+</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>  ungroup()</span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>specific_minima <span class="op">&lt;-</span> local_minima[<span class="dv">5</span>, ]</span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>label_point <span class="op">&lt;-</span> data.frame(</span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>  ntree <span class="op">=</span> <span class="dv">335</span>,</span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>  OOBError <span class="op">=</span> <span class="fl">0.01732673</span>,</span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>  label <span class="op">=</span> <span class="st">"ntree: 335</span><span class="ch">\n</span><span class="st">Error: 0.0173"</span>)</span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot OOB error rates for mtry = 2 and mtry = 3</span></span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>oob_error_plot <span class="op">&lt;-</span> ggplot(filtered_df, aes(x <span class="op">=</span> ntree, y <span class="op">=</span> OOBError, color <span class="op">=</span> <span class="im">as</span>.factor(mtry), group <span class="op">=</span> mtry)) <span class="op">+</span></span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>  geom_smooth() <span class="op">+</span></span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>  geom_point(data <span class="op">=</span> specific_minima, aes(x <span class="op">=</span> ntree, y <span class="op">=</span> OOBError), color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="dv">5</span>, shape <span class="op">=</span> <span class="dv">21</span>, fill <span class="op">=</span> <span class="st">"blue"</span>) <span class="op">+</span></span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>  geom_text(data <span class="op">=</span> label_point, aes(x <span class="op">=</span> ntree, y <span class="op">=</span> OOBError, label <span class="op">=</span> label), nudge_y <span class="op">=</span> <span class="fl">0.001</span>, hjust <span class="op">=</span> <span class="dv">0</span>, vjust <span class="op">=</span> <span class="dv">0</span>, color <span class="op">=</span> <span class="st">"black"</span>) <span class="op">+</span></span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>  xlab(<span class="st">"Number of Trees"</span>) <span class="op">+</span></span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>  ylab(<span class="st">"Out-of-Bag Error Rate"</span>) <span class="op">+</span></span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>  ggtitle(<span class="st">"Error Rate Over mtry = 2 and 3"</span>) <span class="op">+</span></span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>  scale_color_manual(values <span class="op">=</span> c(<span class="st">"red"</span>, <span class="st">"yellow"</span>), labels <span class="op">=</span> c(<span class="st">"mtry = 2"</span>, <span class="st">"mtry = 3"</span>)) <span class="op">+</span></span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>  theme_minimal()</span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(oob_error_plot)</span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>results_df$Accuracy <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">-</span> results_df$OOBError</span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>accuracy_plot2 <span class="op">&lt;-</span> ggplot(subset(results_df, ntree <span class="op">==</span> <span class="dv">335</span>), aes(x <span class="op">=</span> mtry, y <span class="op">=</span> Accuracy)) <span class="op">+</span></span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>  geom_line() <span class="op">+</span></span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>  geom_point() <span class="op">+</span></span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>  labs(title <span class="op">=</span> <span class="st">"Attempt2: ntree=335"</span>,</span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a>       x <span class="op">=</span> <span class="st">"#Randomly Selected Predictors"</span>,</span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>       y <span class="op">=</span> <span class="st">"Accuracy (Cross-validation)"</span>)</span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(accuracy_plot2)</span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>accuracy_plot <span class="op">&lt;-</span> accuracy_plot<span class="op">+</span>labs(caption <span class="op">=</span> <span class="st">"Figure3.1"</span>)<span class="op">+</span>theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>oob_error_plot <span class="op">&lt;-</span> oob_error_plot<span class="op">+</span>labs(caption <span class="op">=</span> <span class="st">"Figure4"</span>)<span class="op">+</span>theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>accuracy_plot2 <span class="op">&lt;-</span> accuracy_plot2<span class="op">+</span>labs(caption <span class="op">=</span> <span class="st">"Figure3.2"</span>)<span class="op">+</span>theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>hyperparam_plot <span class="op">&lt;-</span> accuracy_plot<span class="op">+</span>oob_error_plot<span class="op">+</span>accuracy_plot2</span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>                 plot_layout(nrow <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>hyperparam_plot</span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>preprocessed_training_set$awake <span class="op">&lt;-</span> <span class="im">as</span>.factor(preprocessed_training_set$awake)</span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>model <span class="op">&lt;-</span> randomForest(awake <span class="op">~</span> ., data <span class="op">=</span> preprocessed_training_set, ntree <span class="op">=</span> <span class="dv">335</span>, mtry <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>saveRDS(model, <span class="bu">file</span> <span class="op">=</span> <span class="st">"ReducRFmodel.rds"</span>)</span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate training accuracy</span></span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>confusion_matrix <span class="op">&lt;-</span> model$confusion</span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>training_accuracy <span class="op">&lt;-</span> <span class="bu">sum</span>(diag(confusion_matrix)) <span class="op">/</span> <span class="bu">sum</span>(confusion_matrix)</span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusion_matrix)</span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"Training Accuracy:"</span>, training_accuracy))</span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>oob_error <span class="op">&lt;-</span> model$err.rate[nrow(model$err.rate), <span class="st">"OOB"</span>]</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a>training_oob_accuracy <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">-</span> oob_error</span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"OOB Error Rate:"</span>, oob_error))</span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"Training OOB Accuracy:"</span>, training_oob_accuracy))</span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>preprocess_params <span class="op">&lt;-</span> readRDS(<span class="bu">file</span> <span class="op">=</span> <span class="st">"preprocess_params.rds"</span>)</span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the same preprocessing to the test data</span></span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a>preprocessed_testing_set <span class="op">&lt;-</span> predict(preprocess_params, testing_set)</span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure that 'predict' function returns probabilities</span></span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>testing_set_probs <span class="op">&lt;-</span> predict(model, preprocessed_testing_set, <span class="bu">type</span> <span class="op">=</span> <span class="st">"prob"</span>)</span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract probabilities for the positive class ( '1' is the positive class)</span></span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>positive_class_probs <span class="op">&lt;-</span> testing_set_probs[, <span class="st">"1"</span>]</span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ROC object</span></span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>roc_obj <span class="op">&lt;-</span> roc(preprocessed_testing_set$awake, positive_class_probs)</span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the AUC</span></span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>auc_value <span class="op">&lt;-</span> auc(roc_obj)</span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(auc_value)</span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ROC curve along with AUC</span></span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>plot(roc_obj, main<span class="op">=</span>paste(<span class="st">"ROC Curve, AUC ="</span>, <span class="bu">round</span>(auc_value, <span class="dv">6</span>)))</span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>write.csv(testing_set, <span class="st">"testing_set.csv"</span>, row.names <span class="op">=</span> FALSE)</span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>write.csv(testing_set_probs, <span class="st">"testing_set_probs.csv"</span>, row.names <span class="op">=</span> FALSE)</span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a><span class="co"># Extracting predicted class labels with a threshold. I use 0.5 here</span></span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>predicted_labels <span class="op">&lt;-</span> ifelse(testing_set_probs[, <span class="st">"1"</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Confusion Matrix</span></span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>confusionMatrix <span class="op">&lt;-</span> confusionMatrix(factor(predicted_labels), factor(preprocessed_testing_set$awake))</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the Confusion Matrix</span></span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusionMatrix)</span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Precision, Recall, and F1 Score</span></span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>precision <span class="op">&lt;-</span> posPredValue(factor(predicted_labels), factor(preprocessed_testing_set$awake))</span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>recall <span class="op">&lt;-</span> sensitivity(factor(predicted_labels), factor(preprocessed_testing_set$awake))</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>f1_score <span class="op">&lt;-</span> <span class="dv">2</span> <span class="op">*</span> ((precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall))</span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the metrics</span></span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"Precision:"</span>, precision))</span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"Recall:"</span>, recall))</span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"F1 Score:"</span>, f1_score))</span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract feature importance</span></span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>importance <span class="op">&lt;-</span> importance(model)</span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>colnames(importance)</span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>feature_importance <span class="op">&lt;-</span> data.frame(</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>  Feature <span class="op">=</span> rownames(importance),</span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>  Importance <span class="op">=</span> importance[, <span class="st">"MeanDecreaseGini"</span>]</span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using ggplot2</span></span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>rf_feature_importance_plot <span class="op">&lt;-</span> ggplot(feature_importance, aes(x <span class="op">=</span> reorder(Feature, Importance), y <span class="op">=</span> Importance)) <span class="op">+</span></span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>  geom_bar(stat <span class="op">=</span> <span class="st">"identity"</span>) <span class="op">+</span></span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>  coord_flip() <span class="op">+</span>  <span class="co"># Flips the axes for horizontal bars</span></span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>  xlab(<span class="st">"Feature"</span>) <span class="op">+</span></span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>  ylab(<span class="st">"MeanDecreaseGini"</span>) <span class="op">+</span></span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>  ggtitle(<span class="st">"Feature Importance from Random Forest Model"</span>) <span class="op">+</span></span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>  theme_minimal()</span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>preprocess_params <span class="op">&lt;-</span> readRDS(<span class="bu">file</span> <span class="op">=</span> <span class="st">"preprocess_params.rds"</span>)</span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the same preprocessing to the test data</span></span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>preprocessed_test <span class="op">&lt;-</span> predict(preprocess_params, test)</span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probabilities</span></span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a><span class="co"># This returns a matrix with probabilities for each class</span></span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>prob_predictions <span class="op">&lt;-</span> predict(model, newdata <span class="op">=</span> preprocessed_test, <span class="bu">type</span> <span class="op">=</span> <span class="st">"prob"</span>)</span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the predicted class based on the higher probability</span></span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a><span class="co"># And extract the corresponding confidence score</span></span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>test$predicted_event <span class="op">&lt;-</span> <span class="bu">apply</span>(prob_predictions, <span class="dv">1</span>, function(x) names(x)[which.<span class="bu">max</span>(x)])</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>test$confidence_score <span class="op">&lt;-</span> <span class="bu">apply</span>(prob_predictions, <span class="dv">1</span>, <span class="bu">max</span>)</span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare submission data frame and Write</span></span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>submission <span class="op">&lt;-</span> test <span class="op">%&gt;%</span></span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>  select(series_id, step, predicted_event, confidence_score)</span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a>write.csv(submission, <span class="st">"submission.csv"</span>, row.names <span class="op">=</span> FALSE)</span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict probabilities</span></span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a>prob_predictions <span class="op">&lt;-</span> predict(model, newdata <span class="op">=</span> preprocessed_test, <span class="bu">type</span> <span class="op">=</span> <span class="st">"prob"</span>)</span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a><span class="co"># Add predicted probabilities to the test data</span></span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>test$onset_confidence <span class="op">&lt;-</span> prob_predictions[,<span class="st">"1"</span>] </span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>test$wakeup_confidence <span class="op">&lt;-</span> prob_predictions[,<span class="st">"0"</span>]</span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the most likely onset and wakeup for each series_id</span></span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a><span class="co"># For each series_id, find the step with the highest confidence for onset and wakeup</span></span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>final_selection <span class="op">&lt;-</span> test <span class="op">%&gt;%</span></span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>  group_by(series_id) <span class="op">%&gt;%</span></span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a>  summarize(</span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>    onset_step <span class="op">=</span> step[which.<span class="bu">max</span>(onset_confidence)],</span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>    onset_score <span class="op">=</span> <span class="bu">max</span>(onset_confidence),</span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>    wakeup_step <span class="op">=</span> step[which.<span class="bu">max</span>(wakeup_confidence)],</span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>    wakeup_score <span class="op">=</span> <span class="bu">max</span>(wakeup_confidence)</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>  ungroup()</span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape the data for submission</span></span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a>final_submission <span class="op">&lt;-</span> final_selection <span class="op">%&gt;%</span></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a>  select(series_id, onset_step, onset_score, wakeup_step, wakeup_score) <span class="op">%&gt;%</span></span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a>  pivot_longer(</span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> c(onset_step, wakeup_step),</span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>    names_to <span class="op">=</span> <span class="st">"event_type"</span>,</span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>    values_to <span class="op">=</span> <span class="st">"step"</span></span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>  mutate(</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>    event <span class="op">=</span> ifelse(event_type <span class="op">==</span> <span class="st">"onset_step"</span>, <span class="st">"onset"</span>, <span class="st">"wakeup"</span>),</span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> ifelse(event_type <span class="op">==</span> <span class="st">"onset_step"</span>, onset_score, wakeup_score)</span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">%&gt;%</span></span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>  select(<span class="op">-</span>event_type, <span class="op">-</span>onset_score, <span class="op">-</span>wakeup_score)</span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign row_id</span></span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a>final_submission <span class="op">&lt;-</span> final_submission <span class="op">%&gt;%</span></span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>  mutate(row_id <span class="op">=</span> row_number() <span class="op">-</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a>  select(row_id, everything())</span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the mean values used for centering</span></span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>step_mean <span class="op">&lt;-</span> preprocess_params$mean[<span class="st">"step"</span>]</span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Write submission file</span></span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a>write.csv(final_submission, <span class="st">"final_submission.csv"</span>, row.names <span class="op">=</span> FALSE)</span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a><span class="co"># # Filter function</span></span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a><span class="co"># # Define feature columns used in the model</span></span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a><span class="co"># feature_cols &lt;- c("series_id", "step", "anglez", "enmo", "hr")  # Include 'step' and other features</span></span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a><span class="co"># # Loop over each series ID</span></span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a><span class="co"># unique_series_ids&lt;-unique(preprocessed_test$series_id)</span></span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a><span class="co"># for (series_id in unique_series_ids) {</span></span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a><span class="co">#     series_data &lt;- preprocessed_test %&gt;% filter(series_id == series_id)</span></span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Predict events</span></span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a><span class="co">#     preds &lt;- predict(model, newdata = series_data[feature_cols])</span></span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Detect sleep onsets and wakeups</span></span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a><span class="co">#     pred_changes &lt;- c(FALSE, diff(preds) != 0)</span></span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a><span class="co">#     pred_onsets &lt;- series_data$step[preds == 1 &amp; pred_changes]</span></span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a><span class="co">#     pred_wakeups &lt;- series_data$step[preds == 0 &amp; pred_changes]</span></span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Filter and score events</span></span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a><span class="co">#     valid_periods &lt;- which(pred_wakeups - pred_onsets &gt;= 12 * 30)  # Adjust threshold as needed</span></span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (length(valid_periods) &gt; 0) {</span></span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a><span class="co">#         for (i in valid_periods) {</span></span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a><span class="co">#             onset_step &lt;- pred_onsets[i]</span></span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a><span class="co">#             wakeup_step &lt;- pred_wakeups[i]</span></span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a><span class="co">#             score &lt;- mean(series_data$onset_confidence[onset_step:wakeup_step], na.rm = TRUE)</span></span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a><span class="co">#             </span></span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a><span class="co">#             # Add to final submission</span></span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a><span class="co">#             final_submission &lt;- rbind(final_submission, data.frame(</span></span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a><span class="co">#                 series_id = series_id,</span></span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a><span class="co">#                 onset_step = onset_step,</span></span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a><span class="co">#                 wakeup_step = wakeup_step,</span></span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a><span class="co">#                 score = score</span></span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a><span class="co">#             ))</span></span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a>final_submission</span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>library(reticulate)</span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a>use_condaenv(<span class="st">"env"</span>, required <span class="op">=</span> TRUE)</span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a><span class="co">"""Event Detection Average Precision</span></span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a><span class="co">An average precision metric for event detection in time series and</span></span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a><span class="co">video.</span></span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas.api.types</span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple</span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParticipantVisibleError(<span class="pp">Exception</span>):</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a><span class="co"># Set some placeholders for global parameters</span></span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a>series_id_column_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a>time_column_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a>event_column_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a>score_column_name <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a>use_scoring_intervals <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score(</span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a>        solution: pd.DataFrame,</span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a>        submission: pd.DataFrame,</span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a>        tolerances: Dict[<span class="bu">str</span>, List[<span class="bu">float</span>]],</span>
<span id="cb7-474"><a href="#cb7-474" aria-hidden="true" tabindex="-1"></a>        series_id_column_name: <span class="bu">str</span>,</span>
<span id="cb7-475"><a href="#cb7-475" aria-hidden="true" tabindex="-1"></a>        time_column_name: <span class="bu">str</span>,</span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a>        event_column_name: <span class="bu">str</span>,</span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a>        score_column_name: <span class="bu">str</span>,</span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a>        use_scoring_intervals: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Event Detection Average Precision, an AUCPR metric for event detection in</span></span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a><span class="co">    time series and video.</span></span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a><span class="co">    This metric is similar to IOU-threshold average precision metrics commonly</span></span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a><span class="co">    used in object detection. For events occuring in time series, we replace the</span></span>
<span id="cb7-485"><a href="#cb7-485" aria-hidden="true" tabindex="-1"></a><span class="co">    IOU threshold with a time tolerance.</span></span>
<span id="cb7-486"><a href="#cb7-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a><span class="co">    Submissions are evaluated on the average precision of detected events,</span></span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a><span class="co">    averaged over timestamp error tolerance thresholds, averaged over event</span></span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a><span class="co">    classes.</span></span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a><span class="co">    Detections are matched to ground-truth events within error tolerances, with</span></span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a><span class="co">    ambiguities resolved in order of decreasing confidence.</span></span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a><span class="co">    Detailed Description</span></span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a><span class="co">    --------------------</span></span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluation proceeds in four steps:</span></span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Selection - (optional) Predictions not within a series' scoring</span></span>
<span id="cb7-499"><a href="#cb7-499" aria-hidden="true" tabindex="-1"></a><span class="co">    intervals are dropped.</span></span>
<span id="cb7-500"><a href="#cb7-500" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Assignment - Predicted events are matched with ground-truth events.</span></span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Scoring - Each group of predictions is scored against its corresponding</span></span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a><span class="co">    group of ground-truth events via Average Precision.</span></span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Reduction - The multiple AP scores are averaged to produce a single</span></span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a><span class="co">    overall score.</span></span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a><span class="co">    Selection</span></span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-508"><a href="#cb7-508" aria-hidden="true" tabindex="-1"></a><span class="co">    With each series there may be a defined set of scoring intervals giving the</span></span>
<span id="cb7-509"><a href="#cb7-509" aria-hidden="true" tabindex="-1"></a><span class="co">    intervals of time over which zero or more ground-truth events might be</span></span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a><span class="co">    annotated in that series. A prediction will be evaluated only if it falls</span></span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a><span class="co">    within a scoring interval. These scoring intervals can be chosen to improve</span></span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a><span class="co">    the fairness of evaluation by, for instance, ignoring edge-cases or</span></span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a><span class="co">    ambiguous events.</span></span>
<span id="cb7-514"><a href="#cb7-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-515"><a href="#cb7-515" aria-hidden="true" tabindex="-1"></a><span class="co">    It is recommended that, if used, scoring intervals be provided for training</span></span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a><span class="co">    data but not test data.</span></span>
<span id="cb7-517"><a href="#cb7-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-518"><a href="#cb7-518" aria-hidden="true" tabindex="-1"></a><span class="co">    Assignment</span></span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a><span class="co">    For each set of predictions and ground-truths within the same `event x</span></span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a><span class="co">    tolerance x series_id` group, we match each ground-truth to the</span></span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a><span class="co">    highest-confidence unmatched prediction occurring within the allowed</span></span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a><span class="co">    tolerance.</span></span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a><span class="co">    Some ground-truths may not be matched to a prediction and some predictions</span></span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a><span class="co">    may not be matched to a ground-truth. They will still be accounted for in</span></span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a><span class="co">    the scoring, however.</span></span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a><span class="co">    Scoring</span></span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a><span class="co">    Collecting the events within each `series_id`, we compute an Average</span></span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a><span class="co">    Precision score for each `event x tolerance` group. The average precision</span></span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a><span class="co">    score is the area under the (step-wise) precision-recall curve generated by</span></span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a><span class="co">    decreasing confidence score thresholds over the predictions. In this</span></span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a><span class="co">    calculation, matched predictions over the threshold are scored as TP and</span></span>
<span id="cb7-536"><a href="#cb7-536" aria-hidden="true" tabindex="-1"></a><span class="co">    unmatched predictions as FP. Unmatched ground-truths are scored as FN.</span></span>
<span id="cb7-537"><a href="#cb7-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a><span class="co">    Reduction</span></span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a><span class="co">    The final score is the average of the above AP scores, first averaged over</span></span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a><span class="co">    tolerance, then over event.</span></span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-543"><a href="#cb7-543" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb7-544"><a href="#cb7-544" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb7-545"><a href="#cb7-545" aria-hidden="true" tabindex="-1"></a><span class="co">    solution : pd.DataFrame, with columns:</span></span>
<span id="cb7-546"><a href="#cb7-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-547"><a href="#cb7-547" aria-hidden="true" tabindex="-1"></a><span class="co">        `series_id_column_name` identifier for each time series</span></span>
<span id="cb7-548"><a href="#cb7-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-549"><a href="#cb7-549" aria-hidden="true" tabindex="-1"></a><span class="co">        `time_column_name` the time of occurence for each event as a numeric type</span></span>
<span id="cb7-550"><a href="#cb7-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-551"><a href="#cb7-551" aria-hidden="true" tabindex="-1"></a><span class="co">        `event_column_name` class label for each event</span></span>
<span id="cb7-552"><a href="#cb7-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-553"><a href="#cb7-553" aria-hidden="true" tabindex="-1"></a><span class="co">        The solution contains the time of occurence of one or more types of</span></span>
<span id="cb7-554"><a href="#cb7-554" aria-hidden="true" tabindex="-1"></a><span class="co">        event within one or more time series. The metric expects the solution to</span></span>
<span id="cb7-555"><a href="#cb7-555" aria-hidden="true" tabindex="-1"></a><span class="co">        contain the same event types as those given in `tolerances`.</span></span>
<span id="cb7-556"><a href="#cb7-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-557"><a href="#cb7-557" aria-hidden="true" tabindex="-1"></a><span class="co">        When `use_scoring_intervals == True`, you may include `start` and `end`</span></span>
<span id="cb7-558"><a href="#cb7-558" aria-hidden="true" tabindex="-1"></a><span class="co">        events to delimit intervals within which detections will be scored.</span></span>
<span id="cb7-559"><a href="#cb7-559" aria-hidden="true" tabindex="-1"></a><span class="co">        Detected events (from the user submission) outside of these events will</span></span>
<span id="cb7-560"><a href="#cb7-560" aria-hidden="true" tabindex="-1"></a><span class="co">        be ignored.</span></span>
<span id="cb7-561"><a href="#cb7-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-562"><a href="#cb7-562" aria-hidden="true" tabindex="-1"></a><span class="co">    submission : pd.DataFrame, with columns as above and in addition:</span></span>
<span id="cb7-563"><a href="#cb7-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-564"><a href="#cb7-564" aria-hidden="true" tabindex="-1"></a><span class="co">        `score_column_name` the predicted confidence score for the detected event</span></span>
<span id="cb7-565"><a href="#cb7-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-566"><a href="#cb7-566" aria-hidden="true" tabindex="-1"></a><span class="co">    tolerances : Dict[str, List[float]]</span></span>
<span id="cb7-567"><a href="#cb7-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-568"><a href="#cb7-568" aria-hidden="true" tabindex="-1"></a><span class="co">        Maps each event class to a list of timestamp tolerances used</span></span>
<span id="cb7-569"><a href="#cb7-569" aria-hidden="true" tabindex="-1"></a><span class="co">        for matching detections to ground-truth events.</span></span>
<span id="cb7-570"><a href="#cb7-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-571"><a href="#cb7-571" aria-hidden="true" tabindex="-1"></a><span class="co">    use_scoring_intervals: bool, default False</span></span>
<span id="cb7-572"><a href="#cb7-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-573"><a href="#cb7-573" aria-hidden="true" tabindex="-1"></a><span class="co">        Whether to ignore predicted events outside intervals delimited</span></span>
<span id="cb7-574"><a href="#cb7-574" aria-hidden="true" tabindex="-1"></a><span class="co">        by `'start'` and `'end'` events in the solution. When `False`,</span></span>
<span id="cb7-575"><a href="#cb7-575" aria-hidden="true" tabindex="-1"></a><span class="co">        the solution should not include `'start'` and `'end'` events.</span></span>
<span id="cb7-576"><a href="#cb7-576" aria-hidden="true" tabindex="-1"></a><span class="co">        See the examples for illustration.</span></span>
<span id="cb7-577"><a href="#cb7-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-578"><a href="#cb7-578" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb7-579"><a href="#cb7-579" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb7-580"><a href="#cb7-580" aria-hidden="true" tabindex="-1"></a><span class="co">    event_detection_ap : float</span></span>
<span id="cb7-581"><a href="#cb7-581" aria-hidden="true" tabindex="-1"></a><span class="co">        The mean average precision of the detected events.</span></span>
<span id="cb7-582"><a href="#cb7-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-583"><a href="#cb7-583" aria-hidden="true" tabindex="-1"></a><span class="co">    Examples</span></span>
<span id="cb7-584"><a href="#cb7-584" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb7-585"><a href="#cb7-585" aria-hidden="true" tabindex="-1"></a><span class="co">    Detecting `'pass'` events in football:</span></span>
<span id="cb7-586"><a href="#cb7-586" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; column_names = {</span></span>
<span id="cb7-587"><a href="#cb7-587" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'series_id_column_name': 'video_id',</span></span>
<span id="cb7-588"><a href="#cb7-588" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time_column_name': 'time',</span></span>
<span id="cb7-589"><a href="#cb7-589" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event_column_name': 'event',</span></span>
<span id="cb7-590"><a href="#cb7-590" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'score_column_name': 'score',</span></span>
<span id="cb7-591"><a href="#cb7-591" aria-hidden="true" tabindex="-1"></a><span class="co">    ... }</span></span>
<span id="cb7-592"><a href="#cb7-592" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; tolerances = {'pass': [1.0]}</span></span>
<span id="cb7-593"><a href="#cb7-593" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; solution = pd.DataFrame({</span></span>
<span id="cb7-594"><a href="#cb7-594" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'video_id': ['a', 'a'],</span></span>
<span id="cb7-595"><a href="#cb7-595" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event': ['pass', 'pass'],</span></span>
<span id="cb7-596"><a href="#cb7-596" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time': [0, 15],</span></span>
<span id="cb7-597"><a href="#cb7-597" aria-hidden="true" tabindex="-1"></a><span class="co">    ... })</span></span>
<span id="cb7-598"><a href="#cb7-598" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; submission = pd.DataFrame({</span></span>
<span id="cb7-599"><a href="#cb7-599" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'video_id': ['a', 'a', 'a'],</span></span>
<span id="cb7-600"><a href="#cb7-600" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event': ['pass', 'pass', 'pass'],</span></span>
<span id="cb7-601"><a href="#cb7-601" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'score': [1.0, 0.5, 1.0],</span></span>
<span id="cb7-602"><a href="#cb7-602" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time': [0, 10, 14.5],</span></span>
<span id="cb7-603"><a href="#cb7-603" aria-hidden="true" tabindex="-1"></a><span class="co">    ... })</span></span>
<span id="cb7-604"><a href="#cb7-604" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb7-605"><a href="#cb7-605" aria-hidden="true" tabindex="-1"></a><span class="co">    1.0</span></span>
<span id="cb7-606"><a href="#cb7-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-607"><a href="#cb7-607" aria-hidden="true" tabindex="-1"></a><span class="co">    Increasing the confidence score of the false detection above the true</span></span>
<span id="cb7-608"><a href="#cb7-608" aria-hidden="true" tabindex="-1"></a><span class="co">    detections decreases the AP.</span></span>
<span id="cb7-609"><a href="#cb7-609" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; submission.loc[1, 'score'] = 1.5</span></span>
<span id="cb7-610"><a href="#cb7-610" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb7-611"><a href="#cb7-611" aria-hidden="true" tabindex="-1"></a><span class="co">    0.6666666666666666...</span></span>
<span id="cb7-612"><a href="#cb7-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-613"><a href="#cb7-613" aria-hidden="true" tabindex="-1"></a><span class="co">    Likewise, decreasing the confidence score of a true detection below the</span></span>
<span id="cb7-614"><a href="#cb7-614" aria-hidden="true" tabindex="-1"></a><span class="co">    false detection also decreases the AP.</span></span>
<span id="cb7-615"><a href="#cb7-615" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; submission.loc[1, 'score'] = 0.5  # reset</span></span>
<span id="cb7-616"><a href="#cb7-616" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; submission.loc[0, 'score'] = 0.0</span></span>
<span id="cb7-617"><a href="#cb7-617" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb7-618"><a href="#cb7-618" aria-hidden="true" tabindex="-1"></a><span class="co">    0.8333333333333333...</span></span>
<span id="cb7-619"><a href="#cb7-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-620"><a href="#cb7-620" aria-hidden="true" tabindex="-1"></a><span class="co">    We average AP scores over tolerances. Previously, the detection at 14.5</span></span>
<span id="cb7-621"><a href="#cb7-621" aria-hidden="true" tabindex="-1"></a><span class="co">    would match, but adding smaller tolerances gives AP scores where it does</span></span>
<span id="cb7-622"><a href="#cb7-622" aria-hidden="true" tabindex="-1"></a><span class="co">    not match. This results in both a FN, since the ground-truth wasn't</span></span>
<span id="cb7-623"><a href="#cb7-623" aria-hidden="true" tabindex="-1"></a><span class="co">    detected, and a FP, since the detected event matches no ground-truth.</span></span>
<span id="cb7-624"><a href="#cb7-624" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; tolerances = {'pass': [0.1, 0.2, 1.0]}</span></span>
<span id="cb7-625"><a href="#cb7-625" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb7-626"><a href="#cb7-626" aria-hidden="true" tabindex="-1"></a><span class="co">    0.3888888888888888...</span></span>
<span id="cb7-627"><a href="#cb7-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-628"><a href="#cb7-628" aria-hidden="true" tabindex="-1"></a><span class="co">    We also average over time series and over event classes.</span></span>
<span id="cb7-629"><a href="#cb7-629" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; tolerances = {'pass': [0.5, 1.0], 'challenge': [0.25, 0.50]}</span></span>
<span id="cb7-630"><a href="#cb7-630" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; solution = pd.DataFrame({</span></span>
<span id="cb7-631"><a href="#cb7-631" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'video_id': ['a', 'a', 'b'],</span></span>
<span id="cb7-632"><a href="#cb7-632" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event': ['pass', 'challenge', 'pass'],</span></span>
<span id="cb7-633"><a href="#cb7-633" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time': [0, 15, 0],  # restart time for new time series b</span></span>
<span id="cb7-634"><a href="#cb7-634" aria-hidden="true" tabindex="-1"></a><span class="co">    ... })</span></span>
<span id="cb7-635"><a href="#cb7-635" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; submission = pd.DataFrame({</span></span>
<span id="cb7-636"><a href="#cb7-636" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'video_id': ['a', 'a', 'b'],</span></span>
<span id="cb7-637"><a href="#cb7-637" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event': ['pass', 'challenge', 'pass'],</span></span>
<span id="cb7-638"><a href="#cb7-638" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'score': [1.0, 0.5, 1.0],</span></span>
<span id="cb7-639"><a href="#cb7-639" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time': [0, 15, 0],</span></span>
<span id="cb7-640"><a href="#cb7-640" aria-hidden="true" tabindex="-1"></a><span class="co">    ... })</span></span>
<span id="cb7-641"><a href="#cb7-641" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names)</span></span>
<span id="cb7-642"><a href="#cb7-642" aria-hidden="true" tabindex="-1"></a><span class="co">    1.0</span></span>
<span id="cb7-643"><a href="#cb7-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-644"><a href="#cb7-644" aria-hidden="true" tabindex="-1"></a><span class="co">    By adding scoring intervals to the solution, we may choose to ignore</span></span>
<span id="cb7-645"><a href="#cb7-645" aria-hidden="true" tabindex="-1"></a><span class="co">    detections outside of those intervals.</span></span>
<span id="cb7-646"><a href="#cb7-646" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; tolerances = {'pass': [1.0]}</span></span>
<span id="cb7-647"><a href="#cb7-647" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; solution = pd.DataFrame({</span></span>
<span id="cb7-648"><a href="#cb7-648" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'video_id': ['a', 'a', 'a', 'a'],</span></span>
<span id="cb7-649"><a href="#cb7-649" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event': ['start', 'pass', 'pass', 'end'],</span></span>
<span id="cb7-650"><a href="#cb7-650" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time': [0, 10, 20, 30],</span></span>
<span id="cb7-651"><a href="#cb7-651" aria-hidden="true" tabindex="-1"></a><span class="co">    ... })</span></span>
<span id="cb7-652"><a href="#cb7-652" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; submission = pd.DataFrame({</span></span>
<span id="cb7-653"><a href="#cb7-653" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'video_id': ['a', 'a', 'a'],</span></span>
<span id="cb7-654"><a href="#cb7-654" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'event': ['pass', 'pass', 'pass'],</span></span>
<span id="cb7-655"><a href="#cb7-655" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'score': [1.0, 1.0, 1.0],</span></span>
<span id="cb7-656"><a href="#cb7-656" aria-hidden="true" tabindex="-1"></a><span class="co">    ...     'time': [10, 20, 40],</span></span>
<span id="cb7-657"><a href="#cb7-657" aria-hidden="true" tabindex="-1"></a><span class="co">    ... })</span></span>
<span id="cb7-658"><a href="#cb7-658" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; score(solution, submission, tolerances, **column_names, use_scoring_intervals=True)</span></span>
<span id="cb7-659"><a href="#cb7-659" aria-hidden="true" tabindex="-1"></a><span class="co">    1.0</span></span>
<span id="cb7-660"><a href="#cb7-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-661"><a href="#cb7-661" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-662"><a href="#cb7-662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate metric parameters</span></span>
<span id="cb7-663"><a href="#cb7-663" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(tolerances) <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"Events must have defined tolerances."</span></span>
<span id="cb7-664"><a href="#cb7-664" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">set</span>(tolerances.keys()) <span class="op">==</span> <span class="bu">set</span>(solution[event_column_name]).difference({<span class="st">'start'</span>, <span class="st">'end'</span>}),<span class="op">\</span></span>
<span id="cb7-665"><a href="#cb7-665" aria-hidden="true" tabindex="-1"></a>        (<span class="ss">f"Solution column </span><span class="sc">{</span>event_column_name<span class="sc">}</span><span class="ss"> must contain the same events "</span></span>
<span id="cb7-666"><a href="#cb7-666" aria-hidden="true" tabindex="-1"></a>         <span class="st">"as defined in tolerances."</span>)</span>
<span id="cb7-667"><a href="#cb7-667" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> pd.api.types.is_numeric_dtype(solution[time_column_name]),<span class="op">\</span></span>
<span id="cb7-668"><a href="#cb7-668" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Solution column </span><span class="sc">{</span>time_column_name<span class="sc">}</span><span class="ss"> must be of numeric type."</span></span>
<span id="cb7-669"><a href="#cb7-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-670"><a href="#cb7-670" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate submission format</span></span>
<span id="cb7-671"><a href="#cb7-671" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> column_name <span class="kw">in</span> [</span>
<span id="cb7-672"><a href="#cb7-672" aria-hidden="true" tabindex="-1"></a>        series_id_column_name,</span>
<span id="cb7-673"><a href="#cb7-673" aria-hidden="true" tabindex="-1"></a>        time_column_name,</span>
<span id="cb7-674"><a href="#cb7-674" aria-hidden="true" tabindex="-1"></a>        event_column_name,</span>
<span id="cb7-675"><a href="#cb7-675" aria-hidden="true" tabindex="-1"></a>        score_column_name,</span>
<span id="cb7-676"><a href="#cb7-676" aria-hidden="true" tabindex="-1"></a>    ]:</span>
<span id="cb7-677"><a href="#cb7-677" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> column_name <span class="kw">not</span> <span class="kw">in</span> submission.columns:</span>
<span id="cb7-678"><a href="#cb7-678" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> ParticipantVisibleError(<span class="ss">f"Submission must have column '</span><span class="sc">{</span>column_name<span class="sc">}</span><span class="ss">'."</span>)</span>
<span id="cb7-679"><a href="#cb7-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-680"><a href="#cb7-680" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> pd.api.types.is_numeric_dtype(submission[time_column_name]):</span>
<span id="cb7-681"><a href="#cb7-681" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> ParticipantVisibleError(</span>
<span id="cb7-682"><a href="#cb7-682" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Submission column '</span><span class="sc">{</span>time_column_name<span class="sc">}</span><span class="ss">' must be of numeric type."</span></span>
<span id="cb7-683"><a href="#cb7-683" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-684"><a href="#cb7-684" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> pd.api.types.is_numeric_dtype(submission[score_column_name]):</span>
<span id="cb7-685"><a href="#cb7-685" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> ParticipantVisibleError(</span>
<span id="cb7-686"><a href="#cb7-686" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Submission column '</span><span class="sc">{</span>score_column_name<span class="sc">}</span><span class="ss">' must be of numeric type."</span></span>
<span id="cb7-687"><a href="#cb7-687" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-688"><a href="#cb7-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-689"><a href="#cb7-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set these globally to avoid passing around a bunch of arguments</span></span>
<span id="cb7-690"><a href="#cb7-690" aria-hidden="true" tabindex="-1"></a>    <span class="bu">globals</span>()[<span class="st">'series_id_column_name'</span>] <span class="op">=</span> series_id_column_name</span>
<span id="cb7-691"><a href="#cb7-691" aria-hidden="true" tabindex="-1"></a>    <span class="bu">globals</span>()[<span class="st">'time_column_name'</span>] <span class="op">=</span> time_column_name</span>
<span id="cb7-692"><a href="#cb7-692" aria-hidden="true" tabindex="-1"></a>    <span class="bu">globals</span>()[<span class="st">'event_column_name'</span>] <span class="op">=</span> event_column_name</span>
<span id="cb7-693"><a href="#cb7-693" aria-hidden="true" tabindex="-1"></a>    <span class="bu">globals</span>()[<span class="st">'score_column_name'</span>] <span class="op">=</span> score_column_name</span>
<span id="cb7-694"><a href="#cb7-694" aria-hidden="true" tabindex="-1"></a>    <span class="bu">globals</span>()[<span class="st">'use_scoring_intervals'</span>] <span class="op">=</span> use_scoring_intervals</span>
<span id="cb7-695"><a href="#cb7-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-696"><a href="#cb7-696" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> event_detection_ap(solution, submission, tolerances)</span>
<span id="cb7-697"><a href="#cb7-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-698"><a href="#cb7-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-699"><a href="#cb7-699" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_detections(</span>
<span id="cb7-700"><a href="#cb7-700" aria-hidden="true" tabindex="-1"></a>        detections: pd.DataFrame, intervals: pd.DataFrame</span>
<span id="cb7-701"><a href="#cb7-701" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb7-702"><a href="#cb7-702" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Drop detections not inside a scoring interval."""</span></span>
<span id="cb7-703"><a href="#cb7-703" aria-hidden="true" tabindex="-1"></a>    detection_time <span class="op">=</span> detections.loc[:, time_column_name].sort_values().to_numpy()</span>
<span id="cb7-704"><a href="#cb7-704" aria-hidden="true" tabindex="-1"></a>    intervals <span class="op">=</span> intervals.to_numpy()</span>
<span id="cb7-705"><a href="#cb7-705" aria-hidden="true" tabindex="-1"></a>    is_scored <span class="op">=</span> np.full_like(detection_time, <span class="va">False</span>, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb7-706"><a href="#cb7-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-707"><a href="#cb7-707" aria-hidden="true" tabindex="-1"></a>    i, j <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb7-708"><a href="#cb7-708" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(detection_time) <span class="kw">and</span> j <span class="op">&lt;</span> <span class="bu">len</span>(intervals):</span>
<span id="cb7-709"><a href="#cb7-709" aria-hidden="true" tabindex="-1"></a>        time <span class="op">=</span> detection_time[i]</span>
<span id="cb7-710"><a href="#cb7-710" aria-hidden="true" tabindex="-1"></a>        int_ <span class="op">=</span> intervals[j]</span>
<span id="cb7-711"><a href="#cb7-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-712"><a href="#cb7-712" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the detection is prior in time to the interval, go to the next detection.</span></span>
<span id="cb7-713"><a href="#cb7-713" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> time <span class="op">&lt;</span> int_.left:</span>
<span id="cb7-714"><a href="#cb7-714" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-715"><a href="#cb7-715" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the detection is inside the interval, keep it and go to the next detection.</span></span>
<span id="cb7-716"><a href="#cb7-716" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> time <span class="kw">in</span> int_:</span>
<span id="cb7-717"><a href="#cb7-717" aria-hidden="true" tabindex="-1"></a>            is_scored[i] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-718"><a href="#cb7-718" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-719"><a href="#cb7-719" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the detection is later in time, go to the next interval.</span></span>
<span id="cb7-720"><a href="#cb7-720" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-721"><a href="#cb7-721" aria-hidden="true" tabindex="-1"></a>            j <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-722"><a href="#cb7-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-723"><a href="#cb7-723" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> detections.loc[is_scored].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-724"><a href="#cb7-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-725"><a href="#cb7-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-726"><a href="#cb7-726" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> match_detections(</span>
<span id="cb7-727"><a href="#cb7-727" aria-hidden="true" tabindex="-1"></a>        tolerance: <span class="bu">float</span>, ground_truths: pd.DataFrame, detections: pd.DataFrame</span>
<span id="cb7-728"><a href="#cb7-728" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb7-729"><a href="#cb7-729" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Match detections to ground truth events. Arguments are taken from a common event x tolerance x series_id evaluation group."""</span></span>
<span id="cb7-730"><a href="#cb7-730" aria-hidden="true" tabindex="-1"></a>    detections_sorted <span class="op">=</span> detections.sort_values(score_column_name, ascending<span class="op">=</span><span class="va">False</span>).dropna()</span>
<span id="cb7-731"><a href="#cb7-731" aria-hidden="true" tabindex="-1"></a>    is_matched <span class="op">=</span> np.full_like(detections_sorted[event_column_name], <span class="va">False</span>, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb7-732"><a href="#cb7-732" aria-hidden="true" tabindex="-1"></a>    gts_matched <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb7-733"><a href="#cb7-733" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, det <span class="kw">in</span> <span class="bu">enumerate</span>(detections_sorted.itertuples(index<span class="op">=</span><span class="va">False</span>)):</span>
<span id="cb7-734"><a href="#cb7-734" aria-hidden="true" tabindex="-1"></a>        best_error <span class="op">=</span> tolerance</span>
<span id="cb7-735"><a href="#cb7-735" aria-hidden="true" tabindex="-1"></a>        best_gt <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-736"><a href="#cb7-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-737"><a href="#cb7-737" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gt <span class="kw">in</span> ground_truths.itertuples(index<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb7-738"><a href="#cb7-738" aria-hidden="true" tabindex="-1"></a>            error <span class="op">=</span> <span class="bu">abs</span>(<span class="bu">getattr</span>(det, time_column_name) <span class="op">-</span> <span class="bu">getattr</span>(gt, time_column_name))</span>
<span id="cb7-739"><a href="#cb7-739" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> error <span class="op">&lt;</span> best_error <span class="kw">and</span> gt <span class="kw">not</span> <span class="kw">in</span> gts_matched:</span>
<span id="cb7-740"><a href="#cb7-740" aria-hidden="true" tabindex="-1"></a>                best_gt <span class="op">=</span> gt</span>
<span id="cb7-741"><a href="#cb7-741" aria-hidden="true" tabindex="-1"></a>                best_error <span class="op">=</span> error</span>
<span id="cb7-742"><a href="#cb7-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-743"><a href="#cb7-743" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> best_gt <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-744"><a href="#cb7-744" aria-hidden="true" tabindex="-1"></a>            is_matched[i] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-745"><a href="#cb7-745" aria-hidden="true" tabindex="-1"></a>            gts_matched.add(best_gt)</span>
<span id="cb7-746"><a href="#cb7-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-747"><a href="#cb7-747" aria-hidden="true" tabindex="-1"></a>    detections_sorted[<span class="st">'matched'</span>] <span class="op">=</span> is_matched</span>
<span id="cb7-748"><a href="#cb7-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-749"><a href="#cb7-749" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> detections_sorted</span>
<span id="cb7-750"><a href="#cb7-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-751"><a href="#cb7-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-752"><a href="#cb7-752" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> precision_recall_curve(</span>
<span id="cb7-753"><a href="#cb7-753" aria-hidden="true" tabindex="-1"></a>        matches: np.ndarray, scores: np.ndarray, p: <span class="bu">int</span></span>
<span id="cb7-754"><a href="#cb7-754" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
<span id="cb7-755"><a href="#cb7-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(matches) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-756"><a href="#cb7-756" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [<span class="dv">1</span>], [<span class="dv">0</span>], []</span>
<span id="cb7-757"><a href="#cb7-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-758"><a href="#cb7-758" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort matches by decreasing confidence</span></span>
<span id="cb7-759"><a href="#cb7-759" aria-hidden="true" tabindex="-1"></a>    idxs <span class="op">=</span> np.argsort(scores, kind<span class="op">=</span><span class="st">'stable'</span>)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb7-760"><a href="#cb7-760" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> scores[idxs]</span>
<span id="cb7-761"><a href="#cb7-761" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> matches[idxs]</span>
<span id="cb7-762"><a href="#cb7-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-763"><a href="#cb7-763" aria-hidden="true" tabindex="-1"></a>    distinct_value_indices <span class="op">=</span> np.where(np.diff(scores))[<span class="dv">0</span>]</span>
<span id="cb7-764"><a href="#cb7-764" aria-hidden="true" tabindex="-1"></a>    threshold_idxs <span class="op">=</span> np.r_[distinct_value_indices, matches.size <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb7-765"><a href="#cb7-765" aria-hidden="true" tabindex="-1"></a>    thresholds <span class="op">=</span> scores[threshold_idxs]</span>
<span id="cb7-766"><a href="#cb7-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-767"><a href="#cb7-767" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matches become TPs and non-matches FPs as confidence threshold decreases</span></span>
<span id="cb7-768"><a href="#cb7-768" aria-hidden="true" tabindex="-1"></a>    tps <span class="op">=</span> np.cumsum(matches)[threshold_idxs]</span>
<span id="cb7-769"><a href="#cb7-769" aria-hidden="true" tabindex="-1"></a>    fps <span class="op">=</span> np.cumsum(<span class="op">~</span>matches)[threshold_idxs]</span>
<span id="cb7-770"><a href="#cb7-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-771"><a href="#cb7-771" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> tps <span class="op">/</span> (tps <span class="op">+</span> fps)</span>
<span id="cb7-772"><a href="#cb7-772" aria-hidden="true" tabindex="-1"></a>    precision[np.isnan(precision)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-773"><a href="#cb7-773" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> tps <span class="op">/</span> p  <span class="co"># total number of ground truths might be different than total number of matches</span></span>
<span id="cb7-774"><a href="#cb7-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-775"><a href="#cb7-775" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stop when full recall attained and reverse the outputs so recall is non-increasing.</span></span>
<span id="cb7-776"><a href="#cb7-776" aria-hidden="true" tabindex="-1"></a>    last_ind <span class="op">=</span> tps.searchsorted(tps[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb7-777"><a href="#cb7-777" aria-hidden="true" tabindex="-1"></a>    sl <span class="op">=</span> <span class="bu">slice</span>(last_ind, <span class="va">None</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb7-778"><a href="#cb7-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-779"><a href="#cb7-779" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final precision is 1 and final recall is 0</span></span>
<span id="cb7-780"><a href="#cb7-780" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.r_[precision[sl], <span class="dv">1</span>], np.r_[recall[sl], <span class="dv">0</span>], thresholds[sl]</span>
<span id="cb7-781"><a href="#cb7-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-782"><a href="#cb7-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-783"><a href="#cb7-783" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> average_precision_score(matches: np.ndarray, scores: np.ndarray, p: <span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-784"><a href="#cb7-784" aria-hidden="true" tabindex="-1"></a>    precision, recall, _ <span class="op">=</span> precision_recall_curve(matches, scores, p)</span>
<span id="cb7-785"><a href="#cb7-785" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute step integral</span></span>
<span id="cb7-786"><a href="#cb7-786" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>np.<span class="bu">sum</span>(np.diff(recall) <span class="op">*</span> np.array(precision)[:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb7-787"><a href="#cb7-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-788"><a href="#cb7-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-789"><a href="#cb7-789" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> event_detection_ap(</span>
<span id="cb7-790"><a href="#cb7-790" aria-hidden="true" tabindex="-1"></a>        solution: pd.DataFrame,</span>
<span id="cb7-791"><a href="#cb7-791" aria-hidden="true" tabindex="-1"></a>        submission: pd.DataFrame,</span>
<span id="cb7-792"><a href="#cb7-792" aria-hidden="true" tabindex="-1"></a>        tolerances: Dict[<span class="bu">str</span>, List[<span class="bu">float</span>]],</span>
<span id="cb7-793"><a href="#cb7-793" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-794"><a href="#cb7-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-795"><a href="#cb7-795" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure solution and submission are sorted properly</span></span>
<span id="cb7-796"><a href="#cb7-796" aria-hidden="true" tabindex="-1"></a>    solution <span class="op">=</span> solution.sort_values([series_id_column_name, time_column_name])</span>
<span id="cb7-797"><a href="#cb7-797" aria-hidden="true" tabindex="-1"></a>    submission <span class="op">=</span> submission.sort_values([series_id_column_name, time_column_name])</span>
<span id="cb7-798"><a href="#cb7-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-799"><a href="#cb7-799" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract scoring intervals.</span></span>
<span id="cb7-800"><a href="#cb7-800" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_scoring_intervals:</span>
<span id="cb7-801"><a href="#cb7-801" aria-hidden="true" tabindex="-1"></a>        intervals <span class="op">=</span> (</span>
<span id="cb7-802"><a href="#cb7-802" aria-hidden="true" tabindex="-1"></a>            solution</span>
<span id="cb7-803"><a href="#cb7-803" aria-hidden="true" tabindex="-1"></a>            .query(<span class="st">"event in ['start', 'end']"</span>)</span>
<span id="cb7-804"><a href="#cb7-804" aria-hidden="true" tabindex="-1"></a>            .assign(interval<span class="op">=</span><span class="kw">lambda</span> x: x.groupby([series_id_column_name, event_column_name]).cumcount())</span>
<span id="cb7-805"><a href="#cb7-805" aria-hidden="true" tabindex="-1"></a>            .pivot(</span>
<span id="cb7-806"><a href="#cb7-806" aria-hidden="true" tabindex="-1"></a>                index<span class="op">=</span><span class="st">'interval'</span>,</span>
<span id="cb7-807"><a href="#cb7-807" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">=</span>[series_id_column_name, event_column_name],</span>
<span id="cb7-808"><a href="#cb7-808" aria-hidden="true" tabindex="-1"></a>                values<span class="op">=</span>time_column_name,</span>
<span id="cb7-809"><a href="#cb7-809" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-810"><a href="#cb7-810" aria-hidden="true" tabindex="-1"></a>            .stack(series_id_column_name)</span>
<span id="cb7-811"><a href="#cb7-811" aria-hidden="true" tabindex="-1"></a>            .swaplevel()</span>
<span id="cb7-812"><a href="#cb7-812" aria-hidden="true" tabindex="-1"></a>            .sort_index()</span>
<span id="cb7-813"><a href="#cb7-813" aria-hidden="true" tabindex="-1"></a>            .loc[:, [<span class="st">'start'</span>, <span class="st">'end'</span>]]</span>
<span id="cb7-814"><a href="#cb7-814" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Interval(<span class="op">*</span>x, closed<span class="op">=</span><span class="st">'both'</span>), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-815"><a href="#cb7-815" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-816"><a href="#cb7-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-817"><a href="#cb7-817" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract ground-truth events.</span></span>
<span id="cb7-818"><a href="#cb7-818" aria-hidden="true" tabindex="-1"></a>    ground_truths <span class="op">=</span> (</span>
<span id="cb7-819"><a href="#cb7-819" aria-hidden="true" tabindex="-1"></a>        solution</span>
<span id="cb7-820"><a href="#cb7-820" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"event not in ['start', 'end']"</span>)</span>
<span id="cb7-821"><a href="#cb7-821" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-822"><a href="#cb7-822" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-823"><a href="#cb7-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-824"><a href="#cb7-824" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map each event class to its prevalence (needed for recall calculation)</span></span>
<span id="cb7-825"><a href="#cb7-825" aria-hidden="true" tabindex="-1"></a>    class_counts <span class="op">=</span> ground_truths.value_counts(event_column_name).to_dict()</span>
<span id="cb7-826"><a href="#cb7-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-827"><a href="#cb7-827" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table for detections with a column indicating a match to a ground-truth event</span></span>
<span id="cb7-828"><a href="#cb7-828" aria-hidden="true" tabindex="-1"></a>    detections <span class="op">=</span> submission.assign(matched <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb7-829"><a href="#cb7-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-830"><a href="#cb7-830" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove detections outside of scoring intervals</span></span>
<span id="cb7-831"><a href="#cb7-831" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use_scoring_intervals:</span>
<span id="cb7-832"><a href="#cb7-832" aria-hidden="true" tabindex="-1"></a>        detections_filtered <span class="op">=</span> []</span>
<span id="cb7-833"><a href="#cb7-833" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (det_group, dets), (int_group, ints) <span class="kw">in</span> <span class="bu">zip</span>(</span>
<span id="cb7-834"><a href="#cb7-834" aria-hidden="true" tabindex="-1"></a>            detections.groupby(series_id_column_name), intervals.groupby(series_id_column_name)</span>
<span id="cb7-835"><a href="#cb7-835" aria-hidden="true" tabindex="-1"></a>        ):</span>
<span id="cb7-836"><a href="#cb7-836" aria-hidden="true" tabindex="-1"></a>            <span class="cf">assert</span> det_group <span class="op">==</span> int_group</span>
<span id="cb7-837"><a href="#cb7-837" aria-hidden="true" tabindex="-1"></a>            detections_filtered.append(filter_detections(dets, ints))</span>
<span id="cb7-838"><a href="#cb7-838" aria-hidden="true" tabindex="-1"></a>        detections_filtered <span class="op">=</span> pd.concat(detections_filtered, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-839"><a href="#cb7-839" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-840"><a href="#cb7-840" aria-hidden="true" tabindex="-1"></a>        detections_filtered <span class="op">=</span> detections</span>
<span id="cb7-841"><a href="#cb7-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-842"><a href="#cb7-842" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create table of event-class x tolerance x series_id values</span></span>
<span id="cb7-843"><a href="#cb7-843" aria-hidden="true" tabindex="-1"></a>    aggregation_keys <span class="op">=</span> pd.DataFrame(</span>
<span id="cb7-844"><a href="#cb7-844" aria-hidden="true" tabindex="-1"></a>        [(ev, tol, vid)</span>
<span id="cb7-845"><a href="#cb7-845" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> ev <span class="kw">in</span> tolerances.keys()</span>
<span id="cb7-846"><a href="#cb7-846" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> tol <span class="kw">in</span> tolerances[ev]</span>
<span id="cb7-847"><a href="#cb7-847" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> vid <span class="kw">in</span> ground_truths[series_id_column_name].unique()],</span>
<span id="cb7-848"><a href="#cb7-848" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[event_column_name, <span class="st">'tolerance'</span>, series_id_column_name],</span>
<span id="cb7-849"><a href="#cb7-849" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-850"><a href="#cb7-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-851"><a href="#cb7-851" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create match evaluation groups: event-class x tolerance x series_id</span></span>
<span id="cb7-852"><a href="#cb7-852" aria-hidden="true" tabindex="-1"></a>    detections_grouped <span class="op">=</span> (</span>
<span id="cb7-853"><a href="#cb7-853" aria-hidden="true" tabindex="-1"></a>        aggregation_keys</span>
<span id="cb7-854"><a href="#cb7-854" aria-hidden="true" tabindex="-1"></a>        .merge(detections_filtered, on<span class="op">=</span>[event_column_name, series_id_column_name], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb7-855"><a href="#cb7-855" aria-hidden="true" tabindex="-1"></a>        .groupby([event_column_name, <span class="st">'tolerance'</span>, series_id_column_name])</span>
<span id="cb7-856"><a href="#cb7-856" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-857"><a href="#cb7-857" aria-hidden="true" tabindex="-1"></a>    ground_truths_grouped <span class="op">=</span> (</span>
<span id="cb7-858"><a href="#cb7-858" aria-hidden="true" tabindex="-1"></a>        aggregation_keys</span>
<span id="cb7-859"><a href="#cb7-859" aria-hidden="true" tabindex="-1"></a>        .merge(ground_truths, on<span class="op">=</span>[event_column_name, series_id_column_name], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb7-860"><a href="#cb7-860" aria-hidden="true" tabindex="-1"></a>        .groupby([event_column_name, <span class="st">'tolerance'</span>, series_id_column_name])</span>
<span id="cb7-861"><a href="#cb7-861" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-862"><a href="#cb7-862" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match detections to ground truth events by evaluation group</span></span>
<span id="cb7-863"><a href="#cb7-863" aria-hidden="true" tabindex="-1"></a>    detections_matched <span class="op">=</span> []</span>
<span id="cb7-864"><a href="#cb7-864" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> key <span class="kw">in</span> aggregation_keys.itertuples(index<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb7-865"><a href="#cb7-865" aria-hidden="true" tabindex="-1"></a>        dets <span class="op">=</span> detections_grouped.get_group(key)</span>
<span id="cb7-866"><a href="#cb7-866" aria-hidden="true" tabindex="-1"></a>        gts <span class="op">=</span> ground_truths_grouped.get_group(key)</span>
<span id="cb7-867"><a href="#cb7-867" aria-hidden="true" tabindex="-1"></a>        detections_matched.append(</span>
<span id="cb7-868"><a href="#cb7-868" aria-hidden="true" tabindex="-1"></a>            match_detections(dets[<span class="st">'tolerance'</span>].iloc[<span class="dv">0</span>], gts, dets)</span>
<span id="cb7-869"><a href="#cb7-869" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-870"><a href="#cb7-870" aria-hidden="true" tabindex="-1"></a>    detections_matched <span class="op">=</span> pd.concat(detections_matched)</span>
<span id="cb7-871"><a href="#cb7-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-872"><a href="#cb7-872" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute AP per event x tolerance group</span></span>
<span id="cb7-873"><a href="#cb7-873" aria-hidden="true" tabindex="-1"></a>    event_classes <span class="op">=</span> ground_truths[event_column_name].unique()</span>
<span id="cb7-874"><a href="#cb7-874" aria-hidden="true" tabindex="-1"></a>    ap_table <span class="op">=</span> (</span>
<span id="cb7-875"><a href="#cb7-875" aria-hidden="true" tabindex="-1"></a>        detections_matched</span>
<span id="cb7-876"><a href="#cb7-876" aria-hidden="true" tabindex="-1"></a>        .query(<span class="st">"event in @event_classes"</span>)</span>
<span id="cb7-877"><a href="#cb7-877" aria-hidden="true" tabindex="-1"></a>        .groupby([event_column_name, <span class="st">'tolerance'</span>]).<span class="bu">apply</span>(</span>
<span id="cb7-878"><a href="#cb7-878" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> group: average_precision_score(</span>
<span id="cb7-879"><a href="#cb7-879" aria-hidden="true" tabindex="-1"></a>                group[<span class="st">'matched'</span>].to_numpy(),</span>
<span id="cb7-880"><a href="#cb7-880" aria-hidden="true" tabindex="-1"></a>                group[score_column_name].to_numpy(),</span>
<span id="cb7-881"><a href="#cb7-881" aria-hidden="true" tabindex="-1"></a>                class_counts[group[event_column_name].iat[<span class="dv">0</span>]],</span>
<span id="cb7-882"><a href="#cb7-882" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-883"><a href="#cb7-883" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-884"><a href="#cb7-884" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-885"><a href="#cb7-885" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average over tolerances, then over event classes</span></span>
<span id="cb7-886"><a href="#cb7-886" aria-hidden="true" tabindex="-1"></a>    mean_ap <span class="op">=</span> ap_table.groupby(event_column_name).mean().<span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(event_classes)</span>
<span id="cb7-887"><a href="#cb7-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-888"><a href="#cb7-888" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_ap</span>
<span id="cb7-889"><a href="#cb7-889" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np </span>
<span id="cb7-890"><a href="#cb7-890" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-891"><a href="#cb7-891" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb7-892"><a href="#cb7-892" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb7-893"><a href="#cb7-893" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime </span>
<span id="cb7-894"><a href="#cb7-894" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb7-895"><a href="#cb7-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-896"><a href="#cb7-896" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb7-897"><a href="#cb7-897" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb7-898"><a href="#cb7-898" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb7-899"><a href="#cb7-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-900"><a href="#cb7-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-901"><a href="#cb7-901" aria-hidden="true" tabindex="-1"></a>tolerances <span class="op">=</span> {</span>
<span id="cb7-902"><a href="#cb7-902" aria-hidden="true" tabindex="-1"></a>    <span class="st">"onset"</span> : [<span class="dv">12</span>, <span class="dv">36</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>],</span>
<span id="cb7-903"><a href="#cb7-903" aria-hidden="true" tabindex="-1"></a>    <span class="st">'wakeup'</span>: [<span class="dv">12</span>, <span class="dv">36</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">120</span>, <span class="dv">150</span>, <span class="dv">180</span>, <span class="dv">240</span>, <span class="dv">300</span>, <span class="dv">360</span>]    </span>
<span id="cb7-904"><a href="#cb7-904" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-905"><a href="#cb7-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-906"><a href="#cb7-906" aria-hidden="true" tabindex="-1"></a>column_names <span class="op">=</span> {</span>
<span id="cb7-907"><a href="#cb7-907" aria-hidden="true" tabindex="-1"></a>    <span class="st">'series_id_column_name'</span>: <span class="st">'series_id'</span>,</span>
<span id="cb7-908"><a href="#cb7-908" aria-hidden="true" tabindex="-1"></a>    <span class="st">'time_column_name'</span>: <span class="st">'step'</span>,</span>
<span id="cb7-909"><a href="#cb7-909" aria-hidden="true" tabindex="-1"></a>    <span class="st">'event_column_name'</span>: <span class="st">'event'</span>,</span>
<span id="cb7-910"><a href="#cb7-910" aria-hidden="true" tabindex="-1"></a>    <span class="st">'score_column_name'</span>: <span class="st">'score'</span>,</span>
<span id="cb7-911"><a href="#cb7-911" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-912"><a href="#cb7-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-913"><a href="#cb7-913" aria-hidden="true" tabindex="-1"></a><span class="co">#import data</span></span>
<span id="cb7-914"><a href="#cb7-914" aria-hidden="true" tabindex="-1"></a>dt_transforms <span class="op">=</span> [</span>
<span id="cb7-915"><a href="#cb7-915" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'timestamp'</span>).<span class="bu">str</span>.to_datetime(), </span>
<span id="cb7-916"><a href="#cb7-916" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">'timestamp'</span>).<span class="bu">str</span>.to_datetime().dt.year()<span class="op">-</span><span class="dv">2000</span>).cast(pl.UInt8).alias(<span class="st">'year'</span>), </span>
<span id="cb7-917"><a href="#cb7-917" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'timestamp'</span>).<span class="bu">str</span>.to_datetime().dt.month().cast(pl.UInt8).alias(<span class="st">'month'</span>),</span>
<span id="cb7-918"><a href="#cb7-918" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'timestamp'</span>).<span class="bu">str</span>.to_datetime().dt.day().cast(pl.UInt8).alias(<span class="st">'day'</span>), </span>
<span id="cb7-919"><a href="#cb7-919" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'timestamp'</span>).<span class="bu">str</span>.to_datetime().dt.hour().cast(pl.UInt8).alias(<span class="st">'hour'</span>)</span>
<span id="cb7-920"><a href="#cb7-920" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-921"><a href="#cb7-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-922"><a href="#cb7-922" aria-hidden="true" tabindex="-1"></a>data_transforms <span class="op">=</span> [</span>
<span id="cb7-923"><a href="#cb7-923" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">'anglez'</span>).cast(pl.Int16), <span class="co"># Casting anglez to 16 bit integer</span></span>
<span id="cb7-924"><a href="#cb7-924" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">'enmo'</span>)<span class="op">*</span><span class="dv">1000</span>).cast(pl.UInt16), <span class="co"># Convert enmo to 16 bit uint</span></span>
<span id="cb7-925"><a href="#cb7-925" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-926"><a href="#cb7-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-927"><a href="#cb7-927" aria-hidden="true" tabindex="-1"></a>train_series <span class="op">=</span> pl.scan_parquet(<span class="st">'train_series.parquet'</span>).with_columns(</span>
<span id="cb7-928"><a href="#cb7-928" aria-hidden="true" tabindex="-1"></a>    dt_transforms <span class="op">+</span> data_transforms</span>
<span id="cb7-929"><a href="#cb7-929" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-930"><a href="#cb7-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-931"><a href="#cb7-931" aria-hidden="true" tabindex="-1"></a>train_events <span class="op">=</span> pl.read_csv(<span class="st">'train_events.csv'</span>).with_columns(</span>
<span id="cb7-932"><a href="#cb7-932" aria-hidden="true" tabindex="-1"></a>    dt_transforms</span>
<span id="cb7-933"><a href="#cb7-933" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-934"><a href="#cb7-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-935"><a href="#cb7-935" aria-hidden="true" tabindex="-1"></a>test_series <span class="op">=</span> pl.scan_parquet(<span class="st">'test_series.parquet'</span>).with_columns(</span>
<span id="cb7-936"><a href="#cb7-936" aria-hidden="true" tabindex="-1"></a>    dt_transforms <span class="op">+</span> data_transforms</span>
<span id="cb7-937"><a href="#cb7-937" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-938"><a href="#cb7-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-939"><a href="#cb7-939" aria-hidden="true" tabindex="-1"></a><span class="co"># Getting series ids as a list for convenience</span></span>
<span id="cb7-940"><a href="#cb7-940" aria-hidden="true" tabindex="-1"></a>series_ids <span class="op">=</span> train_events[<span class="st">'series_id'</span>].unique(maintain_order<span class="op">=</span><span class="va">True</span>).to_list()</span>
<span id="cb7-941"><a href="#cb7-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-942"><a href="#cb7-942" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing series with mismatched counts: </span></span>
<span id="cb7-943"><a href="#cb7-943" aria-hidden="true" tabindex="-1"></a>onset_counts <span class="op">=</span> train_events.<span class="bu">filter</span>(pl.col(<span class="st">'event'</span>)<span class="op">==</span><span class="st">'onset'</span>).group_by(<span class="st">'series_id'</span>).count().sort(<span class="st">'series_id'</span>)[<span class="st">'count'</span>]</span>
<span id="cb7-944"><a href="#cb7-944" aria-hidden="true" tabindex="-1"></a>wakeup_counts <span class="op">=</span> train_events.<span class="bu">filter</span>(pl.col(<span class="st">'event'</span>)<span class="op">==</span><span class="st">'wakeup'</span>).group_by(<span class="st">'series_id'</span>).count().sort(<span class="st">'series_id'</span>)[<span class="st">'count'</span>]</span>
<span id="cb7-945"><a href="#cb7-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-946"><a href="#cb7-946" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> pl.DataFrame({<span class="st">'series_id'</span>:<span class="bu">sorted</span>(series_ids), <span class="st">'onset_counts'</span>:onset_counts, <span class="st">'wakeup_counts'</span>:wakeup_counts})</span>
<span id="cb7-947"><a href="#cb7-947" aria-hidden="true" tabindex="-1"></a>count_mismatches <span class="op">=</span> counts.<span class="bu">filter</span>(counts[<span class="st">'onset_counts'</span>] <span class="op">!=</span> counts[<span class="st">'wakeup_counts'</span>])</span>
<span id="cb7-948"><a href="#cb7-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-949"><a href="#cb7-949" aria-hidden="true" tabindex="-1"></a>train_series <span class="op">=</span> train_series.<span class="bu">filter</span>(<span class="op">~</span>pl.col(<span class="st">'series_id'</span>).is_in(count_mismatches[<span class="st">'series_id'</span>]))</span>
<span id="cb7-950"><a href="#cb7-950" aria-hidden="true" tabindex="-1"></a>train_events <span class="op">=</span> train_events.<span class="bu">filter</span>(<span class="op">~</span>pl.col(<span class="st">'series_id'</span>).is_in(count_mismatches[<span class="st">'series_id'</span>]))</span>
<span id="cb7-951"><a href="#cb7-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-952"><a href="#cb7-952" aria-hidden="true" tabindex="-1"></a><span class="co"># Updating list of series ids, not including series with no non-null values.</span></span>
<span id="cb7-953"><a href="#cb7-953" aria-hidden="true" tabindex="-1"></a>series_ids <span class="op">=</span> train_events.drop_nulls()[<span class="st">'series_id'</span>].unique(maintain_order<span class="op">=</span><span class="va">True</span>).to_list()</span>
<span id="cb7-954"><a href="#cb7-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-955"><a href="#cb7-955" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Engineering start from here</span></span>
<span id="cb7-956"><a href="#cb7-956" aria-hidden="true" tabindex="-1"></a>features, feature_cols <span class="op">=</span> [pl.col(<span class="st">'hour'</span>)], [<span class="st">'hour'</span>]</span>
<span id="cb7-957"><a href="#cb7-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-958"><a href="#cb7-958" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mins <span class="kw">in</span> [<span class="dv">5</span>, <span class="dv">30</span>, <span class="dv">60</span><span class="op">*</span><span class="dv">2</span>, <span class="dv">60</span><span class="op">*</span><span class="dv">8</span>] :</span>
<span id="cb7-959"><a href="#cb7-959" aria-hidden="true" tabindex="-1"></a>    features <span class="op">+=</span> [</span>
<span id="cb7-960"><a href="#cb7-960" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">'enmo'</span>).rolling_mean(<span class="dv">12</span> <span class="op">*</span> mins, center<span class="op">=</span><span class="va">True</span>, min_periods<span class="op">=</span><span class="dv">1</span>).<span class="bu">abs</span>().cast(pl.UInt16).alias(<span class="ss">f'enmo_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_mean'</span>),</span>
<span id="cb7-961"><a href="#cb7-961" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">'enmo'</span>).rolling_max(<span class="dv">12</span> <span class="op">*</span> mins, center<span class="op">=</span><span class="va">True</span>, min_periods<span class="op">=</span><span class="dv">1</span>).<span class="bu">abs</span>().cast(pl.UInt16).alias(<span class="ss">f'enmo_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_max'</span>)</span>
<span id="cb7-962"><a href="#cb7-962" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-963"><a href="#cb7-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-964"><a href="#cb7-964" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">+=</span> [ </span>
<span id="cb7-965"><a href="#cb7-965" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f'enmo_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_mean'</span>, <span class="ss">f'enmo_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_max'</span></span>
<span id="cb7-966"><a href="#cb7-966" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-967"><a href="#cb7-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-968"><a href="#cb7-968" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Getting first variations</span></span>
<span id="cb7-969"><a href="#cb7-969" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">'enmo'</span>, <span class="st">'anglez'</span>] :</span>
<span id="cb7-970"><a href="#cb7-970" aria-hidden="true" tabindex="-1"></a>        features <span class="op">+=</span> [</span>
<span id="cb7-971"><a href="#cb7-971" aria-hidden="true" tabindex="-1"></a>            (pl.col(var).diff().<span class="bu">abs</span>().rolling_mean(<span class="dv">12</span> <span class="op">*</span> mins, center<span class="op">=</span><span class="va">True</span>, min_periods<span class="op">=</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">10</span>).<span class="bu">abs</span>().cast(pl.UInt32).alias(<span class="ss">f'</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_1v_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_mean'</span>),</span>
<span id="cb7-972"><a href="#cb7-972" aria-hidden="true" tabindex="-1"></a>            (pl.col(var).diff().<span class="bu">abs</span>().rolling_max(<span class="dv">12</span> <span class="op">*</span> mins, center<span class="op">=</span><span class="va">True</span>, min_periods<span class="op">=</span><span class="dv">1</span>)<span class="op">*</span><span class="dv">10</span>).<span class="bu">abs</span>().cast(pl.UInt32).alias(<span class="ss">f'</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_1v_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_max'</span>)</span>
<span id="cb7-973"><a href="#cb7-973" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb7-974"><a href="#cb7-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-975"><a href="#cb7-975" aria-hidden="true" tabindex="-1"></a>        feature_cols <span class="op">+=</span> [ </span>
<span id="cb7-976"><a href="#cb7-976" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f'</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_1v_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_mean'</span>, <span class="ss">f'</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_1v_</span><span class="sc">{</span>mins<span class="sc">}</span><span class="ss">m_max'</span></span>
<span id="cb7-977"><a href="#cb7-977" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb7-978"><a href="#cb7-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-979"><a href="#cb7-979" aria-hidden="true" tabindex="-1"></a>id_cols <span class="op">=</span> [<span class="st">'series_id'</span>, <span class="st">'step'</span>, <span class="st">'timestamp'</span>]</span>
<span id="cb7-980"><a href="#cb7-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-981"><a href="#cb7-981" aria-hidden="true" tabindex="-1"></a>train_series <span class="op">=</span> train_series.with_columns(</span>
<span id="cb7-982"><a href="#cb7-982" aria-hidden="true" tabindex="-1"></a>    features</span>
<span id="cb7-983"><a href="#cb7-983" aria-hidden="true" tabindex="-1"></a>).select(id_cols <span class="op">+</span> feature_cols)</span>
<span id="cb7-984"><a href="#cb7-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-985"><a href="#cb7-985" aria-hidden="true" tabindex="-1"></a>test_series <span class="op">=</span> test_series.with_columns(</span>
<span id="cb7-986"><a href="#cb7-986" aria-hidden="true" tabindex="-1"></a>    features</span>
<span id="cb7-987"><a href="#cb7-987" aria-hidden="true" tabindex="-1"></a>).select(id_cols <span class="op">+</span> feature_cols)</span>
<span id="cb7-988"><a href="#cb7-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-989"><a href="#cb7-989" aria-hidden="true" tabindex="-1"></a><span class="co"># train dataset preparation method</span></span>
<span id="cb7-990"><a href="#cb7-990" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_train_dataset(train_data, train_events, drop_nulls<span class="op">=</span><span class="va">False</span>) :</span>
<span id="cb7-991"><a href="#cb7-991" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-992"><a href="#cb7-992" aria-hidden="true" tabindex="-1"></a>    series_ids <span class="op">=</span> train_data[<span class="st">'series_id'</span>].unique(maintain_order<span class="op">=</span><span class="va">True</span>).to_list()</span>
<span id="cb7-993"><a href="#cb7-993" aria-hidden="true" tabindex="-1"></a>    X, y <span class="op">=</span> pl.DataFrame(), pl.DataFrame()</span>
<span id="cb7-994"><a href="#cb7-994" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> tqdm(series_ids) : </span>
<span id="cb7-995"><a href="#cb7-995" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-996"><a href="#cb7-996" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Normalizing sample features</span></span>
<span id="cb7-997"><a href="#cb7-997" aria-hidden="true" tabindex="-1"></a>        sample <span class="op">=</span> train_data.<span class="bu">filter</span>(pl.col(<span class="st">'series_id'</span>)<span class="op">==</span>idx).with_columns(</span>
<span id="cb7-998"><a href="#cb7-998" aria-hidden="true" tabindex="-1"></a>            [(pl.col(col) <span class="op">/</span> pl.col(col).std()).cast(pl.Float32) <span class="cf">for</span> col <span class="kw">in</span> feature_cols <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'hour'</span>]</span>
<span id="cb7-999"><a href="#cb7-999" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-1000"><a href="#cb7-1000" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-1001"><a href="#cb7-1001" aria-hidden="true" tabindex="-1"></a>        events <span class="op">=</span> train_events.<span class="bu">filter</span>(pl.col(<span class="st">'series_id'</span>)<span class="op">==</span>idx)</span>
<span id="cb7-1002"><a href="#cb7-1002" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-1003"><a href="#cb7-1003" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> drop_nulls : </span>
<span id="cb7-1004"><a href="#cb7-1004" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Removing datapoints on dates where no data was recorded</span></span>
<span id="cb7-1005"><a href="#cb7-1005" aria-hidden="true" tabindex="-1"></a>            sample <span class="op">=</span> sample.<span class="bu">filter</span>(</span>
<span id="cb7-1006"><a href="#cb7-1006" aria-hidden="true" tabindex="-1"></a>                pl.col(<span class="st">'timestamp'</span>).dt.date().is_in(events[<span class="st">'timestamp'</span>].dt.date())</span>
<span id="cb7-1007"><a href="#cb7-1007" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-1008"><a href="#cb7-1008" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-1009"><a href="#cb7-1009" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> X.vstack(sample[id_cols <span class="op">+</span> feature_cols])</span>
<span id="cb7-1010"><a href="#cb7-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1011"><a href="#cb7-1011" aria-hidden="true" tabindex="-1"></a>        onsets <span class="op">=</span> events.<span class="bu">filter</span>((pl.col(<span class="st">'event'</span>) <span class="op">==</span> <span class="st">'onset'</span>) <span class="op">&amp;</span> (pl.col(<span class="st">'step'</span>) <span class="op">!=</span> <span class="va">None</span>))[<span class="st">'step'</span>].to_list()</span>
<span id="cb7-1012"><a href="#cb7-1012" aria-hidden="true" tabindex="-1"></a>        wakeups <span class="op">=</span> events.<span class="bu">filter</span>((pl.col(<span class="st">'event'</span>) <span class="op">==</span> <span class="st">'wakeup'</span>) <span class="op">&amp;</span> (pl.col(<span class="st">'step'</span>) <span class="op">!=</span> <span class="va">None</span>))[<span class="st">'step'</span>].to_list()</span>
<span id="cb7-1013"><a href="#cb7-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1014"><a href="#cb7-1014" aria-hidden="true" tabindex="-1"></a>        <span class="co"># </span><span class="al">NOTE</span><span class="co">: This will break if there are event series without any recorded onsets or wakeups</span></span>
<span id="cb7-1015"><a href="#cb7-1015" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> y.vstack(sample.with_columns(</span>
<span id="cb7-1016"><a href="#cb7-1016" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>([(onset <span class="op">&lt;=</span> pl.col(<span class="st">'step'</span>)) <span class="op">&amp;</span> (pl.col(<span class="st">'step'</span>) <span class="op">&lt;=</span> wakeup) <span class="cf">for</span> onset, wakeup <span class="kw">in</span> <span class="bu">zip</span>(onsets, wakeups)]).cast(pl.Boolean).alias(<span class="st">'asleep'</span>)</span>
<span id="cb7-1017"><a href="#cb7-1017" aria-hidden="true" tabindex="-1"></a>            ).select(<span class="st">'asleep'</span>)</span>
<span id="cb7-1018"><a href="#cb7-1018" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-1019"><a href="#cb7-1019" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1020"><a href="#cb7-1020" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> y.to_numpy().ravel()</span>
<span id="cb7-1021"><a href="#cb7-1021" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1022"><a href="#cb7-1022" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, y</span>
<span id="cb7-1023"><a href="#cb7-1023" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1024"><a href="#cb7-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1025"><a href="#cb7-1025" aria-hidden="true" tabindex="-1"></a><span class="co"># apply classifier to get event method</span></span>
<span id="cb7-1026"><a href="#cb7-1026" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_events(series, classifier) :</span>
<span id="cb7-1027"><a href="#cb7-1027" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb7-1028"><a href="#cb7-1028" aria-hidden="true" tabindex="-1"></a><span class="co">    Takes a time series and a classifier and returns a formatted submission dataframe.</span></span>
<span id="cb7-1029"><a href="#cb7-1029" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb7-1030"><a href="#cb7-1030" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1031"><a href="#cb7-1031" aria-hidden="true" tabindex="-1"></a>    series_ids <span class="op">=</span> series[<span class="st">'series_id'</span>].unique(maintain_order<span class="op">=</span><span class="va">True</span>).to_list()</span>
<span id="cb7-1032"><a href="#cb7-1032" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> pl.DataFrame(schema<span class="op">=</span>{<span class="st">'series_id'</span>:<span class="bu">str</span>, <span class="st">'step'</span>:<span class="bu">int</span>, <span class="st">'event'</span>:<span class="bu">str</span>, <span class="st">'score'</span>:<span class="bu">float</span>})</span>
<span id="cb7-1033"><a href="#cb7-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1034"><a href="#cb7-1034" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> tqdm(series_ids) : </span>
<span id="cb7-1035"><a href="#cb7-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1036"><a href="#cb7-1036" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Collecting sample and normalizing features</span></span>
<span id="cb7-1037"><a href="#cb7-1037" aria-hidden="true" tabindex="-1"></a>        scale_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> feature_cols <span class="cf">if</span> (col <span class="op">!=</span> <span class="st">'hour'</span>) <span class="op">&amp;</span> (series[col].std() <span class="op">!=</span><span class="dv">0</span>)]</span>
<span id="cb7-1038"><a href="#cb7-1038" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> series.<span class="bu">filter</span>(pl.col(<span class="st">'series_id'</span>) <span class="op">==</span> idx).select(id_cols <span class="op">+</span> feature_cols).with_columns(</span>
<span id="cb7-1039"><a href="#cb7-1039" aria-hidden="true" tabindex="-1"></a>            [(pl.col(col) <span class="op">/</span> series[col].std()).cast(pl.Float32) <span class="cf">for</span> col <span class="kw">in</span> scale_cols]</span>
<span id="cb7-1040"><a href="#cb7-1040" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-1041"><a href="#cb7-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1042"><a href="#cb7-1042" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Applying classifier to get predictions and scores</span></span>
<span id="cb7-1043"><a href="#cb7-1043" aria-hidden="true" tabindex="-1"></a>        preds, probs <span class="op">=</span> classifier.predict(X[feature_cols]), classifier.predict_proba(X[feature_cols])[:, <span class="dv">1</span>]</span>
<span id="cb7-1044"><a href="#cb7-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1045"><a href="#cb7-1045" aria-hidden="true" tabindex="-1"></a>        <span class="co">#NOTE: Considered using rolling max to get sleep periods excluding &lt;30 min interruptions, but ended up decreasing performance</span></span>
<span id="cb7-1046"><a href="#cb7-1046" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> X.with_columns(</span>
<span id="cb7-1047"><a href="#cb7-1047" aria-hidden="true" tabindex="-1"></a>            pl.lit(preds).cast(pl.Int8).alias(<span class="st">'prediction'</span>), </span>
<span id="cb7-1048"><a href="#cb7-1048" aria-hidden="true" tabindex="-1"></a>            pl.lit(probs).alias(<span class="st">'probability'</span>)</span>
<span id="cb7-1049"><a href="#cb7-1049" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb7-1050"><a href="#cb7-1050" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-1051"><a href="#cb7-1051" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Getting predicted onset and wakeup time steps</span></span>
<span id="cb7-1052"><a href="#cb7-1052" aria-hidden="true" tabindex="-1"></a>        pred_onsets <span class="op">=</span> X.<span class="bu">filter</span>(X[<span class="st">'prediction'</span>].diff() <span class="op">&gt;</span> <span class="dv">0</span>)[<span class="st">'step'</span>].to_list()</span>
<span id="cb7-1053"><a href="#cb7-1053" aria-hidden="true" tabindex="-1"></a>        pred_wakeups <span class="op">=</span> X.<span class="bu">filter</span>(X[<span class="st">'prediction'</span>].diff() <span class="op">&lt;</span> <span class="dv">0</span>)[<span class="st">'step'</span>].to_list()</span>
<span id="cb7-1054"><a href="#cb7-1054" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-1055"><a href="#cb7-1055" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(pred_onsets) <span class="op">&gt;</span> <span class="dv">0</span> : </span>
<span id="cb7-1056"><a href="#cb7-1056" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-1057"><a href="#cb7-1057" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensuring all predicted sleep periods begin and end</span></span>
<span id="cb7-1058"><a href="#cb7-1058" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">min</span>(pred_wakeups) <span class="op">&lt;</span> <span class="bu">min</span>(pred_onsets) : </span>
<span id="cb7-1059"><a href="#cb7-1059" aria-hidden="true" tabindex="-1"></a>                pred_wakeups <span class="op">=</span> pred_wakeups[<span class="dv">1</span>:]</span>
<span id="cb7-1060"><a href="#cb7-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1061"><a href="#cb7-1061" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">max</span>(pred_onsets) <span class="op">&gt;</span> <span class="bu">max</span>(pred_wakeups) :</span>
<span id="cb7-1062"><a href="#cb7-1062" aria-hidden="true" tabindex="-1"></a>                pred_onsets <span class="op">=</span> pred_onsets[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb7-1063"><a href="#cb7-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1064"><a href="#cb7-1064" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Keeping sleep periods longer than 30 minutes</span></span>
<span id="cb7-1065"><a href="#cb7-1065" aria-hidden="true" tabindex="-1"></a>            sleep_periods <span class="op">=</span> [(onset, wakeup) <span class="cf">for</span> onset, wakeup <span class="kw">in</span> <span class="bu">zip</span>(pred_onsets, pred_wakeups) <span class="cf">if</span> wakeup <span class="op">-</span> onset <span class="op">&gt;=</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">30</span>]</span>
<span id="cb7-1066"><a href="#cb7-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1067"><a href="#cb7-1067" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> onset, wakeup <span class="kw">in</span> sleep_periods :</span>
<span id="cb7-1068"><a href="#cb7-1068" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Scoring using mean probability over period</span></span>
<span id="cb7-1069"><a href="#cb7-1069" aria-hidden="true" tabindex="-1"></a>                score <span class="op">=</span> X.<span class="bu">filter</span>((pl.col(<span class="st">'step'</span>) <span class="op">&gt;=</span> onset) <span class="op">&amp;</span> (pl.col(<span class="st">'step'</span>) <span class="op">&lt;=</span> wakeup))[<span class="st">'probability'</span>].mean()</span>
<span id="cb7-1070"><a href="#cb7-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1071"><a href="#cb7-1071" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Adding sleep event to dataframe</span></span>
<span id="cb7-1072"><a href="#cb7-1072" aria-hidden="true" tabindex="-1"></a>                events <span class="op">=</span> events.vstack(pl.DataFrame().with_columns(</span>
<span id="cb7-1073"><a href="#cb7-1073" aria-hidden="true" tabindex="-1"></a>                    pl.Series([idx, idx]).alias(<span class="st">'series_id'</span>), </span>
<span id="cb7-1074"><a href="#cb7-1074" aria-hidden="true" tabindex="-1"></a>                    pl.Series([onset, wakeup]).alias(<span class="st">'step'</span>),</span>
<span id="cb7-1075"><a href="#cb7-1075" aria-hidden="true" tabindex="-1"></a>                    pl.Series([<span class="st">'onset'</span>, <span class="st">'wakeup'</span>]).alias(<span class="st">'event'</span>),</span>
<span id="cb7-1076"><a href="#cb7-1076" aria-hidden="true" tabindex="-1"></a>                    pl.Series([score, score]).alias(<span class="st">'score'</span>)</span>
<span id="cb7-1077"><a href="#cb7-1077" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb7-1078"><a href="#cb7-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1079"><a href="#cb7-1079" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adding row id column</span></span>
<span id="cb7-1080"><a href="#cb7-1080" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> events.to_pandas().reset_index().rename(columns<span class="op">=</span>{<span class="st">'index'</span>:<span class="st">'row_id'</span>})</span>
<span id="cb7-1081"><a href="#cb7-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1082"><a href="#cb7-1082" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> events</span>
<span id="cb7-1083"><a href="#cb7-1083" aria-hidden="true" tabindex="-1"></a><span class="co"># extract from R processed testing_set and testing_pred_prob, then use ap score in python to calculate</span></span>
<span id="cb7-1084"><a href="#cb7-1084" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-1085"><a href="#cb7-1085" aria-hidden="true" tabindex="-1"></a>testing_set <span class="op">=</span> pd.read_csv(<span class="st">"testing_set.csv"</span>)</span>
<span id="cb7-1086"><a href="#cb7-1086" aria-hidden="true" tabindex="-1"></a>testing_set_probs <span class="op">=</span> pd.read_csv(<span class="st">"testing_set_probs.csv"</span>)</span>
<span id="cb7-1087"><a href="#cb7-1087" aria-hidden="true" tabindex="-1"></a>series_id_column_name <span class="op">=</span> <span class="st">'series_id'</span> </span>
<span id="cb7-1088"><a href="#cb7-1088" aria-hidden="true" tabindex="-1"></a>time_column_name <span class="op">=</span> <span class="st">'step'</span>         </span>
<span id="cb7-1089"><a href="#cb7-1089" aria-hidden="true" tabindex="-1"></a>event_column_name <span class="op">=</span> <span class="st">'awake'</span>         </span>
<span id="cb7-1090"><a href="#cb7-1090" aria-hidden="true" tabindex="-1"></a>score_column_name <span class="op">=</span> <span class="st">'score'</span></span>
<span id="cb7-1091"><a href="#cb7-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1092"><a href="#cb7-1092" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the solution DataFrame</span></span>
<span id="cb7-1093"><a href="#cb7-1093" aria-hidden="true" tabindex="-1"></a>solution <span class="op">=</span> testing_set[[series_id_column_name, time_column_name, event_column_name]]</span>
<span id="cb7-1094"><a href="#cb7-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1095"><a href="#cb7-1095" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert predicted probabilities to class labels using a threshold of 0.5</span></span>
<span id="cb7-1096"><a href="#cb7-1096" aria-hidden="true" tabindex="-1"></a><span class="co"># The probabilities for class "1" are in the second column of testing_set_probs</span></span>
<span id="cb7-1097"><a href="#cb7-1097" aria-hidden="true" tabindex="-1"></a>predicted_labels <span class="op">=</span> (testing_set_probs.iloc[:, <span class="dv">1</span>] <span class="op">&gt;</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb7-1098"><a href="#cb7-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1099"><a href="#cb7-1099" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the submission DataFrame</span></span>
<span id="cb7-1100"><a href="#cb7-1100" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> testing_set[[series_id_column_name, time_column_name, event_column_name]]</span>
<span id="cb7-1101"><a href="#cb7-1101" aria-hidden="true" tabindex="-1"></a>submission[<span class="st">'predicted_label'</span>] <span class="op">=</span> predicted_labels  <span class="co"># Add predicted labels</span></span>
<span id="cb7-1102"><a href="#cb7-1102" aria-hidden="true" tabindex="-1"></a>submission[<span class="st">'score'</span>] <span class="op">=</span> testing_set_probs.iloc[:, <span class="dv">1</span>] <span class="co"># Add the probabilities as confidence scores</span></span>
<span id="cb7-1103"><a href="#cb7-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1104"><a href="#cb7-1104" aria-hidden="true" tabindex="-1"></a><span class="co"># Handling scoring intervals if use_scoring_intervals is True</span></span>
<span id="cb7-1105"><a href="#cb7-1105" aria-hidden="true" tabindex="-1"></a>use_scoring_intervals <span class="op">=</span> <span class="va">False</span>  <span class="co"># Set to False if not using scoring intervals</span></span>
<span id="cb7-1106"><a href="#cb7-1106" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> use_scoring_intervals:</span>
<span id="cb7-1107"><a href="#cb7-1107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example: Assuming 'start_event' and 'end_event' columns in testing_set</span></span>
<span id="cb7-1108"><a href="#cb7-1108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These columns should represent the intervals for scoring</span></span>
<span id="cb7-1109"><a href="#cb7-1109" aria-hidden="true" tabindex="-1"></a>    solution[<span class="st">'start_event'</span>] <span class="op">=</span> testing_set[<span class="st">'start_event'</span>]</span>
<span id="cb7-1110"><a href="#cb7-1110" aria-hidden="true" tabindex="-1"></a>    solution[<span class="st">'end_event'</span>] <span class="op">=</span> testing_set[<span class="st">'end_event'</span>]</span>
<span id="cb7-1111"><a href="#cb7-1111" aria-hidden="true" tabindex="-1"></a>    submission[<span class="st">'start_event'</span>] <span class="op">=</span> testing_set[<span class="st">'start_event'</span>]</span>
<span id="cb7-1112"><a href="#cb7-1112" aria-hidden="true" tabindex="-1"></a>    submission[<span class="st">'end_event'</span>] <span class="op">=</span> testing_set[<span class="st">'end_event'</span>]</span>
<span id="cb7-1113"><a href="#cb7-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1114"><a href="#cb7-1114" aria-hidden="true" tabindex="-1"></a>solution <span class="op">=</span> solution.rename(columns<span class="op">=</span>{<span class="st">'awake'</span>: <span class="st">'event'</span>})</span>
<span id="cb7-1115"><a href="#cb7-1115" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> submission.rename(columns<span class="op">=</span>{<span class="st">'awake'</span>: <span class="st">'event'</span>})</span>
<span id="cb7-1116"><a href="#cb7-1116" aria-hidden="true" tabindex="-1"></a>solution[<span class="st">'event'</span>] <span class="op">=</span> solution[<span class="st">'event'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'onset'</span>, <span class="dv">1</span>: <span class="st">'wakeup'</span>})</span>
<span id="cb7-1117"><a href="#cb7-1117" aria-hidden="true" tabindex="-1"></a>submission[<span class="st">'event'</span>] <span class="op">=</span> submission[<span class="st">'event'</span>].<span class="bu">map</span>({<span class="dv">0</span>: <span class="st">'onset'</span>, <span class="dv">1</span>: <span class="st">'wakeup'</span>})</span>
<span id="cb7-1118"><a href="#cb7-1118" aria-hidden="true" tabindex="-1"></a>solution.to_csv(<span class="st">'testing_set_solution.csv'</span>,index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-1119"><a href="#cb7-1119" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">'testing_set_submission.csv'</span>,index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-1120"><a href="#cb7-1120" aria-hidden="true" tabindex="-1"></a>rf_ap_score <span class="op">=</span> score(solution, submission, tolerances, <span class="op">**</span>column_names)</span>
<span id="cb7-1121"><a href="#cb7-1121" aria-hidden="true" tabindex="-1"></a>plot2<span class="op">+</span> labs(caption <span class="op">=</span> <span class="st">"Figure5"</span>)<span class="op">+</span></span>
<span id="cb7-1122"><a href="#cb7-1122" aria-hidden="true" tabindex="-1"></a>                      theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-1123"><a href="#cb7-1123" aria-hidden="true" tabindex="-1"></a>plot4<span class="op">+</span> labs(caption <span class="op">=</span> <span class="st">"Figure6"</span>)<span class="op">+</span></span>
<span id="cb7-1124"><a href="#cb7-1124" aria-hidden="true" tabindex="-1"></a>                      theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-1125"><a href="#cb7-1125" aria-hidden="true" tabindex="-1"></a>plot(roc_obj, main<span class="op">=</span>paste(<span class="st">"ROC Curve, AUC ="</span>, <span class="bu">round</span>(auc_value, <span class="dv">6</span>)))</span>
<span id="cb7-1126"><a href="#cb7-1126" aria-hidden="true" tabindex="-1"></a>mtext(<span class="st">"Figure7"</span>, side <span class="op">=</span> <span class="dv">1</span>, line <span class="op">=</span> <span class="fl">4.15</span>, cex <span class="op">=</span> <span class="fl">0.8</span>)</span>
<span id="cb7-1127"><a href="#cb7-1127" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the Confusion Matrix</span></span>
<span id="cb7-1128"><a href="#cb7-1128" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(confusionMatrix)</span>
<span id="cb7-1129"><a href="#cb7-1129" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing the metrics</span></span>
<span id="cb7-1130"><a href="#cb7-1130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"Precision:"</span>, precision))</span>
<span id="cb7-1131"><a href="#cb7-1131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"Recall:"</span>, recall))</span>
<span id="cb7-1132"><a href="#cb7-1132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(paste(<span class="st">"F1 Score:"</span>, f1_score))</span>
<span id="cb7-1133"><a href="#cb7-1133" aria-hidden="true" tabindex="-1"></a>rf_feature_importance_plot<span class="op">+</span> labs(caption <span class="op">=</span> <span class="st">"Figure8"</span>)<span class="op">+</span></span>
<span id="cb7-1134"><a href="#cb7-1134" aria-hidden="true" tabindex="-1"></a>                      theme(plot.caption <span class="op">=</span> element_text(hjust <span class="op">=</span> <span class="fl">0.5</span>))</span>
<span id="cb7-1135"><a href="#cb7-1135" aria-hidden="true" tabindex="-1"></a>final_submission</span>
<span id="cb7-1136"><a href="#cb7-1136" aria-hidden="true" tabindex="-1"></a><span class="co">### An Optional Dive into GGIR Package</span></span>
<span id="cb7-1137"><a href="#cb7-1137" aria-hidden="true" tabindex="-1"></a>train_events <span class="op">&lt;-</span> read.csv(<span class="st">"train_events.csv"</span>)</span>
<span id="cb7-1138"><a href="#cb7-1138" aria-hidden="true" tabindex="-1"></a>train_series <span class="op">&lt;-</span> arrow::read_parquet(<span class="st">"Zzzs_train.parquet"</span>)</span>
<span id="cb7-1139"><a href="#cb7-1139" aria-hidden="true" tabindex="-1"></a>test_series <span class="op">&lt;-</span> arrow::read_parquet(<span class="st">"test_series.parquet"</span>)</span>
<span id="cb7-1140"><a href="#cb7-1140" aria-hidden="true" tabindex="-1"></a>write.csv(train_series, <span class="st">"Zzzs_train.csv"</span>, row.names <span class="op">=</span> FALSE)</span>
<span id="cb7-1141"><a href="#cb7-1141" aria-hidden="true" tabindex="-1"></a>write.csv(test_series,<span class="st">'test_series.csv'</span>, row.names <span class="op">=</span> FALSE)</span>
<span id="cb7-1142"><a href="#cb7-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1143"><a href="#cb7-1143" aria-hidden="true" tabindex="-1"></a>library(GGIR)</span>
<span id="cb7-1144"><a href="#cb7-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#g.shell.GGIR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>